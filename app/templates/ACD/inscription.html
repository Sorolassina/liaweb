{% extends "base.html" %}
{% set roles = roles or [] %}
{% block head_extra %}
<style>
  .board {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 18px;
  }
  @media (max-width: 992px){
    .board { grid-template-columns: 1fr; }
  }
  .card-neumo{
    background: var(--white-color);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 10%, transparent);
  }
  .pane-left {
    display: flex; flex-direction: column; gap: 12px;
    height: calc(100vh - 160px); /* entre header et footer */
    overflow: auto; padding: 10px;
  }
  .pane-right {
    display: flex; flex-direction: column; gap: 16px;
    min-height: calc(100vh - 160px);
    overflow: auto; padding-bottom: 8px;
  }
  .search-box { padding: 10px; }
  .pre-card{
    padding: 10px; border-radius: 12px; display:flex; gap:10px; align-items:center;
    border: 1px solid #eef1f5; cursor:pointer; transition: .15s;
  }
  .pre-card:hover{ background: #fafbfc; }
  .pre-card.active{ background: color-mix(in srgb, var(--primary-light) 25%, white); border-color: var(--primary-color); }
  .avatar{
    width:40px; height:40px; border-radius:10px; background:#f1f2f6 center/cover no-repeat;
    box-shadow: var(--shadow-sm);
  }
  .tag { font-size:.75rem; padding:.2rem .5rem; border-radius:999px; background:#f0f3f7; color:#445; }
  .kpi-row{ display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  @media (max-width:992px){ .kpi-row{ grid-template-columns: 1fr 1fr; } }
  .kpi-tile{
    padding:14px; border-radius:14px; text-align:center; border:1px solid #eef1f5;
  }
  .kpi-tile .value{ font-weight:900; font-size:1.6rem; color: var(--primary-dark); }
  .kpi-tile .label{ font-size:.8rem; color:#6b7280; text-transform:uppercase; letter-spacing:.3px; }

  /* Tabs pour le panneau de droite */
  .tab-head{
    display:flex; gap:8px; flex-wrap: wrap; padding:10px;
  }
  .tab-btn{
    border:0; background:#fff; padding:8px 12px; border-radius:10px;
    box-shadow: var(--shadow-sm); color:#333; font-weight:600; cursor:pointer;
  }
  .tab-btn.active{ background: var(--primary-color); color: var(--secondary-color); }
  .tab-pane{ display:none; }
  .tab-pane.active{ display:block; }

  .step{
    padding:12px; border-radius:12px; border:1px solid #eef1f5; display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .step .name{ font-weight:700; }
  .step .status-badge{
    padding:.25rem .6rem; border-radius:999px; font-size:.75rem; background:#eef2ff; color:#3730a3;
  }
  .btn { border-radius:10px; }
  .btn-outline{ border:1px solid #e5e7eb; background:#fff; }
  .btn-primary{ background: var(--primary-color); border: none; color: var(--secondary-color); }

  .elig-row{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  @media (max-width:768px){ .elig-row{ grid-template-columns: 1fr; } }
  .elig-card{ padding:12px; border-radius:12px; border:1px solid #eef1f5; }
  .ok{ color:#10b981; }
  .ko{ color:#ef4444; }
  .warn{ color:#f59e0b; }

  .form-inline-grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  @media (max-width:768px){ .form-inline-grid{ grid-template-columns:1fr; } }
  .form-label{ font-weight: 600; font-size:.9rem; }
  .form-control, .form-select { border-radius: 10px; }

  .jury-box{ display:grid; gap:12px; }
  
  /* Bandeau KPI fixe */
  .kpi-bandeau-fixe {
    position: fixed;
    top: 60px; /* Hauteur du header */
    left: var(--sidebar-width);
    right: 0;
    z-index: 1000;
    background: var(--white-color);
    border-bottom: 1px solid #eef1f5;
    box-shadow: var(--shadow-sm);
    transition: left 0.3s ease;
  }
  
  /* Quand le sidebar est réduit */
  .sidebar-collapsed .kpi-bandeau-fixe {
    left: var(--sidebar-width-collapsed);
  }
  
  /* Ajuster le contenu principal pour éviter le chevauchement */
  .content-with-fixed-kpi {
    margin-top: 160px; /* Hauteur du header + bandeau KPI + marge */
  }
  
  /* Responsive pour le bandeau fixe */
  @media (max-width: 768px) {
    .kpi-bandeau-fixe {
      left: 0; /* Sur mobile, pas de sidebar */
    }
    .content-with-fixed-kpi {
      margin-top: 180px; /* Plus d'espace sur mobile */
    }
  }
  
  /* Styles pour les boutons avec spinner */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .btn .fa-spinner {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<!-- ========== Bandeau KPI fixe tout en haut ========== -->

<div class="kpi-bandeau-fixe">
  <h5>{{ current_programme }}</h5>
  <div class="card-neumo p-3">
    <div class="kpi-row">
      <div class="kpi-tile">
        <div class="value">{{ kpi.total_pre }}</div>
        <div class="label">Préinscrits</div>
      </div>
      <div class="kpi-tile">
        <div class="value">{{ kpi.total_insc }}</div>
        <div class="label">Inscriptions</div>
      </div>
      <div class="kpi-tile">
        <div class="value">{{ kpi.taux_conv }}%</div>
        <div class="label">Conv. Pré → Inscription</div>
      </div>
      <div class="kpi-tile">
        <div class="value">{{ kpi.objectif_qpv_atteint }}%</div>
        <div class="label">Objectif QPV</div>
      </div>
    </div>
  </div>
</div>

<div class="content-with-fixed-kpi">
<div class="board">
  <!-- ========== Liste gauche ========== -->
  <div class="card-neumo">
    <div class="search-box">
      <form method="get" action="/ACD/inscriptions" class="d-flex gap-2">
        <input type="hidden" name="programme" value="{{ current_programme or 'ACD' }}">
        <input name="q" class="form-control" value="{{ q or '' }}" placeholder="Rechercher un préinscrit (nom, email)"/>
        <button class="btn btn-outline"><i class="fa fa-search"></i></button>
      </form>
    </div>
    <div class="p-2">
      {% for row in pre_rows %}
      {% set p, c, e, elig = row %}
        <a class="text-decoration-none d-block mb-2" href="/ACD/inscriptions/form?programme={{ current_programme }}&pre_id={{ p.id }}&t={{ timestamp }}">
        <div class="pre-card {% if selected and selected.id==p.id %}active{% endif %}">
          <div class="avatar" style="background-image:url('{% if c.photo_profil %}/media/{{ c.photo_profil.replace('\\', '/') }}{% else %}/static/images/utilisateur.png{% endif %}')"></div>
          <div class="flex-grow-1">
            <div class="fw-bold" style="color: black;">{{ c.prenom }} {{ c.nom }}</div>
            <div class="small text-muted">{{ c.email }}</div>
          </div>
          {% if c.statut %}
            {% if c.statut == "EN_ATTENTE" %}
              <span class="badge bg-warning text-dark">
                <i class="fas fa-clock"></i> En attente
              </span>
            {% elif c.statut == "VALIDE" %}
              <span class="badge bg-success">
                <i class="fas fa-check-circle"></i> Validé
              </span>
            {% elif c.statut == "REORIENTE" %}
              <span class="badge bg-info">
                <i class="fas fa-exchange-alt"></i> Réorienté
              </span>
            {% elif c.statut == "REJETE" %}
              <span class="badge bg-danger">
                <i class="fas fa-times-circle"></i> Rejeté
              </span>
          {% else %}
              <span class="badge bg-secondary">{{ c.statut }}</span>
            {% endif %}
          {% else %}
            <span class="badge bg-warning text-dark">
              <i class="fas fa-clock"></i> En attente
            </span>
          {% endif %}
        </div>
      </a>
      {% else %}
      <div class="p-3 text-muted">Aucun préinscrit.</div>
      {% endfor %}
    </div>
  </div>

  <!-- ========== Panneau droit ========== -->
  <div class="pane-right">
    {% if not selected %}
      <div class="card-neumo p-4 text-center text-muted">
        Sélectionnez un préinscrit dans la liste de gauche pour ouvrir le pipeline d'inscription.
      </div>
    {% else %}

    <div class="card-neumo">
      <div class="d-flex align-items-center justify-content-between p-3">
        <div>
          <div class="fw-bold fs-5">{{ cand.prenom }} {{ cand.nom }} — {{ programme.code }}</div>
          <div class="text-muted small">{{ cand.email }} · {{ cand.telephone or '—' }}</div>
        </div>
        <div class="d-flex gap-2">
          {% if not inscription %}
            <form method="post" action="/ACD/inscriptions/create-from-pre">
              <input type="hidden" name="pre_id" value="{{ selected.id }}">
              <button class="btn btn-primary"><i class="fa fa-user-plus me-1"></i>Démarrer l'inscription</button>
            </form>
          {% else %}
            <span class="tag">Inscription #{{ inscription.id }}</span>
          {% endif %}
          
          <!-- Boutons QPV et SIRET -->
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-info btn-sm" onclick="checkQPV({{ cand.id }})" title="Vérifier le statut QPV">
              <i class="fas fa-map-marker-alt"></i> QPV
            </button>
            <button type="button" class="btn btn-outline-success btn-sm" onclick="checkSIRET({{ cand.id }})" title="Vérifier les informations SIRET">
              <i class="fas fa-building"></i> SIRET
            </button>
          </div>
        </div>
      </div>

      <div class="tab-head">
        <button class="tab-btn active" data-tab="#tab-pipeline">Pipeline</button>
        <button class="tab-btn" data-tab="#tab-infos">Infos & mise à jour</button>
        <button class="tab-btn" data-tab="#tab-docs">Documentation</button>
        <button class="tab-btn" data-tab="#tab-elig">Éligibilité</button>
        <button class="tab-btn" data-tab="#tab-jury">Jury</button>
      </div>

      <div class="p-3">
        <!-- ========== Pipeline ========== -->
        <div id="tab-pipeline" class="tab-pane active">
          {% if not inscription %}
            <div class="text-muted">Créez l'inscription pour activer le pipeline.</div>
          {% else %}
            <div class="d-flex flex-column gap-2">
              {% for st in pipeline %}
              <div class="step">
                <div>
                  <div class="name">{{ st.etape.libelle }}</div>
                  <div class="small text-muted">Type : {{ st.etape.type_etape or '—' }} · Ordre {{ st.etape.ordre }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="status-badge">{{ st.statut.value.replace('_',' ').title() }}</span>
                  <form method="post" action="/ACD/inscriptions/etape/advance">
                    <input type="hidden" name="avancement_id" value="{{ st.id }}">
                    <select name="statut" class="form-select form-select-sm">
                      <option value="A_FAIRE" {% if st.statut.name=='A_FAIRE' %}selected{% endif %}>À faire</option>
                      <option value="EN_COURS" {% if st.statut.name=='EN_COURS' %}selected{% endif %}>En cours</option>
                      <option value="TERMINE" {% if st.statut.name=='TERMINE' %}selected{% endif %}>Terminé</option>
                    </select>
                    <button class="btn btn-outline btn-sm ms-1">Mettre à jour</button>
                  </form>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <!-- ========== Infos & Mise à jour ========== -->
        <div id="tab-infos" class="tab-pane">
          <form method="post" action="/ACD/inscriptions/update-infos" class="needs-validation" novalidate enctype="multipart/form-data">
            <input type="hidden" name="pre_id" value="{{ selected.id }}">
            
            <!-- Accordion pour organiser les informations -->
            <div class="accordion" id="infosAccordion">
              
              <!-- Informations personnelles -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingPersonal">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonal" aria-expanded="true" aria-controls="collapsePersonal">
                    <i class="fas fa-user me-2"></i>Informations personnelles
                  </button>
                </h2>
                <div id="collapsePersonal" class="accordion-collapse collapse show" aria-labelledby="headingPersonal" data-bs-parent="#infosAccordion">
                  <div class="accordion-body">
                    <!-- Photo de profil -->
                    <div class="mb-4">
                      <label class="form-label">Photo de profil</label>
                      <div class="d-flex align-items-center gap-3">
                        <div class="avatar-preview" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid #dee2e6;">
                          <img id="photoPreview" 
                               src="{% if cand.photo_profil %}/media/{{ cand.photo_profil.replace('\\', '/') }}{% else %}/static/images/utilisateur.png{% endif %}" 
                               alt="Photo de profil" 
                               style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div class="flex-grow-1">
                          <input type="file" 
                                 class="form-control" 
                                 name="photo_profil" 
                                 id="photoProfil" 
                                 accept="image/*"
                                 onchange="previewPhoto(this)">
                          <div class="form-text">Formats acceptés : JPG, PNG, WEBP — 2 Mo max</div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Civilité</label>
                        <select class="form-select" name="civilite" required>
                          <option value="">Sélectionner...</option>
                          <option value="M" {% if cand.civilite == "M" %}selected{% endif %}>Monsieur</option>
                          <option value="Mme" {% if cand.civilite == "Mme" %}selected{% endif %}>Madame</option>
                          <option value="Mlle" {% if cand.civilite == "Mlle" %}selected{% endif %}>Mademoiselle</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Date de naissance</label>
                        <input type="date" class="form-control" name="date_naissance" value="{{ cand.date_naissance }}" required>
                      </div>
                      <div class="col-md-6">
              <label class="form-label">Téléphone</label>
                        <input type="tel" class="form-control" name="telephone" value="{{ cand.telephone or '' }}" pattern="[0-9+\s\-\(\)]+">
            </div>
                      <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <div class="input-group">
                          <input type="email" class="form-control" value="{{ cand.email }}" readonly>
                          {% if utilisateur.role in ['administrateur', 'coordinateur'] %}
                          <button type="button" class="btn btn-outline-warning" 
                                  onclick="ouvrirChangerEmailModal({{ cand.id }}, '{{ cand.email }}')"
                                  title="Changer l'email (Admin uniquement)">
                            <i class="fas fa-edit"></i>
                          </button>
                          {% endif %}
                        </div>
                        <div class="form-text">
                          L'email ne peut pas être modifié directement
                          {% if utilisateur.role in ['administrateur', 'coordinateur'] %}
                          <br><small class="text-muted">Les administrateurs peuvent changer l'email via le bouton ci-dessus</small>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-12">
              <label class="form-label">Adresse personnelle</label>
                        <textarea class="form-control" name="adresse_personnelle" rows="2">{{ cand.adresse_personnelle or '' }}</textarea>
            </div>
                      <div class="col-md-6">
                        <label class="form-label">Niveau d'études</label>
                        <input type="text" class="form-control" name="niveau_etudes" value="{{ cand.niveau_etudes or '' }}">
            </div>
                      <div class="col-md-6">
                        <label class="form-label">Secteur d'activité</label>
                        <input type="text" class="form-control" name="secteur_activite" value="{{ cand.secteur_activite or '' }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informations entreprise -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingCompany">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCompany" aria-expanded="false" aria-controls="collapseCompany">
                    <i class="fas fa-building me-2"></i>Informations entreprise
                  </button>
                </h2>
                <div id="collapseCompany" class="accordion-collapse collapse" aria-labelledby="headingCompany" data-bs-parent="#infosAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-md-6">
              <label class="form-label">SIRET</label>
                        <input type="text" class="form-control" name="siret" value="{{ ent.siret or '' }}" pattern="[0-9]{14}">
                        <div class="form-text">14 chiffres</div>
            </div>
                      <div class="col-md-6">
                        <label class="form-label">SIREN</label>
                        <input type="text" class="form-control" name="siren" value="{{ ent.siren or '' }}" pattern="[0-9]{9}">
                        <div class="form-text">9 chiffres</div>
                      </div>
                      <div class="col-12">
                        <label class="form-label">Raison sociale</label>
                        <input type="text" class="form-control" name="raison_sociale" value="{{ ent.raison_sociale or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Code NAF</label>
                        <input type="text" class="form-control" name="code_naf" value="{{ ent.code_naf or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Date de création</label>
              <input type="date" class="form-control" name="date_creation" value="{{ ent.date_creation }}">
            </div>
                      <div class="col-12">
                        <label class="form-label">Adresse entreprise</label>
                        <textarea class="form-control" name="adresse_entreprise" rows="2">{{ ent.adresse or '' }}</textarea>
            </div>
                      <div class="col-md-6">
                        <label class="form-label">Chiffre d'affaires</label>
                        <select class="form-select" name="chiffre_affaires">
                          <option value="">Sélectionner...</option>
                          <option value="0 - 10 000 €" {% if ent.chiffre_affaires == "0 - 10 000 €" %}selected{% endif %}>0 - 10 000 €</option>
                          <option value="10 000 - 50 000 €" {% if ent.chiffre_affaires == "10 000 - 50 000 €" %}selected{% endif %}>10 000 - 50 000 €</option>
                          <option value="50 000 - 100 000 €" {% if ent.chiffre_affaires == "50 000 - 100 000 €" %}selected{% endif %}>50 000 - 100 000 €</option>
                          <option value="100 000 - 500 000 €" {% if ent.chiffre_affaires == "100 000 - 500 000 €" %}selected{% endif %}>100 000 - 500 000 €</option>
                          <option value="500 000 - 1 000 000 €" {% if ent.chiffre_affaires == "500 000 - 1 000 000 €" %}selected{% endif %}>500 000 - 1 000 000 €</option>
                          <option value="1 000 000 € et plus" {% if ent.chiffre_affaires == "1 000 000 € et plus" %}selected{% endif %}>1 000 000 € et plus</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Nombre de points de vente</label>
                        <input type="number" class="form-control" name="nombre_points_vente" value="{{ ent.nombre_points_vente or '' }}" min="0">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informations restauration -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingRestaurant">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRestaurant" aria-expanded="false" aria-controls="collapseRestaurant">
                    <i class="fas fa-utensils me-2"></i>Informations restauration
                  </button>
                </h2>
                <div id="collapseRestaurant" class="accordion-collapse collapse" aria-labelledby="headingRestaurant" data-bs-parent="#infosAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Spécialité culinaire</label>
                        <input type="text" class="form-control" name="specialite_culinaire" value="{{ ent.specialite_culinaire or '' }}">
                      </div>
                      <div class="col-12">
                        <label class="form-label">Nom du concept</label>
                        <input type="text" class="form-control" name="nom_concept" value="{{ ent.nom_concept or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Site internet</label>
                        <input type="url" class="form-control" name="site_internet" value="{{ ent.site_internet or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Liens réseaux sociaux</label>
                        <input type="text" class="form-control" name="lien_reseaux_sociaux" value="{{ ent.lien_reseaux_sociaux or '' }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informations géographiques -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingGeo">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGeo" aria-expanded="false" aria-controls="collapseGeo">
                    <i class="fas fa-map-marker-alt me-2"></i>Informations géographiques
                  </button>
                </h2>
                <div id="collapseGeo" class="accordion-collapse collapse" aria-labelledby="headingGeo" data-bs-parent="#infosAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Zone QPV</label>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="qpv" value="true" {% if ent.qpv %}checked{% endif %}>
                          <label class="form-check-label">Situé en Zone de Revitalisation Rurale (QPV)</label>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Coordonnées GPS</label>
                        <div class="input-group">
                          <span class="input-group-text">Lat</span>
                          <input type="number" class="form-control" name="lat" value="{{ cand.lat or '' }}" step="any" readonly>
                          <span class="input-group-text">Lng</span>
                          <input type="number" class="form-control" name="lng" value="{{ cand.lng or '' }}" step="any" readonly>
                        </div>
                        <div class="form-text">Coordonnées automatiques basées sur l'adresse</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informations handicap -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingHandicap">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHandicap" aria-expanded="false" aria-controls="collapseHandicap">
                    <i class="fas fa-wheelchair me-2"></i>Informations handicap
                  </button>
                </h2>
                <div id="collapseHandicap" class="accordion-collapse collapse" aria-labelledby="headingHandicap" data-bs-parent="#infosAccordion">
                  <div class="accordion-body">
                    <div class="row g-3">
                      <div class="col-12">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="handicap" value="true" {% if cand.handicap %}checked{% endif %}>
                          <label class="form-check-label">Reconnaissance de handicap</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between mt-4">
              <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                <i class="fas fa-undo me-1"></i>Réinitialiser
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Enregistrer les modifications
              </button>
            </div>
          </form>
        </div>

        <!-- ========== Documentation ========== -->
        <div id="tab-docs" class="tab-pane">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-file-alt me-2"></i>Documents du candidat</h5>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
              <i class="fas fa-plus me-1"></i>Ajouter un document
            </button>
          </div>

          <!-- Liste des documents -->
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Nom du fichier</th>                
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if cand and cand.documents %}
                  {% for doc in cand.documents %}
                  <tr>
                    <td>
                      <span class="badge bg-info">{{ doc.type_document.value if doc.type_document else 'Autre' }}</span>
                    </td>
                    <td>
                      <i class="fas fa-file me-1"></i>
                      {{ doc.nom_fichier }}
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/ACD/inscriptions/document/{{ doc.id }}/view" target="_blank" class="btn btn-outline-primary" title="Voir">
                          <i class="fas fa-eye"></i>
                        </a>
                        <a href="/ACD/inscriptions/document/{{ doc.id }}/download" class="btn btn-outline-success" title="Télécharger">
                          <i class="fas fa-download"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteDocument({{ doc.id }})" title="Supprimer">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      <i class="fas fa-inbox fa-2x mb-2"></i><br>
                      Aucun document ajouté
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- ========== Éligibilité ========== -->
        <div id="tab-elig" class="tab-pane">
          <div class="elig-row">
            <div class="elig-card">
              <div class="fw-bold mb-1">Récap</div>
              <div>CA déclaré : <b>{{ elig and (elig.preinscription.candidat.entreprise.chiffre_affaires or '—') }}</b>
                {% if elig and elig.ca_seuil_ok is not none %}
                  <span class="badge bg-{{ 'success' if elig.ca_seuil_ok else 'danger' }} ms-2">
                    {{ 'Validé' if elig.ca_seuil_ok else 'Non validé' }}
                  </span>
                {% endif %}
              </div>
              <div>Ancienneté (ans) : <b>{{ elig and (elig.anciennete_annees or '—') }}</b>
                {% if elig and elig.anciennete_ok is not none %}
                  <span class="badge bg-{{ 'success' if elig.anciennete_ok else 'danger' }} ms-2">
                    {{ 'Validé' if elig.anciennete_ok else 'Non validé' }}
                  </span>
                {% endif %}
              </div>
              <div>QPV : 
                {% if qpv_name %}             
                  <small class="text-muted">({{ qpv_name }})</small>
                  <span class="badge bg-success me-2">Validé</span>
                {% else %}
                  <span class="badge bg-danger">Non validé</span>
                {% endif %}
              </div>
              <div class="mt-2">Verdict :
                {% if elig and elig.verdict == 'ok' %}
                  <span class="ok fw-bold">Favorable</span>
                {% elif elig and elig.verdict == 'attention' %}
                  <span class="warn fw-bold">À vérifier</span>
                {% elif elig and elig.verdict == 'ko' %}
                  <span class="ko fw-bold">Défavorable</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </div>
            </div>
            <div class="elig-card">
              <div class="fw-bold mb-1">Actions</div>
              <form method="post" action="/ACD/inscriptions/eligibilite/recalc">
                <input type="hidden" name="pre_id" value="{{ selected.id }}">
                <button class="btn btn-outline"><i class="fa fa-rotate me-1"></i> Recalculer</button>
              </form>
              <div class="small text-muted mt-2">Le recalcul utilise les infos actuelles (adresses, CA, date création) et les seuils du programme.</div>
            </div>
          </div>
        </div>

        <!-- ========== Jury ========== -->
        <div id="tab-jury" class="tab-pane">
          {% if not inscription %}
            <div class="text-muted">Créez l'inscription pour voter en jury.</div>
          {% else %}
          
          <!-- Statut actuel du candidat -->
          <div class="alert alert-info mb-4">
            <h6><i class="fas fa-info-circle me-2"></i>Statut actuel du candidat</h6>
            {% if cand.statut %}
              {% if cand.statut == "EN_ATTENTE" %}
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-clock"></i> En attente de décision du jury
                </span>
              {% elif cand.statut == "VALIDE" %}
                <span class="badge bg-success">
                  <i class="fas fa-check-circle"></i> Validé par le jury
                </span>
              {% elif cand.statut == "REORIENTE" %}
                <span class="badge bg-info">
                  <i class="fas fa-exchange-alt"></i> Réorienté vers un partenaire
                </span>
              {% elif cand.statut == "REJETE" %}
                <span class="badge bg-danger">
                  <i class="fas fa-times-circle"></i> Rejeté par le jury
                </span>
              {% endif %}
            {% else %}
              <span class="badge bg-warning text-dark">
                <i class="fas fa-clock"></i> En attente de décision du jury
              </span>
            {% endif %}
          </div>

          <!-- Formulaire de décision du jury -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-gavel me-2"></i>Décision du jury</h6>
            </div>
            <div class="card-body">
              <form method="post" action="/ACD/inscriptions/jury/decision" class="needs-validation" novalidate>
                <input type="hidden" name="candidat_id" value="{{ cand.id }}">
                
                <div class="row g-3">
                  <!-- Session jury -->
                  <div class="col-md-6">
                  <label class="form-label">Session jury</label>
                    <select class="form-select" name="jury_id" required>
                      <option value="">— Sélectionner une session —</option>
                    {% for j in jurys %}
                      <option value="{{ j.id }}">{{ j.session_le.strftime('%d/%m/%Y %H:%M') }} — {{ j.lieu or '—' }}</option>
                    {% endfor %}
                  </select>
                </div>
                  
                  <!-- Décision -->
                  <div class="col-md-6">
                  <label class="form-label">Décision</label>
                    <select class="form-select" name="decision" id="decisionSelect" required onchange="toggleDecisionFields()">
                      <option value="">— Sélectionner une décision —</option>
                      <option value="EN_ATTENTE">En attente</option>
                      <option value="VALIDE">Validé</option>
                      <option value="REORIENTE">Réorienté</option>
                      <option value="REJETE">Rejeté</option>
                  </select>
                </div>
                  
                  <!-- Commentaires -->
                  <div class="col-12">
                  <label class="form-label">Commentaires</label>
                    <textarea class="form-control" name="commentaires" rows="3" placeholder="Notes, conditions, observations du jury..."></textarea>
                </div>
              </div>

                <!-- Champs conditionnels pour VALIDÉ -->
                <div id="valideFields" class="mt-4" style="display: none;">
                  <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Informations pour candidat validé</h6>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Conseiller assigné</label>
                      <select class="form-select" name="conseiller_id">
                        <option value="">— Sélectionner un conseiller —</option>
                        {% for conseiller in conseillers %}
                          <option value="{{ conseiller.id }}">{{ conseiller.nom_complet }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Groupe Codev</label>
                      <select class="form-select" name="groupe_id">
                        <option value="">— Sélectionner un groupe —</option>
                        {% for groupe in groupes %}
                          <option value="{{ groupe.id }}">{{ groupe.nom }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Promotion</label>
                      <select class="form-select" name="promotion_id">
                        <option value="">— Sélectionner une promotion —</option>
                        {% for promo in promotions %}
                          <option value="{{ promo.id }}">{{ promo.libelle }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Champs conditionnels pour RÉORIENTÉ -->
                <div id="reorienteFields" class="mt-4" style="display: none;">
                  <div class="alert alert-info">
                    <h6><i class="fas fa-exchange-alt me-2"></i>Informations pour candidat réorienté</h6>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Partenaire</label>
                      <select class="form-select" name="partenaire_id">
                        <option value="">— Sélectionner un partenaire —</option>
                        {% for partenaire in partenaires %}
                          <option value="{{ partenaire.id }}">{{ partenaire.nom }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Options d'envoi d'emails -->
                <div class="mt-4">
                  <div class="alert alert-light">
                    <h6><i class="fas fa-envelope me-2"></i>Notifications par email</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="envoyer_mail_candidat" id="mailCandidat" checked>
                      <label class="form-check-label" for="mailCandidat">
                        Envoyer un email au candidat
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="envoyer_mail_conseiller" id="mailConseiller">
                      <label class="form-check-label" for="mailConseiller">
                        Envoyer un email au conseiller (si validé)
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="envoyer_mail_partenaire" id="mailPartenaire">
                      <label class="form-check-label" for="mailPartenaire">
                        Envoyer un email au partenaire (si réorienté)
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Boutons d'action -->
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-outline-secondary" onclick="resetJuryForm()">
                    <i class="fas fa-undo me-1"></i>Réinitialiser
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-gavel me-1"></i>Enregistrer la décision
                  </button>
              </div>
            </form>
          </div>
          </div>

          <!-- Historique des décisions -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0"><i class="fas fa-history me-2"></i>Historique des décisions</h6>
            </div>
            <div class="card-body">
              {% if decisions_jury %}
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Jury</th>
                        <th>Décision</th>
                        <th>Conseiller</th>
                        <th>Groupe</th>
                        <th>Promotion</th>
                        <th>Partenaire</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for decision in decisions_jury %}
                      <tr>
                        <td>{{ decision.date_decision.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ decision.jury.session_le.strftime('%d/%m/%Y') }}</td>
                        <td>
                          {% if decision.decision == "VALIDE" %}
                            <span class="badge bg-success">Validé</span>
                          {% elif decision.decision == "REORIENTE" %}
                            <span class="badge bg-info">Réorienté</span>
                          {% elif decision.decision == "REJETE" %}
                            <span class="badge bg-danger">Rejeté</span>
                          {% else %}
                            <span class="badge bg-warning">En attente</span>
          {% endif %}
                        </td>
                        <td>{{ decision.conseiller.nom_complet if decision.conseiller else '—' }}</td>
                        <td>{{ decision.groupe.nom if decision.groupe else '—' }}</td>
                        <td>{{ decision.promotion.libelle if decision.promotion else '—' }}</td>
                        <td>{{ decision.partenaire.nom if decision.partenaire else '—' }}</td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editDecision({{ decision.id }})">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteDecision({{ decision.id }})">
                              <i class="fas fa-trash"></i>
                            </button>
        </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
      </div>
              {% else %}
                <div class="text-muted text-center py-3">
                  <i class="fas fa-inbox fa-2x mb-2"></i><br>
                  Aucune décision du jury enregistrée pour ce candidat.
    </div>
    {% endif %}
  </div>
          </div>
          
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>



</div>
{% endblock %}

{% block scripts %}
<script>
  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      const tgt = document.querySelector(btn.dataset.tab);
      if (tgt) tgt.classList.add('active');
    });
  });

  // Ajuster le bandeau KPI selon l'état du sidebar
  function adjustKpiBandeau() {
    const sidebar = document.getElementById('sidebar');
    const kpiBandeau = document.querySelector('.kpi-bandeau-fixe');
    
    if (sidebar && kpiBandeau) {
      const isCollapsed = sidebar.classList.contains('collapsed');
      const sidebarWidth = isCollapsed ? 'var(--sidebar-width-collapsed)' : 'var(--sidebar-width)';
      kpiBandeau.style.left = sidebarWidth;
    }
  }

  // Fonction pour réinitialiser le formulaire
  function resetForm() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser le formulaire ? Toutes les modifications non sauvegardées seront perdues.')) {
      // Recharger la page pour restaurer les valeurs originales
      window.location.reload();
    }
  }

  // Fonction pour prévisualiser la photo de profil
  function previewPhoto(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('photoPreview');
        if (preview) {
          preview.src = e.target.result;
        }
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Fonction pour gérer les champs conditionnels du jury
  function toggleDecisionFields() {
    const decision = document.getElementById('decisionSelect').value;
    const valideFields = document.getElementById('valideFields');
    const reorienteFields = document.getElementById('reorienteFields');
    
    // Masquer tous les champs conditionnels
    if (valideFields) valideFields.style.display = 'none';
    if (reorienteFields) reorienteFields.style.display = 'none';
    
    // Afficher les champs selon la décision
    if (decision === 'VALIDE' && valideFields) {
      valideFields.style.display = 'block';
    } else if (decision === 'REORIENTE' && reorienteFields) {
      reorienteFields.style.display = 'block';
    }
  }

  // Fonction pour réinitialiser le formulaire jury
  function resetJuryForm() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser le formulaire ? Toutes les modifications non sauvegardées seront perdues.')) {
      document.querySelector('form[action="/ACD/inscriptions/jury/decision"]').reset();
      toggleDecisionFields(); // Masquer les champs conditionnels
    }
  }

  // Fonction pour éditer une décision
  function editDecision(decisionId) {
    // TODO: Implémenter l'édition via modal ou redirection
    alert('Fonction d\'édition à implémenter pour la décision ID: ' + decisionId);
  }

  // Fonction pour supprimer une décision
  function deleteDecision(decisionId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette décision ? Cette action est irréversible.')) {
      // Créer un formulaire de suppression
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/ACD/inscriptions/jury/decision/${decisionId}/delete`;
      
      // Ajouter un token CSRF si nécessaire
      const csrfToken = document.querySelector('meta[name="csrf-token"]');
      if (csrfToken) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrf_token';
        input.value = csrfToken.getAttribute('content');
        form.appendChild(input);
      }
      
      document.body.appendChild(form);
      form.submit();
    }
  }

  // Fonctions QPV et SIRET
  async function checkQPV(candidatId) {
    // Trouver le bouton QPV pour ce candidat
    const qpvButton = document.querySelector(`button[onclick="checkQPV(${candidatId})"]`);
    const originalContent = qpvButton.innerHTML;
    
    try {
      // Afficher le spinner et désactiver le bouton
      qpvButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Vérification...';
      qpvButton.disabled = true;
      
      // Afficher le modal avec spinner immédiatement
      const modal = document.getElementById('qpvResultModal');
      const modalBody = modal.querySelector('.modal-body');
      
      modalBody.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <h6>Vérification QPV en cours...</h6>
          <p class="text-muted">Analyse des adresses et géolocalisation</p>
        </div>
      `;
      
      // Afficher le modal
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      const response = await fetch('/ACD/inscriptions/qpv-check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `candidat_id=${candidatId}`
      });
      
      if (!response.ok) {
        throw new Error(`Erreur HTTP: ${response.status}`);
      }
      
      const result = await response.json();
      console.log('Résultat QPV:', result); // Debug
      
      // Mettre à jour le contenu du modal avec les résultats
      showQPVResult(result);
      
    } catch (error) {
      console.error('Erreur lors de la vérification QPV:', error);
      
      // Afficher l'erreur dans le modal
      const modal = document.getElementById('qpvResultModal');
      const modalBody = modal.querySelector('.modal-body');
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Erreur lors de la vérification QPV</strong><br>
          ${error.message}
        </div>
      `;
      
    } finally {
      // Restaurer le bouton dans tous les cas
      qpvButton.innerHTML = originalContent;
      qpvButton.disabled = false;
    }
  }

  async function checkSIRET(candidatId) {
    // Récupérer le SIRET depuis les données de l'entreprise du candidat
    const siret = '{{ ent.siret if ent and ent.siret else "" }}';
    
    if (!siret || siret.trim() === '') {
      // Afficher le modal avec un message d'information
      const modal = document.getElementById('siretResultModal');
      const modalBody = modal.querySelector('.modal-body');
      modalBody.innerHTML = `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>SIRET non renseigné</strong><br>
          Le candidat n'a pas encore renseigné son numéro SIRET/SIREN.<br>
          Veuillez d'abord mettre à jour les informations de l'entreprise dans l'onglet "Infos & mise à jour".
        </div>
        <div class="text-center mt-3">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="fas fa-check me-1"></i>Compris
          </button>
        </div>
      `;
      
      // Afficher le modal
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      return;
    }
    
    // Trouver le bouton SIRET pour ce candidat
    const siretButton = document.querySelector(`button[onclick="checkSIRET(${candidatId})"]`);
    const originalContent = siretButton.innerHTML;
    
    try {
      // Afficher le spinner et désactiver le bouton
      siretButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche...';
      siretButton.disabled = true;
      
      // Afficher immédiatement le modal avec un spinner
      const modal = document.getElementById('siretResultModal');
      const modalBody = modal.querySelector('.modal-body');
      modalBody.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Recherche en cours...</span>
          </div>
          <p class="mt-3">Recherche des informations SIRET en cours...</p>
          <small class="text-muted">SIRET: ${siret}</small>
        </div>
      `;
      
      // Afficher le modal
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      
      const response = await fetch('/ACD/inscriptions/siret-check', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `candidat_id=${candidatId}&numero_siret=${siret}`
      });
      
      const result = await response.json();
      showSIRETResult(result, candidatId);
    } catch (error) {
      console.error('Erreur lors de la vérification SIRET:', error);
      const modal = document.getElementById('siretResultModal');
      const modalBody = modal.querySelector('.modal-body');
      modalBody.innerHTML = `
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Erreur lors de la vérification SIRET</strong><br>
          ${error.message || 'Erreur inconnue'}
        </div>
      `;
    } finally {
      // Restaurer le bouton dans tous les cas
      siretButton.innerHTML = originalContent;
      siretButton.disabled = false;
    }
  }

  function showQPVResult(result) {
    console.log('🔍 [DEBUG] Structure complète des données QPV:', result);
    console.log('🔍 [DEBUG] Adresses analysées:', result.adresses_analysees);
    
    const modal = document.getElementById('qpvResultModal');
    const modalBody = modal.querySelector('.modal-body');
    
    // Indicateur si les données viennent du cache
    const cacheIndicator = result.from_cache ? 
      '<div class="alert alert-info"><i class="fas fa-database me-2"></i>Données récupérées depuis la base de données</div>' : 
      '<div class="alert alert-success"><i class="fas fa-search me-2"></i>Recherche effectuée en temps réel</div>';
    
    let html = `
      ${cacheIndicator}
      <div class="alert alert-${result.statut_qpv_final === 'QPV' ? 'success' : 'warning'}">
        <h6><i class="fas fa-map-marker-alt me-2"></i>Statut QPV: ${result.statut_qpv_final || 'Non déterminé'}</h6>
      </div>
    `;
    
    // Vérifier si les adresses analysées existent
    if (result.adresses_analysees && Array.isArray(result.adresses_analysees)) {
      html += `
        <div class="accordion" id="qpvAccordion">
      `;
      
      result.adresses_analysees.forEach((analyse, index) => {
        const accordionId = `qpvAccordion${index}`;
        const collapseId = `qpvCollapse${index}`;
        
        // Déterminer la couleur selon le statut
        let badgeClass = 'secondary';
        let statusText = 'Non déterminé';
        
        if (analyse.non_disponible) {
          badgeClass = 'light';
          statusText = 'Non disponible';
        } else if (analyse.resultat && !analyse.erreur) {
          const resultat = analyse.resultat;
          if (resultat.nom_qp) {
            if (resultat.nom_qp.includes('QPV:')) {
              badgeClass = 'success';
              statusText = 'QPV';
            } else if (resultat.nom_qp.includes('QPV limit:')) {
              badgeClass = 'warning';
              statusText = 'QPV limite';
            } else if (resultat.nom_qp === 'Aucun QPV') {
              badgeClass = 'secondary';
              statusText = 'Non QPV';
            }
          }
        } else if (analyse.erreur) {
          badgeClass = 'danger';
          statusText = 'Erreur';
        }
        
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading${index}">
              <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                      aria-expanded="${index === 0 ? 'true' : 'false'}" 
                      aria-controls="${collapseId}">
                <span class="me-2">${analyse.type === 'personnelle' ? '👤' : '🏢'}</span>
                <strong>${analyse.type === 'personnelle' ? 'Adresse personnelle' : 'Adresse entreprise'}</strong>
                <span class="badge bg-${badgeClass} ms-2">${statusText}</span>
              </button>
            </h2>
            <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                 aria-labelledby="heading${index}" data-bs-parent="#qpvAccordion">
              <div class="accordion-body">
                <p><strong>Adresse:</strong> ${analyse.address || analyse.adresse || 'Non fournie'}</p>
        `;
        
        // Vérifier si on a un résultat ou une erreur
        if (analyse.non_disponible) {
          html += `
            <div class="alert alert-light">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Adresse non disponible</strong><br>
              Cette adresse n'a pas été fournie lors de la préinscription.
            </div>
          `;
        } else if (analyse.resultat && !analyse.erreur) {
          const resultat = analyse.resultat;
          
          // Déterminer le statut QPV
          let statutQPV = 'Non déterminé';
          if (resultat.nom_qp) {
            if (resultat.nom_qp.includes('QPV:')) {
              statutQPV = 'QPV';
            } else if (resultat.nom_qp.includes('QPV limit:')) {
              statutQPV = 'QPV limite';
            } else if (resultat.nom_qp === 'Aucun QPV') {
              statutQPV = 'Non QPV';
            }
          }
          
          html += `
            <p><strong>Statut:</strong> ${statutQPV}</p>
          `;
          
          if (resultat.distance_m && resultat.distance_m !== 'N/A') {
            html += `<p><strong>Distance:</strong> ${resultat.distance_m} mètres</p>`;
          }
          
          if (resultat.nom_qp && resultat.nom_qp !== 'Aucun QPV') {
            const qpvName = resultat.nom_qp.split(':')[1] || resultat.nom_qp;
            html += `<p><strong>QPV:</strong> ${qpvName}</p>`;
          }
          
          // Image réduite
          if (resultat.image_url) {
            html += `
              <div class="mt-3">
                <h6>Carte géographique:</h6>
                <img src="${resultat.image_url}" class="img-fluid rounded" 
                     style="max-width: 300px; max-height: 200px;" 
                     alt="Carte QPV">
              </div>
            `;
          }
          
          // Lien vers la carte interactive
          if (resultat.carte) {
            html += `
              <div class="mt-2">
                <a href="${resultat.carte}" target="_blank" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-external-link-alt me-1"></i>Voir la carte interactive
                </a>
              </div>
            `;
          }
          
        } else if (analyse.erreur) {
          html += `
            <div class="alert alert-danger">
              <strong>Erreur:</strong> ${analyse.erreur}
            </div>
          `;
        } else {
          html += `
            <div class="alert alert-warning">
              <strong>Aucun résultat disponible</strong>
            </div>
          `;
        }
        
        html += `
              </div>
            </div>
          </div>
        `;
      });
      
      html += `</div>`; // Fermeture accordion
    } else {
      html += `<p class="text-muted">Aucune adresse analysée disponible.</p>`;
    }
    
    modalBody.innerHTML = html;
  }

    // Fonction pour afficher des alertes
    function showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer') || createAlertContainer();
        const alertId = 'alert-' + Date.now();
        
        const alertHtml = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        
        alertContainer.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto-supprimer après 5 secondes
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Fonction pour créer le conteneur d'alertes s'il n'existe pas
    function createAlertContainer() {
        const container = document.createElement('div');
        container.id = 'alertContainer';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.maxWidth = '400px';
        document.body.appendChild(container);
        return container;
    }

    // Fonction pour télécharger un document SIRET et l'ajouter aux documents du candidat
    async function downloadSiretDocument(candidatId, token, nomFichier, typeDocument) {
        try {
            console.log(`📥 [SIRET DOC] Téléchargement: ${nomFichier} (${typeDocument})`);
            
            // Afficher un spinner sur le bouton
            const button = event.target.closest('button');
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Téléchargement...';
            button.disabled = true;
            
            const response = await fetch('/ACD/inscriptions/download-siret-document', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    candidat_id: candidatId,
                    token: token,
                    nom_fichier: nomFichier,
                    type_document: typeDocument
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log(`✅ [SIRET DOC] Document téléchargé: ${result.filename}`);
                
                // Afficher un message de succès
                showAlert('success', `Document "${nomFichier}" téléchargé et ajouté aux documents du candidat !`);
                
                // Recharger la page pour afficher le nouveau document
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } else {
                console.error(`❌ [SIRET DOC] Erreur: ${result.message}`);
                
                // Si c'est une erreur de téléchargement, proposer le lien direct
                if (result.message.includes('téléchargement')) {
                    const confirmDirect = confirm(`Erreur lors du téléchargement automatique.\n\nVoulez-vous ouvrir le lien direct vers le document ?`);
                    if (confirmDirect) {
                        window.open(`https://api.pappers.fr/v2/document?token=${token}`, '_blank');
                    }
                } else {
                    showAlert('danger', `Erreur lors du téléchargement: ${result.message}`);
                }
                
                // Restaurer le bouton
                button.innerHTML = originalContent;
                button.disabled = false;
            }
            
        } catch (error) {
            console.error('❌ [SIRET DOC] Erreur:', error);
            showAlert('danger', 'Erreur lors du téléchargement du document');
            
            // Restaurer le bouton
            const button = event.target.closest('button');
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }

  function showSIRETResult(result, candidatId) {
    console.log('🔍 [DEBUG] Structure complète des données SIRET:', result);
    
    const modal = document.getElementById('siretResultModal');
    const modalBody = modal.querySelector('.modal-body');
    
    // Indicateur si les données viennent du cache ou sont nouvelles
    const cacheIndicator = result.from_cache ? 
      '<div class="alert alert-info"><i class="fas fa-database me-2"></i>Données récupérées depuis la base de données</div>' : 
      '<div class="alert alert-success"><i class="fas fa-search me-2"></i>Recherche effectuée en temps réel</div>';
    
    let html = `
      ${cacheIndicator}
      <div class="alert alert-${result.entreprise_mise_a_jour ? 'success' : 'warning'}">
        <h6><i class="fas fa-building me-2"></i>SIRET: ${result.numero_siret}</h6>
        <p>${result.resultat.message}</p>
        ${result.resultat.opposition_commerciale ? 
          '<div class="alert alert-warning mt-2"><i class="fas fa-exclamation-triangle me-2"></i><strong>Attention:</strong> Cette entreprise s\'oppose à l\'utilisation commerciale de ses données.</div>' : 
          ''
        }
      </div>
    `;
    
    if (result.resultat.entreprise_data) {
      const data = result.resultat.entreprise_data;
      
      html += `
        <div class="accordion" id="siretAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingGeneral">
              <button class="accordion-button" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#collapseGeneral" 
                      aria-expanded="true" aria-controls="collapseGeneral">
                <span class="me-2">🏢</span>
                <strong>Informations générales</strong>
              </button>
            </h2>
            <div id="collapseGeneral" class="accordion-collapse collapse show" 
                 aria-labelledby="headingGeneral" data-bs-parent="#siretAccordion">
              <div class="accordion-body">
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Nom:</strong> ${data.nom_entreprise || 'N/A'}</p>
                    <p><strong>Forme juridique:</strong> ${data.forme_juridique || 'N/A'}</p>
                    <p><strong>Date création:</strong> ${data.date_creation_formate || 'N/A'}</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Code NAF:</strong> ${data.code_naf || 'N/A'}</p>
                    <p><strong>Activité:</strong> ${data.activite || 'N/A'}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingSiege">
              <button class="accordion-button collapsed" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#collapseSiege" 
                      aria-expanded="false" aria-controls="collapseSiege">
                <span class="me-2">📍</span>
                <strong>Siège social</strong>
              </button>
            </h2>
            <div id="collapseSiege" class="accordion-collapse collapse" 
                 aria-labelledby="headingSiege" data-bs-parent="#siretAccordion">
              <div class="accordion-body">
                <p><strong>Adresse:</strong> ${data.siege.adresse || 'N/A'}</p>
                <p><strong>Code postal:</strong> ${data.siege.code_postal || 'N/A'}</p>
                <p><strong>Ville:</strong> ${data.siege.ville || 'N/A'}</p>
                <p><strong>SIRET:</strong> ${data.siege.siret || 'N/A'}</p>
              </div>
            </div>
          </div>
      `;
      
      // Ajouter les informations financières si disponibles
      if (data.finances) {
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingFinances">
              <button class="accordion-button collapsed" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#collapseFinances" 
                      aria-expanded="false" aria-controls="collapseFinances">
                <span class="me-2">💰</span>
                <strong>Informations financières</strong>
              </button>
            </h2>
            <div id="collapseFinances" class="accordion-collapse collapse" 
                 aria-labelledby="headingFinances" data-bs-parent="#siretAccordion">
              <div class="accordion-body">
                <p><strong>Chiffre d'affaires:</strong> ${data.finances.ca || 'N/A'}</p>
                <p><strong>Résultat net:</strong> ${data.finances.resultat_net || 'N/A'}</p>
                <p><strong>Effectif:</strong> ${data.finances.effectif || 'N/A'}</p>
              </div>
            </div>
          </div>
        `;
      }
      
      // Ajouter les documents disponibles si disponibles
      if (data.comptes && data.comptes.length > 0) {
        html += `
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingDocuments">
              <button class="accordion-button collapsed" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#collapseDocuments" 
                      aria-expanded="false" aria-controls="collapseDocuments">
                <span class="me-2">📄</span>
                <strong>Documents disponibles (${data.comptes.length})</strong>
              </button>
            </h2>
            <div id="collapseDocuments" class="accordion-collapse collapse" 
                 aria-labelledby="headingDocuments" data-bs-parent="#siretAccordion">
              <div class="accordion-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Année</th>
                        <th>Type</th>
                        <th>Date dépôt</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
        `;
        
        data.comptes.forEach((compte, index) => {
          const annee = compte.annee_cloture || 'N/A';
          const type = compte.type_comptes || 'N/A';
          const dateDepot = compte.date_depot_formate || 'N/A';
          const nomFichier = compte.nom_fichier_pdf || '';
          const token = compte.token || '';
          
          html += `
            <tr>
              <td>${annee}</td>
              <td>${type}</td>
              <td>${dateDepot}</td>
              <td>
          `;
          
          if (nomFichier && token) {
            html += `
              <button onclick="downloadSiretDocument('${candidatId}', '${token}', '${nomFichier}', 'COMPTE_ANNUEL')" 
                      class="btn btn-sm btn-outline-primary" 
                      title="Télécharger ${nomFichier}">
                <i class="fas fa-download me-1"></i>Télécharger
              </button>
            `;
          } else {
            html += `<span class="text-muted">Non disponible</span>`;
          }
          
          html += `
              </td>
            </tr>
          `;
        });
        
        html += `
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Ajouter les autres documents disponibles (statuts, extraits, etc.)
      if (data.documents_disponibles) {
        const docs = data.documents_disponibles;
        const hasOtherDocs = docs.statuts || docs.extrait_immatriculation || 
                           (docs.publications_bodacc && docs.publications_bodacc.length > 0) ||
                           (docs.depots_actes && docs.depots_actes.length > 0);
        
        if (hasOtherDocs) {
          html += `
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOtherDocs">
                <button class="accordion-button collapsed" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#collapseOtherDocs" 
                        aria-expanded="false" aria-controls="collapseOtherDocs">
                  <span class="me-2">📋</span>
                  <strong>Autres documents</strong>
                </button>
              </h2>
              <div id="collapseOtherDocs" class="accordion-collapse collapse" 
                   aria-labelledby="headingOtherDocs" data-bs-parent="#siretAccordion">
                <div class="accordion-body">
          `;
          
          // Statuts
          if (docs.statuts) {
            html += `
              <div class="mb-3">
                <h6><i class="fas fa-file-contract me-2"></i>Statuts</h6>
                <p><strong>Date:</strong> ${docs.statuts.date_depot_formate || 'N/A'}</p>
                ${docs.statuts.token ? 
                  `<button onclick="downloadSiretDocument('${candidatId}', '${docs.statuts.token}', 'Statuts', 'STATUTS')" 
                          class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i>Télécharger les statuts
                  </button>` : 
                  '<span class="text-muted">Non disponible</span>'
                }
              </div>
            `;
          }
          
          // Extrait d'immatriculation
          if (docs.extrait_immatriculation) {
            html += `
              <div class="mb-3">
                <h6><i class="fas fa-certificate me-2"></i>Extrait d'immatriculation</h6>
                <p><strong>Date:</strong> ${docs.extrait_immatriculation.date_depot_formate || 'N/A'}</p>
                ${docs.extrait_immatriculation.token ? 
                  `<button onclick="downloadSiretDocument('${candidatId}', '${docs.extrait_immatriculation.token}', 'Extrait immatriculation', 'EXTRACT_KBIS')" 
                          class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i>Télécharger l'extrait
                  </button>` : 
                  '<span class="text-muted">Non disponible</span>'
                }
              </div>
            `;
          }
          
          // Publications BODACC
          if (docs.publications_bodacc && docs.publications_bodacc.length > 0) {
            html += `
              <div class="mb-3">
                <h6><i class="fas fa-newspaper me-2"></i>Publications BODACC (${docs.publications_bodacc.length})</h6>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
            `;
            
            docs.publications_bodacc.forEach((pub, index) => {
              html += `
                <tr>
                  <td>${pub.date_publication_formate || 'N/A'}</td>
                  <td>${pub.type_publication || 'N/A'}</td>
                  <td>
              `;
              
              if (pub.token) {
                html += `
                  <button onclick="downloadSiretDocument('${candidatId}', '${pub.token}', '${pub.type_publication || 'Publication BODACC'}', 'PUBLICATION_BODACC')" 
                          class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-download me-1"></i>Télécharger
                  </button>
                `;
              } else {
                html += `<span class="text-muted">Non disponible</span>`;
              }
              
              html += `
                  </td>
                </tr>
              `;
            });
            
            html += `
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }
          
          html += `
                </div>
              </div>
            </div>
          `;
        }
      }
      
      html += `</div>`; // Fermeture accordion
      
      // Bouton de téléchargement CSV si disponible
      if (result.resultat.csv_file) {
        html += `
          <div class="mt-3">
            <a href="${result.resultat.csv_file}" class="btn btn-outline-primary" download>
              <i class="fas fa-download me-1"></i>Télécharger les données CSV
            </a>
          </div>
        `;
      }
    } else {
      html += `
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Aucune donnée entreprise trouvée</strong><br>
          Le numéro SIRET/SIREN fourni n'a pas retourné d'informations.
        </div>
      `;
    }
    
    modalBody.innerHTML = html;
    
    // Le modal est déjà affiché par la fonction checkSIRET, pas besoin de le réafficher
  }

  // Observer les changements du sidebar
  document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
      // Observer les changements de classe
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            adjustKpiBandeau();
          }
        });
      });
      
      observer.observe(sidebar, {
        attributes: true,
        attributeFilter: ['class']
      });
      
      // Ajuster au chargement initial
      adjustKpiBandeau();
    }
  });

  // Fonction pour supprimer un document
  function deleteDocument(documentId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce document ?')) {
      // Créer un formulaire pour la soumission POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/ACD/inscriptions/delete-document';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'document_id';
      input.value = documentId;
      
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  }
</script>

<!-- Modals pour QPV et SIRET -->
<div class="modal fade" id="qpvResultModal" tabindex="-1" aria-labelledby="qpvResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qpvResultModalLabel">
          <i class="fas fa-map-marker-alt me-2"></i>Résultat de la vérification QPV
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Processus de vérification QPV :</strong><br>
          • Géocodage des adresses personnelle et entreprise<br>
          • Vérification des coordonnées GPS<br>
          • Analyse de la zone géographique<br>
          • Génération de cartes interactives<br>
          <small class="text-muted">Ce processus peut prendre quelques secondes...</small>
        </div>
        <!-- Le contenu sera rempli dynamiquement par JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="siretResultModal" tabindex="-1" aria-labelledby="siretResultModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="siretResultModalLabel">
          <i class="fas fa-building me-2"></i>Résultat de la vérification SIRET
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Processus de vérification SIRET :</strong><br>
          • Recherche des informations entreprise via API Pappers<br>
          • Vérification du numéro SIRET/SIREN<br>
          • Récupération des données légales<br>
          • Analyse des informations financières<br>
          <small class="text-muted">Ce processus peut prendre quelques secondes...</small>
        </div>
        <!-- Le contenu sera rempli dynamiquement par JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour ajouter un document -->
<div class="modal fade" id="addDocumentModal" tabindex="-1" aria-labelledby="addDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDocumentModalLabel">
          <i class="fas fa-file-upload me-2"></i>Ajouter un document
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/ACD/inscriptions/add-document" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="candidat_id" value="{{ cand.id if cand else '' }}">
          
          <div class="mb-3">
            <label for="type_document" class="form-label">Type de document</label>
            <select class="form-select" id="type_document" name="type_document" required>
              <option value="">Sélectionnez un type</option>
              {% for type_doc in type_documents %}
              <option value="{{ type_doc.value }}">{{ type_doc.value }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mb-3">
            <label for="document_file" class="form-label">Fichier</label>
            <input type="file" class="form-control" id="document_file" name="document_file" 
                   accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
            <div class="form-text">Formats acceptés : PDF, DOC, DOCX, JPG, PNG (max 10MB)</div>
          </div>
          
          <div class="mb-3">
            <label for="description" class="form-label">Description (optionnel)</label>
            <textarea class="form-control" id="description" name="description" rows="3" 
                      placeholder="Description du document..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload me-1"></i>Ajouter le document
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal pour changer l'email -->
{% include 'candidats/changer_email_modal.html' %}

{% endblock %}
