{% extends "base.html" %}

{% block title %}Gestion des Rendez-vous{% endblock %}

{% block content %}
<div class="container-fluid h-100 d-flex flex-column">
    <!-- En-tête fixe -->
    <div class="row flex-shrink-0">
        <div class="col-12">
            <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom sticky-top" style="z-index: 1000;">
                <h3 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Gestion des Rendez-vous
                </h3>
                <a href="/rendez-vous/creer" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    Nouveau Rendez-vous
                </a>
            </div>
        </div>
    </div>
    
    <!-- Contenu principal avec défilement -->
    <div class="row flex-grow-1 overflow-hidden">
        <div class="col-12 h-100">
            <div class="card h-100 d-flex flex-column">
                
                <!-- Statistiques compactes -->
                <div class="card-body border-bottom flex-shrink-0">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="info-box-sm">
                                <span class="info-box-icon bg-info">
                                    <i class="fas fa-calendar-check"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Total</span>
                                    <span class="info-box-number">{{ stats.total }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box-sm">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-clock"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Planifiés</span>
                                    <span class="info-box-number">{{ stats.planifies }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box-sm">
                                <span class="info-box-icon bg-success">
                                    <i class="fas fa-check-circle"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Terminés</span>
                                    <span class="info-box-number">{{ stats.termines }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-box-sm">
                                <span class="info-box-icon bg-danger">
                                    <i class="fas fa-times-circle"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Annulés</span>
                                    <span class="info-box-number">{{ stats.annules }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtres simplifiés -->
                <div class="card-body flex-shrink-0">
                    <form method="get" class="mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Nom du candidat</label>
                                <input type="text" name="candidat_nom" class="form-control" value="{{ filters.candidat_nom or '' }}" placeholder="Rechercher par nom du candidat...">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Statut</label>
                                <select name="statut" class="form-select">
                                    <option value="">Tous les statuts</option>
                                    <option value="planifie" {% if filters.statut == 'planifie' %}selected{% endif %}>Planifié</option>
                                    <option value="en_cours" {% if filters.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                                    <option value="termine" {% if filters.statut == 'termine' %}selected{% endif %}>Terminé</option>
                                    <option value="annule" {% if filters.statut == 'annule' %}selected{% endif %}>Annulé</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-outline-primary">
                                        <i class="fas fa-search me-1"></i>Rechercher
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Tableau des rendez-vous avec bande déroulante -->
                    <div class="table-responsive flex-grow-1" style="max-height: calc(100vh - 450px); overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                        <table class="table table-striped table-hover mb-0" style="table-layout: fixed; width: 100%;">
                            <thead class="sticky-top bg-light" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="width: 12%;">Date/Heure</th>
                                    <th style="width: 15%;">Candidat</th>
                                    <th style="width: 8%;">Type</th>
                                    <th style="width: 8%;">Statut</th>
                                    <th style="width: 13%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rdv in rendez_vous %}
                                <tr>
                                    <td>
                                        <strong>{{ rdv.debut.strftime('%d/%m/%Y') }}</strong><br>
                                        <small class="text-muted">{{ rdv.debut.strftime('%H:%M') }}{% if rdv.fin %} - {{ rdv.fin.strftime('%H:%M') }}{% endif %}</small>
                                    </td>
                                    <td>
                                        <strong>{{ rdv.candidat_prenom }} {{ rdv.candidat_nom }}</strong><br>
                                        <small class="text-muted">{{ rdv.candidat_email }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">
                                            {% if rdv.type_rdv == 'entretien' %}
                                                <i class="fas fa-comments me-1"></i>Entretien
                                            {% elif rdv.type_rdv == 'suivi' %}
                                                <i class="fas fa-chart-line me-1"></i>Suivi
                                            {% elif rdv.type_rdv == 'coaching' %}
                                                <i class="fas fa-user-tie me-1"></i>Coaching
                                            {% else %}
                                                <i class="fas fa-question me-1"></i>Autre
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if rdv.statut == 'planifie' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-clock me-1"></i>Planifié
                                            </span>
                                        {% elif rdv.statut == 'en_cours' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-video me-1"></i>En cours
                                            </span>
                                        {% elif rdv.statut == 'termine' %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Terminé
                                            </span>
                                        {% elif rdv.statut == 'annule' %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Annulé
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/rendez-vous/{{ rdv.id }}" class="btn btn-outline-primary" title="Voir">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="/rendez-vous/{{ rdv.id }}" class="btn btn-outline-secondary" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                        {% if rdv.statut == 'planifie' %}
                        <a href="/emargement/{{ rdv.id }}" class="btn btn-outline-warning btn-emargement" title="Émargement" data-rdv-id="{{ rdv.id }}">
                            <i class="fas fa-signature"></i>
                            <span class="badge bg-secondary ms-1 signature-status" style="font-size: 0.6rem;">...</span>
                        </a>
                        <a href="/video-rdv/{{ rdv.id }}/commencer" class="btn btn-success btn-commencer-rdv" title="Commencer RDV vidéo" target="_blank" data-rdv-id="{{ rdv.id }}" style="display: none;">
                            <i class="fas fa-video"></i>
                        </a>
                        <a href="/video-rdv/{{ rdv.id }}/invitation/candidat" class="btn btn-info btn-lien-candidat" title="Lien candidat" target="_blank" data-rdv-id="{{ rdv.id }}" style="display: none;">
                            <i class="fas fa-link"></i>
                        </a>
                        <button type="button" class="btn btn-primary btn-envoyer-email" title="Envoyer invitation par email" onclick="envoyerInvitationEmail({{ rdv.id }})" data-rdv-id="{{ rdv.id }}" style="display: none;">
                            <i class="fas fa-envelope"></i>
                        </button>
                        {% elif rdv.statut == 'en_cours' %}
                        <a href="/video-rdv/{{ rdv.id }}/rejoindre" class="btn btn-warning" title="Continuer le rendez-vous vidéo en cours" target="_blank">
                            <i class="fas fa-video"></i>
                        </a>
                        <a href="/video-rdv/{{ rdv.id }}/invitation/candidat" class="btn btn-info" title="Lien candidat" target="_blank">
                            <i class="fas fa-link"></i>
                        </a>
                        <button type="button" class="btn btn-primary" title="Envoyer invitation par email" onclick="envoyerInvitationEmail({{ rdv.id }})">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" title="Terminer RDV" onclick="terminerRDV({{ rdv.id }})">
                            <i class="fas fa-stop"></i>
                        </button>
                        {% elif rdv.statut == 'termine' %}
                        <button type="button" class="btn btn-outline-info" title="Voir les notes" onclick="voirNotes({{ rdv.id }})">
                            <i class="fas fa-sticky-note"></i>
                            {% if rdv.notes and rdv.notes.strip() %}
                                <span class="badge bg-success ms-1" style="font-size: 0.6rem;">✓</span>
                            {% endif %}
                        </button>
                        {% endif %}
                                            <form method="post" action="/rendez-vous/{{ rdv.id }}/supprimer" class="d-inline" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce rendez-vous ?')">
                                                <button type="submit" class="btn btn-outline-danger" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-times fa-2x mb-2"></i><br>
                                        Aucun rendez-vous trouvé
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if has_next or has_prev %}
                    <nav aria-label="Pagination des rendez-vous">
                        <ul class="pagination justify-content-center">
                            {% if has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page - 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Précédent</a>
                            </li>
                            {% endif %}
                            <li class="page-item active">
                                <span class="page-link">{{ page }}</span>
                            </li>
                            {% if has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page + 1 }}{% for key, value in filters.items() %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Suivant</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher les notes -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">
                    <i class="fas fa-sticky-note text-info"></i> Notes du Rendez-vous
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="notesContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Chargement des notes...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* Conteneur parent venant de base.html - doit être transparent 
#content .container-fluid.p-4 {
    background: transparent !important;
    padding: 0 !important;
    position: static !important;
    min-height: auto !important;
}*/



/* Fix pour les rows avec flex-shrink-0 */
.row.flex-shrink-0 {
    flex-shrink: 0 !important;
    min-height: auto;
}

/* Réduction de la hauteur des statistiques */
.card-body.border-bottom.flex-shrink-0 {
    padding: 0.5rem !important; /* Réduit le padding */
    min-height: auto !important;
    height: auto !important;
}

/* Conteneur principal */
.card.h-100 {
    overflow: hidden; /* Empêche le débordement de la carte */
}

/* Conteneur du tableau */
.table-responsive.flex-grow-1 {
    min-height: 0; /* Permet au flexbox de réduire la taille */
    /* overflow: hidden; supprimé pour permettre le scroll */
    flex: 1 1 0; /* Force le flexbox à utiliser l'espace disponible */
}

/* En-tête fixe */
.card-header.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: white;
    border-bottom: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Statistiques compactes */
.info-box-sm {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
}

.info-box-sm .info-box-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 0.75rem;
    font-size: 1rem;
}

.info-box-sm .info-box-content {
    flex: 1;
}

.info-box-sm .info-box-text {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.info-box-sm .info-box-number {
    display: block;
    font-size: 1.25rem;
    font-weight: 600;
    color: #495057;
}

/* Styles pour le tableau avec bande déroulante */
.table-responsive {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Amélioration des cellules du tableau */
.table td {
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}

.table th {
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

/* Style pour les badges */
.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
}

/* Style pour les boutons d'action */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Styles pour la modal des notes */
.notes-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.notes-content {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.7;
    color: #495057;
    font-size: 14px;
}

.notes-content p {
    margin-bottom: 12px;
    text-align: justify;
    word-wrap: break-word;
}

.notes-content p:last-child {
    margin-bottom: 0;
}

.notes-content br {
    line-height: 1.8;
}

/* Style pour les puces et listes */
.notes-content ul, .notes-content ol {
    margin: 10px 0;
    padding-left: 25px;
}

.notes-content li {
    margin-bottom: 5px;
}

/* Style pour les titres dans les notes */
.notes-content h1, .notes-content h2, .notes-content h3, 
.notes-content h4, .notes-content h5, .notes-content h6 {
    color: #4262be;
    margin: 15px 0 10px 0;
    font-weight: 600;
}

/* Style pour les éléments importants */
.notes-content strong {
    color: #4262be;
    font-weight: 600;
}

.notes-content em {
    color: #6c757d;
    font-style: italic;
}
</style>

<script>
function terminerRDV(rdvId) {
    if (confirm('Êtes-vous sûr de vouloir terminer ce rendez-vous ?')) {
        fetch(`/video-rdv/${rdvId}/terminer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Recharger la page pour mettre à jour le statut
                location.reload();
            } else {
                alert('Erreur lors de la finalisation du rendez-vous');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la finalisation du rendez-vous');
        });
    }
}

function voirNotes(rdvId) {
    // Afficher la modal
    const modal = new bootstrap.Modal(document.getElementById('notesModal'));
    modal.show();
    
    // Réinitialiser le contenu
    document.getElementById('notesContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des notes...</p>
        </div>
    `;
    
    // Récupérer les notes
    fetch(`/video-rdv/${rdvId}/notes`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let notesHtml = `
                    <div class="mb-3">
                        <h6 class="text-muted">Informations du RDV</h6>
                        <p><strong>Date :</strong> ${data.date_rdv}</p>
                        <p><strong>Statut :</strong> 
                            <span class="badge bg-success">${data.statut}</span>
                        </p>
                    </div>
                    <hr>
                    <h6 class="text-muted mb-3">Notes prises pendant le rendez-vous :</h6>
                `;
                
                if (data.notes && data.notes.trim()) {
                    // Formater les notes avec une meilleure présentation
                    let notesFormatted = data.notes
                        // Gérer les listes à puces
                        .replace(/^[\s]*[-*+]\s+(.+)$/gm, '<li>$1</li>')
                        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                        // Gérer les listes numérotées
                        .replace(/^[\s]*\d+\.\s+(.+)$/gm, '<li>$1</li>')
                        .replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>')
                        // Gérer les titres (lignes qui commencent par #)
                        .replace(/^#\s+(.+)$/gm, '<h4>$1</h4>')
                        .replace(/^##\s+(.+)$/gm, '<h5>$1</h5>')
                        .replace(/^###\s+(.+)$/gm, '<h6>$1</h6>')
                        // Gérer les éléments en gras (**texte**)
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        // Gérer les éléments en italique (*texte*)
                        .replace(/\*(.+?)\*/g, '<em>$1</em>')
                        // Séparer les paragraphes (double retour à la ligne)
                        .replace(/\n\n/g, '</p><p>')
                        // Retours à la ligne simples
                        .replace(/\n/g, '<br>')
                        // Encapsuler dans des paragraphes
                        .replace(/^/, '<p>')
                        .replace(/$/, '</p>');
                    
                    notesHtml += `
                        <div class="notes-container">
                            <div class="notes-content">
                                ${notesFormatted}
                            </div>
                        </div>
                    `;
                } else {
                    notesHtml += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Aucune note n'a été prise pour ce rendez-vous.
                        </div>
                    `;
                }
                
                document.getElementById('notesContent').innerHTML = notesHtml;
            } else {
                document.getElementById('notesContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        Erreur lors du chargement des notes.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('notesContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Erreur lors du chargement des notes.
                </div>
            `;
        });
}

// Fonction pour vérifier le statut des signatures et afficher les boutons appropriés
function verifierStatutSignatures() {
    const rdvIds = new Set();
    
    // Collecter tous les IDs de RDV (planifiés ET en cours)
    document.querySelectorAll('.btn-commencer-rdv[data-rdv-id], .btn-emargement[data-rdv-id]').forEach(btn => {
        rdvIds.add(btn.getAttribute('data-rdv-id'));
    });
    
    // Vérifier le statut de chaque RDV
    rdvIds.forEach(rdvId => {
        fetch(`/emargement/${rdvId}/statut`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'found') {
                    const commencerBtn = document.querySelector(`.btn-commencer-rdv[data-rdv-id="${rdvId}"]`);
                    const lienBtn = document.querySelector(`.btn-lien-candidat[data-rdv-id="${rdvId}"]`);
                    const emailBtn = document.querySelector(`.btn-envoyer-email[data-rdv-id="${rdvId}"]`);
                    const emargementBtn = document.querySelector(`.btn-emargement[data-rdv-id="${rdvId}"]`);
                    const statusBadge = document.querySelector(`.btn-emargement[data-rdv-id="${rdvId}"] .signature-status`);
                    
                    // Mettre à jour le badge de statut
                    if (statusBadge) {
                        if (data.peut_commencer) {
                            statusBadge.textContent = '✓';
                            statusBadge.className = 'badge bg-success ms-1 signature-status';
                            statusBadge.style.fontSize = '0.6rem';
                        } else {
                            const conseillerSigne = data.conseiller_signe ? 'C' : '';
                            const candidatSigne = data.candidat_signe ? 'c' : '';
                            statusBadge.textContent = conseillerSigne + candidatSigne || '0';
                            statusBadge.className = 'badge bg-warning ms-1 signature-status';
                            statusBadge.style.fontSize = '0.6rem';
                        }
                    }
                    
                    // Pour les RDV planifiés, afficher/masquer les boutons selon les signatures
                    if (commencerBtn) {
                        if (data.peut_commencer) {
                            commencerBtn.style.display = 'inline-block';
                        } else {
                            commencerBtn.style.display = 'none';
                        }
                    }
                    
                    if (lienBtn) {
                        if (data.peut_commencer) {
                            lienBtn.style.display = 'inline-block';
                        } else {
                            lienBtn.style.display = 'none';
                        }
                    }
                    
                    if (emailBtn) {
                        if (data.peut_commencer) {
                            emailBtn.style.display = 'inline-block';
                        } else {
                            emailBtn.style.display = 'none';
                        }
                    }
                }
            })
            .catch(error => {
                console.error(`Erreur lors de la vérification du statut pour RDV ${rdvId}:`, error);
            });
    });
}

// Fonction pour ajuster la position du conteneur selon l'état du sidebar
function adjustContainerPosition() {
    const sidebar = document.getElementById('sidebar');
    const container = document.querySelector('.container-fluid.h-100.d-flex.flex-column');
    
    if (sidebar && container) {
        const isCollapsed = sidebar.classList.contains('collapsed');
        const isMobile = window.innerWidth <= 768;
        
        // Sur mobile, pas de sidebar
        if (isMobile) {
            container.style.left = '0';
            container.style.right = '20px';
        } else {
            // Sur desktop, ajuster selon l'état du sidebar
            const sidebarWidth = isCollapsed ? 'var(--sidebar-width-collapsed)' : 'var(--sidebar-width)';
            container.style.left = sidebarWidth;
            container.style.right = '20px'; // Plus d'espace à droite pour éviter le débordement
        }
    }
}

// Vérifier le statut des signatures au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    verifierStatutSignatures();
    
    // Ajuster la position du conteneur au chargement initial
    adjustContainerPosition();
    
    // Observer les changements de classe du sidebar
    const sidebar = document.getElementById('sidebar');
    if (sidebar) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    adjustContainerPosition();
                }
            });
        });
        
        observer.observe(sidebar, {
            attributes: true,
            attributeFilter: ['class']
        });
    }
    
    // Ajuster lors du redimensionnement de la fenêtre
    window.addEventListener('resize', adjustContainerPosition);
    
    // Ajouter un listener pour rafraîchir la page après avoir cliqué sur "Commencer"
    document.querySelectorAll('.btn-commencer-rdv').forEach(btn => {
        btn.addEventListener('click', function() {
            // Attendre un peu pour que le serveur mette à jour le statut
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        });
    });
    
    // Vérifier périodiquement le statut des RDV pour mettre à jour les boutons
    setInterval(() => {
        verifierStatutSignatures();
    }, 5000); // Vérifier toutes les 5 secondes
});

function envoyerInvitationEmail(rdvId) {
    if (confirm('Êtes-vous sûr de vouloir envoyer l\'invitation par email au candidat ?')) {
        // Désactiver le bouton pendant l'envoi
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
        
        fetch(`/video-rdv/${rdvId}/envoyer-invitation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
                // Changer l'icône pour indiquer l'envoi réussi
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }, 3000);
            } else {
                alert('Erreur lors de l\'envoi de l\'invitation');
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'envoi de l\'invitation');
            button.innerHTML = originalContent;
            button.disabled = false;
        });
    }
}
</script>
{% endblock %}
