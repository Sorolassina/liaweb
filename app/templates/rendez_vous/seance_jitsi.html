<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ app_name }} ‚Äî RDV #{{ rdv.id }}</title>
  <style>
    :root{ --bg:#0b0b0b }
    html,body{height:100%}
    body{margin:0;background:var(--bg);}
    #meet{height:100vh; width:100vw; overflow:hidden}
    .topbar{
      position:fixed; inset:16px auto auto 16px; z-index:10; background:rgba(17,17,17,.6);
      color:#fff; padding:8px 12px; border-radius:10px; backdrop-filter: blur(8px); font-family:Inter,system-ui,Arial;
    }
    .topbar a{color:#ffd300; text-decoration:none}
    .terminer-btn{
      background:#dc3545 !important;
      color:white !important;
      border:none !important;
      padding:6px 12px !important;
      border-radius:6px !important;
      margin-left:15px !important;
      cursor:pointer !important;
      font-size:12px !important;
      font-weight:bold !important;
      transition:background 0.3s !important;
    }
    .terminer-btn:hover{
      background:#c82333 !important;
    }
    
    /* Styles pour la fen√™tre de notes */
    .notes-panel{
      position:fixed;
      top:80px;
      right:20px;
      width:300px;
      height:400px;
      background:rgba(17,17,17,.9);
      border:1px solid #333;
      border-radius:10px;
      backdrop-filter:blur(10px);
      z-index:1000;
      display:none;
      flex-direction:column;
    }
    .notes-header{
      background:rgba(255,211,0,.2);
      padding:8px 12px;
      border-radius:10px 10px 0 0;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .notes-title{
      color:#ffd300;
      font-weight:bold;
      font-size:14px;
    }
    .notes-close{
      background:none;
      border:none;
      color:#fff;
      cursor:pointer;
      font-size:16px;
      padding:0;
      width:20px;
      height:20px;
    }
    .notes-content{
      flex:1;
      padding:12px;
      display:flex;
      flex-direction:column;
    }
    .notes-textarea{
      flex:1;
      background:rgba(255,255,255,.1);
      border:1px solid #444;
      border-radius:6px;
      color:#fff;
      padding:8px;
      font-size:12px;
      resize:none;
      font-family:inherit;
    }
    .notes-textarea:focus{
      outline:none;
      border-color:#ffd300;
    }
    .notes-footer{
      padding:8px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .notes-save{
      background:#28a745;
      color:white;
      border:none;
      padding:4px 8px;
      border-radius:4px;
      cursor:pointer;
      font-size:11px;
    }
    .notes-status{
      font-size:10px;
      color:#888;
    }
    .notes-toggle{
      background:#ffd300;
      color:#000;
      border:none;
      padding:6px 10px;
      border-radius:6px;
      margin-left:10px;
      cursor:pointer;
      font-size:11px;
      font-weight:bold;
    }
  </style>
</head>
<body>
  <div class="topbar">
    RDV #{{ rdv.id }} ¬∑ {{ candidat_prenom }} {{ candidat_nom }} ¬∑ {{ programme_nom }} ¬∑ <strong>{% if is_host %}{{ display_name }}{% else %}{{ conseiller_nom }}{% endif %}</strong>
    {% if is_host %}
    ¬∑ <a href="{{ url_for('accueil') }}" class="submenu-item">Accueil</a>
    <button onclick="toggleNotes()" class="notes-toggle">
      üìù Notes
    </button>
    <button onclick="terminerRDV()" class="terminer-btn">
      üõë Terminer RDV
    </button>
    {% endif %}
  </div>
  <div id="meet"></div>

  <!-- Fen√™tre de notes (pour l'h√¥te uniquement) -->
  {% if is_host %}
  <div id="notesPanel" class="notes-panel">
    <div class="notes-header">
      <span class="notes-title">üìù Notes du RDV</span>
      <button onclick="toggleNotes()" class="notes-close">√ó</button>
    </div>
    <div class="notes-content">
      <textarea id="notesTextarea" class="notes-textarea" placeholder="Prenez vos notes pendant l'entretien..."></textarea>
    </div>
    <div class="notes-footer">
      <button onclick="sauvegarderNotes()" class="notes-save">üíæ Sauvegarder</button>
      <span id="notesStatus" class="notes-status"></span>
    </div>
  </div>
  {% endif %}

  <script src="https://meet.jit.si/external_api.js"></script>
  <script>
    // Configuration Jitsi avec r√¥les
    const options = {
      roomName: "{{ room_name }}", // Nom de la salle Jitsi
      parentNode: document.getElementById("meet"),
      width: "100%",
      height: "100%",
      userInfo: { 
        displayName: "{{ display_name }}{% if is_host %} (Conseiller){% else %} (Candidat){% endif %}" 
      },
      configOverwrite: { 
        disableDeepLinking: true,
        {% if is_host %}
        // Configuration pour l'h√¥te (conseiller)
        startWithAudioMuted: false,
        startWithVideoMuted: false,
        enableLobby: true,
        enableClosePage: false,
        enableWelcomePage: false,
        enablePrejoinPage: false,
        // Notifications pour les invit√©s
        enableInsecureRoomNameWarning: false,
        enableNoisyMicDetection: true,
        // Configuration de la salle d'attente
        enableLayerSuspension: true,
        channelLastN: -1
        {% else %}
        // Configuration pour l'invit√© (candidat)
        startWithAudioMuted: true,
        startWithVideoMuted: true,
        enableLobby: false,
        enableClosePage: true,
        enableWelcomePage: false,
        enablePrejoinPage: false,
        // D√©sactiver compl√®tement les options de r√¥le pour le candidat
        disableModeratorIndicator: true,
        enableLayerSuspension: false,
        // Forcer le r√¥le invit√©
        enableInsecureRoomNameWarning: false,
        enableNoisyMicDetection: false,
        // Masquer les contr√¥les d'h√¥te
        hideDisplayName: false,
        hideEmailInSettings: true,
        // D√©sactiver les fonctionnalit√©s d'h√¥te
        enableWelcomePage: false,
        enablePrejoinPage: false,
        enableClosePage: true
        {% endif %}
      }
    };
    const api = new JitsiMeetExternalAPI("meet.jit.si", options);

    // Gestion des √©v√©nements selon le r√¥le
    const role = "{{ role }}";
    const isHost = {{ is_host|lower }};
    
    {% if is_host %}
    // √âv√©nements pour l'h√¥te (conseiller)
    api.addEventListener("videoConferenceJoined", () => {
      console.log("Conseiller rejoint la conf√©rence");
      
      // Auto-sauvegarde des notes toutes les 30 secondes
      setInterval(sauvegarderNotes, 30000);
    });
    
    // Gestion des participants qui rejoignent
    api.addEventListener("participantJoined", (participant) => {
      console.log("Participant rejoint:", participant.displayName);
      // Optionnel : notification visuelle
    });
    
    // Gestion des demandes d'admission
    api.addEventListener("lobbyUserJoined", (participant) => {
      console.log("Utilisateur en attente:", participant.displayName);
      // Accepter automatiquement ou demander confirmation
      api.executeCommand("admitEveryone");
    });
    
    {% else %}
    // √âv√©nements pour l'invit√© (candidat)
    api.addEventListener("videoConferenceJoined", () => {
      console.log("Candidat rejoint la conf√©rence");
      // Micro et cam√©ra d√©sactiv√©s par d√©faut
        api.executeCommand("toggleAudio");
      api.executeCommand("toggleVideo");
      
      // S'assurer que le candidat reste invit√©
      try {
        // D√©sactiver les contr√¥les d'h√¥te si jamais ils apparaissent
        api.executeCommand("toggleLobby");
      } catch(e) {
        // Ignorer les erreurs si la commande n'est pas disponible
      }
    });
    
    api.addEventListener("lobbyJoined", () => {
      console.log("Candidat en salle d'attente");
    });
    
    // Emp√™cher le candidat de prendre le contr√¥le
    api.addEventListener("participantRoleChanged", (participant) => {
      if (participant.id === api.getMyUserId()) {
        console.log("Tentative de changement de r√¥le d√©tect√©e - maintenir le r√¥le invit√©");
      }
    });
    
    {% endif %}

    // Gestion de la fin de r√©union
    api.addEventListener("videoConferenceLeft", () => {
      console.log("Quitt√© la conf√©rence");
    });

    // Fonction pour terminer le RDV (pour l'h√¥te uniquement)
    {% if is_host %}
    window.terminerRDV = async function() {
      if (!confirm('√ätes-vous s√ªr de vouloir terminer ce rendez-vous ?')) {
        return;
      }
      
      try {
        // Sauvegarder les notes si n√©cessaire
        await sauvegarderNotes();
        
        // Terminer la r√©union c√¥t√© serveur
        const response = await fetch(`/video-rdv/{{ rdv.id }}/terminer`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
           if (response.ok) {
             // Quitter la r√©union Jitsi
             api.executeCommand('hangup');
             alert('Rendez-vous termin√© avec succ√®s !');
             // Rediriger vers la page liste des RDV
             window.location.href = '/rendez-vous';
           } else {
             throw new Error('Erreur lors de la finalisation');
           }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la finalisation du rendez-vous');
      }
    };

    // Fonction pour sauvegarder les notes
    window.sauvegarderNotes = async function() {
      const notes = document.getElementById('notesTextarea').value;
      const status = document.getElementById('notesStatus');
      
      try {
        const response = await fetch(`/video-rdv/{{ rdv.id }}/notes`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ notes: notes })
        });
        
        if (response.ok) {
          status.textContent = '‚úÖ Sauvegard√©';
          status.style.color = '#28a745';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Erreur:', error);
        status.textContent = '‚ùå Erreur';
        status.style.color = '#dc3545';
      }
      
      // Reset du statut apr√®s 3 secondes
      setTimeout(() => {
        status.textContent = '';
        status.style.color = '#888';
      }, 3000);
    };

    // Fonction pour charger les notes existantes
    window.chargerNotes = async function() {
      try {
        const response = await fetch(`/video-rdv/{{ rdv.id }}/notes`);
        if (response.ok) {
          const data = await response.json();
          document.getElementById('notesTextarea').value = data.notes || '';
        }
      } catch (error) {
        console.error('Erreur lors du chargement des notes:', error);
      }
    };

    // Fonction pour basculer l'affichage des notes
    window.toggleNotes = function() {
      const panel = document.getElementById('notesPanel');
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'flex';
        chargerNotes(); // Charger les notes existantes
      } else {
        panel.style.display = 'none';
      }
    };
    {% endif %}
  </script>
</body>
</html>
