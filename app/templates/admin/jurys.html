{% extends "admin/base_admin.html" %}
{% block admin_content %}

<!-- Messages de succès/erreur -->
{% if request.query_params.get('success') %}
  {% set success_type = request.query_params.get('success') %}
  {% if success_type == 'member_added' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fa fa-check-circle me-2"></i>Membre ajouté au jury avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif success_type == 'member_deleted' %}
    <div class="alert alert-info alert-dismissible fade show" role="alert">
      <i class="fa fa-info-circle me-2"></i>Membre retiré du jury avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif success_type == 'invitations_sent' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fa fa-envelope me-2"></i>Invitations envoyées avec succès ! ({{ request.query_params.get('count', 0) }} email(s))
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif success_type == 'jury_updated' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="fa fa-check-circle me-2"></i>Jury mis à jour avec succès !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}
{% endif %}

{% if request.query_params.get('error') %}
  {% set error_type = request.query_params.get('error') %}
  {% if error_type == 'already_member' %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <i class="fa fa-exclamation-triangle me-2"></i>Cet utilisateur est déjà membre de ce jury !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif error_type == 'no_members' %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      <i class="fa fa-exclamation-triangle me-2"></i>Aucun membre assigné au jury pour envoyer les invitations !
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="m-0">
    <i class="fa fa-gavel me-2"></i>Gestion des jurys
  </h5>
  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addJuryModal">
    <i class="fa fa-plus me-2"></i>Nouveau jury
  </button>
</div>

<!-- Modal d'ajout de jury -->
<div class="modal fade" id="addJuryModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-plus me-2"></i>+ jury
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('admin_jurys_add') }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Programme <span class="text-danger">*</span></label>
              <select name="programme_id" class="form-select" required>
                <option value="">— Sélectionnez un programme —</option>
                {% for p in progs %}
                  <option value="{{ p.id }}">{{ p.code }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Promotion</label>
              <select name="promotion_id" class="form-select">
                <option value="">— Aucune promotion —</option>
                {% for promo in promotions %}
                  <option value="{{ promo.id }}">{{ promo.libelle }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Optionnel : associer à une promotion spécifique</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" name="session_date" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Heure <span class="text-danger">*</span></label>
              <input type="time" name="session_time" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Lieu</label>
              <input name="lieu" class="form-control" placeholder="Ex: Salle de conférence">
            </div>
            <div class="col-12">
              <label class="form-label">Statut</label>
              <select name="statut" class="form-select">
                <option value="planifie" selected>Planifié</option>
                <option value="en_cours">En cours</option>
                <option value="termine">Terminé</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save me-2"></i>Créer le jury
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card-neumo p-3">
  <div class="users-table-container">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Date/Heure</th>
          <th>Programme</th>
          <th>Statut</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for j in jurys %}
        <tr>
          <td>
            <div class="fw-bold">{{ j.session_le.strftime('%d/%m/%Y') }}</div>
            <small class="text-muted">{{ j.session_le.strftime('%H:%M') }}</small>
          </td>
          <td>
            {% if j.programme %}
              <span class="badge bg-primary">{{ j.programme.code }}</span>
              <div class="small text-muted">{{ j.programme.nom }}</div>
            {% else %}
              <span class="text-muted">Programme supprimé</span>
            {% endif %}
          </td>
    
          <td>
            {% if j.statut == 'planifie' %}
              <span class="badge bg-warning">
                <i class="fa fa-clock me-1"></i>Planifié
              </span>
            {% elif j.statut == 'en_cours' %}
              <span class="badge bg-primary">
                <i class="fa fa-play me-1"></i>En cours
              </span>
            {% elif j.statut == 'termine' %}
              <span class="badge bg-success">
                <i class="fa fa-check me-1"></i>Terminé
              </span>
            {% else %}
              <span class="badge bg-secondary">{{ j.statut }}</span>
            {% endif %}
          </td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#viewJuryModal{{ j.id }}" title="Voir détails">
                <i class="fa fa-eye"></i>
              </button>
              <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editJuryModal{{ j.id }}" title="Modifier">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#membersJuryModal{{ j.id }}" title="Gérer les membres">
                <i class="fa fa-users"></i>
              </button>
              <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#invitationsJuryModal{{ j.id }}" title="Envoyer invitations">
                <i class="fa fa-envelope"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="deleteJury({{ j.id }})" title="Supprimer">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">
            <i class="fa fa-gavel me-2"></i>Aucun jury programmé
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modals d'édition pour chaque jury -->
{% for j in jurys %}
<div class="modal fade" id="editJuryModal{{ j.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-edit me-2"></i>Modifier le jury
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('admin_jury_update', jury_id=j.id) }}">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Programme <span class="text-danger">*</span></label>
              <select name="programme_id" class="form-select" required>
                {% for p in progs %}
                  <option value="{{ p.id }}" {% if j.programme_id == p.id %}selected{% endif %}>{{ p.code }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Promotion</label>
              <select name="promotion_id" class="form-select">
                <option value="">— Aucune promotion —</option>
                {% for promo in promotions %}
                  <option value="{{ promo.id }}" {% if j.promotion_id == promo.id %}selected{% endif %}>{{ promo.libelle }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" name="session_date" class="form-control" 
                     value="{{ j.session_le.strftime('%Y-%m-%d') }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Heure <span class="text-danger">*</span></label>
              <input type="time" name="session_time" class="form-control" 
                     value="{{ j.session_le.strftime('%H:%M') }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Lieu</label>
              <input name="lieu" class="form-control" value="{{ j.lieu or '' }}" placeholder="Ex: Salle de conférence">
            </div>
            <div class="col-12">
              <label class="form-label">Statut</label>
              <select name="statut" class="form-select">
                <option value="planifie" {% if j.statut == 'planifie' %}selected{% endif %}>Planifié</option>
                <option value="en_cours" {% if j.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                <option value="termine" {% if j.statut == 'termine' %}selected{% endif %}>Terminé</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-save me-2"></i>Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- Modals de visualisation et gestion des membres pour chaque jury -->
{% for j in jurys %}
<div class="modal fade" id="viewJuryModal{{ j.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-gavel me-2"></i>Détails du jury
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Informations du jury -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label class="form-label fw-bold">Programme</label>
            <div>
              {% if j.programme %}
                <span class="badge bg-primary">{{ j.programme.code }}</span>
                <div class="small text-muted">{{ j.programme.nom }}</div>
              {% else %}
                <span class="text-muted">Programme supprimé</span>
              {% endif %}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Promotion</label>
            <div>
              {% if j.promotion %}
                <span class="badge bg-info">{{ j.promotion.libelle }}</span>
              {% else %}
                <span class="text-muted">Aucune promotion</span>
              {% endif %}
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Date et heure</label>
            <div class="fw-bold">{{ j.session_le.strftime('%d/%m/%Y') }}</div>
            <div class="small text-muted">{{ j.session_le.strftime('%H:%M') }}</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold">Statut</label>
            <div>
              {% if j.statut == 'planifie' %}
                <span class="badge bg-warning">
                  <i class="fa fa-clock me-1"></i>Planifié
                </span>
              {% elif j.statut == 'en_cours' %}
                <span class="badge bg-primary">
                  <i class="fa fa-play me-1"></i>En cours
                </span>
              {% elif j.statut == 'termine' %}
                <span class="badge bg-success">
                  <i class="fa fa-check me-1"></i>Terminé
                </span>
              {% else %}
                <span class="badge bg-secondary">{{ j.statut }}</span>
              {% endif %}
            </div>
          </div>
          <div class="col-12">
            <label class="form-label fw-bold">Lieu</label>
            <div>{{ j.lieu or 'Non spécifié' }}</div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de gestion des membres pour chaque jury -->
<div class="modal fade" id="membersJuryModal{{ j.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-users me-2"></i>Gestion des membres - Jury {{ j.id }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Accordéon pour ajouter un membre -->
        <div class="accordion mb-4" id="addMemberAccordion{{ j.id }}">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingAdd{{ j.id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#collapseAdd{{ j.id }}" aria-expanded="false" aria-controls="collapseAdd{{ j.id }}">
                <i class="fa fa-user-plus me-2"></i>Ajouter un membre au jury
              </button>
            </h2>
            <div id="collapseAdd{{ j.id }}" class="accordion-collapse collapse" 
                 aria-labelledby="headingAdd{{ j.id }}" data-bs-parent="#addMemberAccordion{{ j.id }}">
              <div class="accordion-body">
                <form method="post" action="{{ url_for('admin_jury_membre_add', jury_id=j.id) }}">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Utilisateur</label>
                      <select class="form-select" name="utilisateur_id" required>
                        <option value="">— Sélectionnez un utilisateur —</option>
                        {% for user in users %}
                          {% set already_member = j.membres | selectattr('utilisateur_id', 'equalto', user.id) | list %}
                          {% if not already_member %}
                            <option value="{{ user.id }}">{{ user.nom_complet }} ({{ user.email }})</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Rôle dans le jury</label>
                      <select class="form-select" name="role" required>
                        <option value="">— Sélectionnez un rôle —</option>
                        <option value="president">Président</option>
                        <option value="membre">Membre</option>
                        <option value="rapporteur">Rapporteur</option>
                        <option value="observateur">Observateur</option>
                      </select>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                      <i class="fa fa-plus me-2"></i>Ajouter le membre
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="collapse" 
                            data-bs-target="#collapseAdd{{ j.id }}" aria-expanded="false">
                      Annuler
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Liste des membres existants -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="m-0">Membres du jury ({{ j.membres|length }})</h6>
        </div>
        <div class="users-table-container" style="max-height: 400px;">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Membre</th>
                <th>Rôle</th>
                <th>Email</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if j.membres %}
                {% for membre in j.membres %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      {% if membre.utilisateur.photo_profil %}
                        <img src="{{ membre.utilisateur.photo_profil }}?v={{ membre.utilisateur.id }}" alt="Photo" 
                             class="rounded-circle me-2" width="32" height="32" style="object-fit: cover;">
                      {% else %}
                        <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px;">
                          <i class="fa fa-user text-white"></i>
                        </div>
                      {% endif %}
                      <div>
                        <div class="fw-bold">{{ membre.utilisateur.nom_complet }}</div>
                        <small class="text-muted">{{ membre.utilisateur.role.replace('_', ' ').title() }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ membre.role.replace('_', ' ').title() }}</span>
                  </td>
                  <td>
                    <a href="mailto:{{ membre.utilisateur.email }}" class="text-decoration-none">
                      {{ membre.utilisateur.email }}
                    </a>
                  </td>
                  <td class="text-end">
                    <button class="btn btn-outline-danger btn-sm" onclick="removeMember({{ j.id }}, {{ membre.id }})" title="Retirer">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    <i class="fa fa-users me-2"></i>Aucun membre assigné
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal d'envoi d'invitations pour chaque jury -->
<div class="modal fade" id="invitationsJuryModal{{ j.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-envelope me-2"></i>Envoyer les invitations - Jury {{ j.id }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Accordéon pour les informations du jury -->
        <div class="accordion mb-4" id="juryInfoAccordion{{ j.id }}">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingJuryInfo{{ j.id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#collapseJuryInfo{{ j.id }}" aria-expanded="false" aria-controls="collapseJuryInfo{{ j.id }}">
                <i class="fa fa-info-circle me-2"></i>Informations du jury
              </button>
            </h2>
            <div id="collapseJuryInfo{{ j.id }}" class="accordion-collapse collapse" 
                 aria-labelledby="headingJuryInfo{{ j.id }}" data-bs-parent="#juryInfoAccordion{{ j.id }}">
              <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Programme</label>
                    <div>
                      {% if j.programme %}
                        <span class="badge bg-primary">{{ j.programme.code }}</span>
                        <div class="small text-muted">{{ j.programme.nom }}</div>
                      {% else %}
                        <span class="text-muted">Programme supprimé</span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Date et heure</label>
                    <div class="fw-bold">{{ j.session_le.strftime('%d/%m/%Y') }}</div>
                    <div class="small text-muted">{{ j.session_le.strftime('%H:%M') }}</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Lieu</label>
                    <div>{{ j.lieu or 'Non spécifié' }}</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Statut</label>
                    <div>
                      {% if j.statut == 'planifie' %}
                        <span class="badge bg-warning">
                          <i class="fa fa-clock me-1"></i>Planifié
                        </span>
                      {% elif j.statut == 'en_cours' %}
                        <span class="badge bg-primary">
                          <i class="fa fa-play me-1"></i>En cours
                        </span>
                      {% elif j.statut == 'termine' %}
                        <span class="badge bg-success">
                          <i class="fa fa-check me-1"></i>Terminé
                        </span>
                      {% else %}
                        <span class="badge bg-secondary">{{ j.statut }}</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Accordéon pour les destinataires -->
        <div class="accordion mb-4" id="recipientsAccordion{{ j.id }}">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingRecipients{{ j.id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#collapseRecipients{{ j.id }}" aria-expanded="false" aria-controls="collapseRecipients{{ j.id }}">
                <i class="fa fa-users me-2"></i>Destinataires ({{ j.membres|length }} membre(s))
              </button>
            </h2>
            <div id="collapseRecipients{{ j.id }}" class="accordion-collapse collapse" 
                 aria-labelledby="headingRecipients{{ j.id }}" data-bs-parent="#recipientsAccordion{{ j.id }}">
              <div class="accordion-body">
                {% if j.membres %}
                  <div class="users-table-container" style="max-height: 300px;">
                    <table class="table table-sm">
                      <thead>
                        <tr>
                          <th>Membre</th>
                          <th>Rôle</th>
                          <th>Email</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for membre in j.membres %}
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              {% if membre.utilisateur.photo_profil %}
                                <img src="{{ membre.utilisateur.photo_profil }}?v={{ membre.utilisateur.id }}" alt="Photo" 
                                     class="rounded-circle me-2" width="24" height="24" style="object-fit: cover;">
                              {% else %}
                                <div class="bg-secondary rounded-circle me-2 d-flex align-items-center justify-content-center" 
                                     style="width: 24px; height: 24px;">
                                  <i class="fa fa-user text-white" style="font-size: 10px;"></i>
                                </div>
                              {% endif %}
                              <div>
                                <div class="fw-bold small">{{ membre.utilisateur.nom_complet }}</div>
                                <small class="text-muted">{{ membre.utilisateur.role.replace('_', ' ').title() }}</small>
                              </div>
                            </div>
                          </td>
                          <td>
                            <span class="badge bg-primary small">{{ membre.role.replace('_', ' ').title() }}</span>
                          </td>
                          <td>
                            <small>{{ membre.utilisateur.email }}</small>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="alert alert-warning">
                    <i class="fa fa-exclamation-triangle me-2"></i>Aucun membre assigné au jury. 
                    <a href="#" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#membersJuryModal{{ j.id }}">
                      Ajouter des membres d'abord.
                    </a>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Accordéon pour le contenu de l'email -->
        <div class="accordion" id="emailContentAccordion{{ j.id }}">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingEmailContent{{ j.id }}">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                      data-bs-target="#collapseEmailContent{{ j.id }}" aria-expanded="false" aria-controls="collapseEmailContent{{ j.id }}">
                <i class="fa fa-envelope-open me-2"></i>Contenu de l'invitation
              </button>
            </h2>
            <div id="collapseEmailContent{{ j.id }}" class="accordion-collapse collapse" 
                 aria-labelledby="headingEmailContent{{ j.id }}" data-bs-parent="#emailContentAccordion{{ j.id }}">
              <div class="accordion-body">
                <div class="mb-3">
                  <label class="form-label fw-bold">Objet</label>
                  <div class="form-control-plaintext bg-light p-2 rounded">
                    Invitation au jury - {{ j.programme.code if j.programme else 'Programme' }} - {{ j.session_le.strftime('%d/%m/%Y') }}
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label fw-bold">Message</label>
                  <div class="form-control-plaintext bg-light p-2 rounded" style="min-height: 150px;">
                    <p>Bonjour,</p>
                    <p>Vous êtes invité(e) à participer au jury du programme <strong>{{ j.programme.code if j.programme else 'Programme' }}</strong>.</p>
                    <p><strong>Détails du jury :</strong></p>
                    <ul>
                      <li><strong>Date :</strong> {{ j.session_le.strftime('%d/%m/%Y') }}</li>
                      <li><strong>Heure :</strong> {{ j.session_le.strftime('%H:%M') }}</li>
                      {% if j.lieu %}
                      <li><strong>Lieu :</strong> {{ j.lieu }}</li>
                      {% endif %}
                      {% if j.promotion %}
                      <li><strong>Promotion :</strong> {{ j.promotion.libelle }}</li>
                      {% endif %}
                    </ul>
                    <p>Merci de confirmer votre présence.</p>
                    <p>Cordialement,<br>L'équipe ACD</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        {% if j.membres %}
          <button type="button" class="btn btn-warning" onclick="sendInvitations({{ j.id }})">
            <i class="fa fa-envelope me-2"></i>Envoyer les invitations
          </button>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endfor %}

<script>
  // Auto-réouverture des modals après actions
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const action = urlParams.get('action');
    const juryId = urlParams.get('jury_id');
    
    if (action && juryId) {
      setTimeout(() => {
        if (action === 'add_member' || action === 'remove_member') {
          // Rouvrir le modal de gestion des membres
          const modal = document.getElementById(`membersJuryModal${juryId}`);
          if (modal) {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
          }
        }
      }, 100);
    }

  });

function deleteJury(juryId) {
  if (confirm('Êtes-vous sûr de vouloir supprimer ce jury ? Cette action est irréversible.')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('admin_jury_delete', jury_id='${juryId}') }}`;
    document.body.appendChild(form);
    form.submit();
  }
}

function removeMember(juryId, membreId) {
  if (confirm('Êtes-vous sûr de vouloir retirer ce membre du jury ?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('admin_jury_membre_delete', jury_id='${juryId}', membre_id='${membreId}') }}`;
    document.body.appendChild(form);
    form.submit();
  }
}

function sendInvitations(juryId) {
  if (confirm('Envoyer les invitations par email à tous les membres du jury ?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `{{ url_for('admin_jury_send_invitations', jury_id='${juryId}') }}`;
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}
