{% extends "admin/base_admin.html" %}

{% block admin_content %}
<style>
/* Correction de la visibilité des onglets */
.nav-tabs .nav-link {
  color: #495057 !important;
  background-color: #f8f9fa !important;
  border: 1px solid #dee2e6 !important;
  border-top-left-radius: 0.25rem !important;
  border-top-right-radius: 0.25rem !important;
  padding: 0.5rem 1rem !important;
  margin-bottom: -1px !important;
  font-weight: 500 !important;
  opacity: 1 !important;
  visibility: visible !important;
}

.nav-tabs .nav-link:hover {
  color: #495057 !important;
  background-color: #e9ecef !important;
  border-color: #dee2e6 #dee2e6 #fff !important;
}

.nav-tabs .nav-link.active {
  color: #495057 !important;
  background-color: #fff !important;
  border-color: #dee2e6 #dee2e6 #fff !important;
  border-bottom: 1px solid #fff !important;
}

.nav-tabs {
  border-bottom: 1px solid #dee2e6 !important;
  display: flex !important;
  flex-wrap: wrap !important;
  padding-left: 0 !important;
  margin-bottom: 0 !important;
  list-style: none !important;
}

.nav-tabs .nav-item {
  margin-bottom: -1px !important;
}

.tab-content {
  border: 1px solid #dee2e6 !important;
  border-top: none !important;
  padding: 1rem !important;
  background-color: #fff !important;
}

/* Styles pour la matrice des permissions */
.permissions-matrix-container {
  overflow-x: auto;
  max-width: 100%;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

.permissions-matrix-container table {
  min-width: 800px;
  margin-bottom: 0;
}

.permissions-matrix-container th:first-child,
.permissions-matrix-container td:first-child {
  position: sticky;
  left: 0;
  background-color: #eeeff0;
  z-index: 10;
  min-width: 150px;
}

.permissions-matrix-container td:first-child {
  background-color: white;
  border-right: 2px solid #dee2e6;
}
</style>

<div class="card-neumo p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="m-0">
      <i class="fa fa-shield me-2"></i>Gestion des permissions
    </h5>
    <div class="text-muted small">
      <i class="fa fa-info-circle me-1"></i>Matrice des droits d'accès
    </div>
  </div>

  <!-- Messages de succès/erreur -->
  {% if request.query_params.get('success') %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      {% if request.query_params.get('success') == 'permission_granted' %}
        <i class="fa fa-check-circle me-2"></i>Permission accordée avec succès
      {% elif request.query_params.get('success') == 'permission_revoked' %}
        <i class="fa fa-check-circle me-2"></i>Permission révoquée avec succès
      {% elif request.query_params.get('success') == 'role_permission_updated' %}
        <i class="fa fa-check-circle me-2"></i>Permission de rôle modifiée avec succès
      {% endif %}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  {% if request.query_params.get('error') %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      {% if request.query_params.get('error') == 'permission_grant_failed' %}
        <i class="fa fa-exclamation-circle me-2"></i>Échec de l'octroi de permission
      {% elif request.query_params.get('error') == 'permission_revoke_failed' %}
        <i class="fa fa-exclamation-circle me-2"></i>Échec de la révocation de permission
      {% elif request.query_params.get('error') == 'role_permission_update_failed' %}
        <i class="fa fa-exclamation-circle me-2"></i>Échec de la modification de permission de rôle
      {% endif %}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}

  <!-- Onglets -->
  <ul class="nav nav-tabs mb-4" id="permissionsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="matrix-tab" data-bs-toggle="tab" data-bs-target="#matrix" type="button" role="tab">
        <i class="fa fa-table me-2"></i>Matrice des rôles
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-matrix-tab" data-bs-toggle="tab" data-bs-target="#edit-matrix" type="button" role="tab">
        <i class="fa fa-edit me-2"></i>Modifier les droits
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
        <i class="fa fa-users me-2"></i>Permissions utilisateurs
      </button>
    </li>
  </ul>

  <div class="tab-content" id="permissionsTabsContent">
    <!-- Matrice des rôles -->
    <div class="tab-pane fade show active" id="matrix" role="tabpanel">
      <div class="permissions-matrix-container">
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Rôle</th>
              {% for resource in resource_types %}
                <th class="text-center">{{ resource.value.replace('_', ' ').title() }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for role, permissions in permission_matrix.items() %}
            <tr>
              <td class="fw-bold">{{ role.replace('_', ' ').title() }}</td>
              {% for resource in resource_types %}
                <td class="text-center">
                  {% set permission = permissions.get(resource) %}
                  {% if permission %}
                    {% if permission.value == 'lecture' %}
                      <span class="badge bg-info">Lecture</span>
                    {% elif permission.value == 'ecriture' %}
                      <span class="badge bg-primary">Écriture</span>
                    {% elif permission.value == 'suppression' %}
                      <span class="badge bg-warning">Suppression</span>
                    {% elif permission.value == 'admin' %}
                      <span class="badge bg-danger">Admin</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modification des droits -->
    <div class="tab-pane fade" id="edit-matrix" role="tabpanel">
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Rôle</label>
          <select class="form-select" id="editRoleSelect">
            <option value="">— Sélectionnez un rôle —</option>
            {% for role in all_roles %}
              <option value="{{ role }}">{{ role.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ressource</label>
          <select class="form-select" id="editResourceSelect">
            <option value="">— Sélectionnez une ressource —</option>
            {% for resource in resource_types %}
              <option value="{{ resource.value }}">{{ resource.value.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Niveau de permission</label>
          <select class="form-select" id="editPermissionSelect">
            <option value="">— Sélectionnez un niveau —</option>
            {% for level in permission_levels %}
              <option value="{{ level.value }}">{{ level.value.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-8">
          <label class="form-label">Raison (optionnel)</label>
          <input type="text" class="form-control" id="editReasonInput" placeholder="Raison de la modification">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-warning w-100" onclick="updateRolePermission()">
            <i class="fa fa-save me-2"></i>Modifier le droit
          </button>
        </div>
      </div>

      <!-- Matrice éditable -->
      <div class="permissions-matrix-container">
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Rôle</th>
              {% for resource in resource_types %}
                <th class="text-center">{{ resource.value.replace('_', ' ').title() }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for role in all_roles %}
            <tr>
              <td class="fw-bold">{{ role.replace('_', ' ').title() }}</td>
              {% for resource in resource_types %}
                <td class="text-center">
                  {% set permission = permission_matrix.get(role, {}).get(resource) %}
                  <select class="form-select form-select-sm"
                          onchange="updatePermissionFromTable('{{ role }}', '{{ resource.value }}', this.value)">
                    <option value="">—</option>
                    {% for level in permission_levels %}
                      <option value="{{ level.value }}"
                              {% if permission and permission.value == level.value %}selected{% endif %}>
                        {{ level.value.replace('_', ' ').title() }}
                      </option>
                    {% endfor %}
                  </select>
                </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Permissions utilisateurs -->
    <div class="tab-pane fade" id="users" role="tabpanel">
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <label class="form-label">Utilisateur</label>
          <select class="form-select" id="userSelect">
            <option value="">— Sélectionnez un utilisateur —</option>
            {% for user in users %}
              <option value="{{ user.id }}">{{ user.nom_complet }} ({{ user.email }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ressource</label>
          <select class="form-select" id="resourceSelect">
            <option value="">— Sélectionnez une ressource —</option>
            {% for resource in resource_types %}
              <option value="{{ resource.value }}">{{ resource.value.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Niveau de permission</label>
          <select class="form-select" id="permissionLevelSelect">
            <option value="">— Sélectionnez un niveau —</option>
            {% for level in permission_levels %}
              <option value="{{ level.value }}">{{ level.value.replace('_', ' ').title() }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-8">
          <label class="form-label">Raison (optionnel)</label>
          <input type="text" class="form-control" id="reasonInput" placeholder="Raison de l'octroi/révocation">
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button class="btn btn-success me-2" onclick="grantPermission()">
            <i class="fa fa-plus-circle me-2"></i>Accorder
          </button>
          <button class="btn btn-danger" onclick="revokePermission()">
            <i class="fa fa-minus-circle me-2"></i>Révoquer
          </button>
        </div>
      </div>

      <h6 class="mt-5 mb-3">Permissions spécifiques des utilisateurs</h6>
      <div class="permissions-matrix-container">
        <table class="table table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Utilisateur</th>
              <th>Ressource</th>
              <th>Niveau</th>
              <th>Accordé par</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les permissions spécifiques des utilisateurs seront chargées ici via JS ou une autre route si nécessaire -->
            <tr>
              <td colspan="6" class="text-center text-muted">Aucune permission spécifique définie pour l'instant.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function grantPermission() {
  const userId = document.getElementById('userSelect').value;
  const resource = document.getElementById('resourceSelect').value;
  const permission = document.getElementById('permissionLevelSelect').value;
  const reason = document.getElementById('reasonInput').value;

  if (!userId || !resource || !permission) {
    alert('Veuillez sélectionner un utilisateur, une ressource et un niveau de permission');
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for('admin_grant_permission') }}';

  const fields = {
    'target_user_id': userId,
    'resource': resource,
    'permission_level': permission,
    'reason': reason
  };

  for (const [name, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    form.appendChild(input);
  }

  document.body.appendChild(form);
  form.submit();
}

function revokePermission() {
  const userId = document.getElementById('userSelect').value;
  const resource = document.getElementById('resourceSelect').value;
  const reason = document.getElementById('reasonInput').value;

  if (!userId || !resource) {
    alert('Veuillez sélectionner un utilisateur et une ressource');
    return;
  }

  if (!confirm('Êtes-vous sûr de vouloir révoquer cette permission ?')) {
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for('admin_revoke_permission') }}';

  const fields = {
    'target_user_id': userId,
    'resource': resource,
    'reason': reason
  };

  for (const [name, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    form.appendChild(input);
  }

  document.body.appendChild(form);
  form.submit();
}

function updateRolePermission() {
  const role = document.getElementById('editRoleSelect').value;
  const resource = document.getElementById('editResourceSelect').value;
  const permission = document.getElementById('editPermissionSelect').value;
  const reason = document.getElementById('editReasonInput').value;

  if (!role || !resource || !permission) {
    alert('Veuillez remplir tous les champs obligatoires');
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for('admin_update_role_permission') }}';

  const fields = {
    'role': role,
    'resource': resource,
    'permission_level': permission,
    'reason': reason
  };

  for (const [name, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    form.appendChild(input);
  }

  document.body.appendChild(form);
  form.submit();
}

function updatePermissionFromTable(role, resource, permission) {
  if (!permission) {
    return; // Ne rien faire si aucune permission sélectionnée
  }

  if (!confirm(`Modifier la permission ${role.replace('_', ' ').title()} sur ${resource.replace('_', ' ').title()} vers ${permission.replace('_', ' ').title()} ?`)) {
    // Recharger la page pour annuler le changement
    location.reload();
    return;
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for('admin_update_role_permission') }}';

  const fields = {
    'role': role,
    'resource': resource,
    'permission_level': permission,
    'reason': 'Modification directe depuis la matrice'
  };

  for (const [name, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    form.appendChild(input);
  }

  document.body.appendChild(form);
  form.submit();
}

// Auto-dismiss alerts after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    setTimeout(() => {
      const bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    }, 5000); // 5000 ms = 5 secondes
  });
});
</script>
{% endblock %}