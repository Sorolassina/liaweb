{% extends "base.html" %}

{% block title %}Nouveau Cycle - {{ super() }}{% endblock %}

{% block head_extra %}
<style>
  .form-container {
    margin: 0 auto;
    padding: 20px;
    width: 100%;
  }
  
  .form-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--primary-color);
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }
  
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
  }
  
  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }
  
  .form-card h2 {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 1rem;
    position: sticky;
    top: 0;
    background: white;
    padding: 10px 0;
    z-index: 10;
    border-bottom: 2px solid #f0f0f0;
  }
  
  
        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
        }
        
        /* Styles pour les onglets */
        .tabs-container {
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          overflow: hidden;
        }
        
        .tabs-nav {
          display: flex;
          background: #f8f9fa;
          border-bottom: 1px solid #e9ecef;
        }
        
        .tab-btn {
          flex: 1;
          background: none;
          border: none;
          padding: 15px 20px;
          cursor: pointer;
          font-size: 0.9rem;
          font-weight: 500;
          color: #6c757d;
          transition: all 0.3s ease;
          border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
          background: #e9ecef;
          color: var(--primary-color);
        }
        
        .tab-btn.active {
          background: white;
          color: var(--primary-color);
          border-bottom-color: var(--primary-color);
        }
        
        .tab-btn i {
          margin-right: 8px;
        }
        
        .tab-content {
          display: none;
          padding: 30px;
          min-height: 300px;
        }
        
        .tab-content.active {
          display: block;
        }
  
  .btn-submit {
    background: linear-gradient(135deg, var(--primary-color) 0%, #e6b800 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .btn-submit:hover {
    transform: translateY(-2px);
  }
  
  .btn-cancel {
    background: #6c757d;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    margin-right: 10px;
  }
  
  .alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <div class="form-card">
    <h2 class="text-center mb-4">
      <i class="fas fa-plus-circle"></i> Nouveau Cycle
    </h2>
    
    {% if error %}
    <div class="alert alert-error">
      <i class="fas fa-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}
    
    {% if success %}
    <div class="alert alert-success">
      <i class="fas fa-check-circle"></i> {{ success }}
    </div>
    {% endif %}
    
        <form method="post" action="{{ url_for('codev_cycles_creer_post') }}">
          
          <!-- Onglets -->
          <div class="tabs-container">
            <div class="tabs-nav">
              <button type="button" class="tab-btn active" data-tab="general">
                <i class="fas fa-info-circle"></i> Informations générales
              </button>
              <button type="button" class="tab-btn" data-tab="config">
                <i class="fas fa-cog"></i> Configuration
              </button>
              <button type="button" class="tab-btn" data-tab="planning">
                <i class="fas fa-calendar-alt"></i> Planning
              </button>
              <button type="button" class="tab-btn" data-tab="objectifs">
                <i class="fas fa-target"></i> Objectifs
              </button>
            </div>
            
            <!-- Onglet Informations générales -->
            <div class="tab-content active" id="general">
              <div class="form-group">
                <label for="nom">Nom du cycle *</label>
                <input type="text" id="nom" name="nom" required 
                       placeholder="Ex: Cycle Codéveloppement ACD 2024" 
                       value="{{ request.form.nom if request.form.nom else '' }}">
              </div>
              
              <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" 
                          placeholder="Décrivez les objectifs et le contexte de ce cycle...">{{ request.form.description if request.form.description else '' }}</textarea>
              </div>
            </div>
            
            <!-- Onglet Configuration -->
            <div class="tab-content" id="config">
              <div class="form-row">
                <div class="form-group">
                  <label for="programme_id">Programme *</label>
                  <select id="programme_id" name="programme_id" required>
                    <option value="">Sélectionner un programme</option>
                    {% for programme in programmes %}
                    <option value="{{ programme.id }}" 
                            {% if request.form.programme_id and request.form.programme_id|int == programme.id %}selected{% endif %}>
                      {{ programme.nom }} ({{ programme.code }})
                    </option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="promotion_id">Promotion</label>
                  <select id="promotion_id" name="promotion_id">
                    <option value="">Sélectionner une promotion (optionnel)</option>
                    {% for promotion in promotions %}
                    <option value="{{ promotion.id }}" 
                            {% if request.form.promotion_id and request.form.promotion_id|int == promotion.id %}selected{% endif %}>
                      {{ promotion.nom }}
                    </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label for="animateur_principal_id">Animateur principal</label>
                <select id="animateur_principal_id" name="animateur_principal_id">
                  <option value="">Sélectionner un animateur (optionnel)</option>
                  {% for animateur in animateurs %}
                  <option value="{{ animateur.id }}" 
                          {% if request.form.animateur_principal_id and request.form.animateur_principal_id|int == animateur.id %}selected{% endif %}>
                    {{ animateur.nom_complet }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            
            <!-- Onglet Planning -->
            <div class="tab-content" id="planning">
              <div class="form-row">
                <div class="form-group">
                  <label for="date_debut">Date de début *</label>
                  <input type="date" id="date_debut" name="date_debut" required 
                         value="{{ request.form.date_debut if request.form.date_debut else '' }}">
                </div>
                
                <div class="form-group">
                  <label for="date_fin">Date de fin *</label>
                  <input type="date" id="date_fin" name="date_fin" required 
                         value="{{ request.form.date_fin if request.form.date_fin else '' }}">
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group">
                  <label for="nombre_seances_prevues">Nombre de séances prévues</label>
                  <input type="number" id="nombre_seances_prevues" name="nombre_seances_prevues" 
                         min="1" max="20" value="{{ request.form.nombre_seances_prevues if request.form.nombre_seances_prevues else '6' }}">
                </div>
                
                <div class="form-group">
                  <label for="duree_seance_minutes">Durée par séance (minutes)</label>
                  <input type="number" id="duree_seance_minutes" name="duree_seance_minutes" 
                         min="60" max="480" value="{{ request.form.duree_seance_minutes if request.form.duree_seance_minutes else '180' }}">
                </div>
              </div>
            </div>
            
            <!-- Onglet Objectifs -->
            <div class="tab-content" id="objectifs">
              <div class="form-group">
                <label for="objectifs_cycle">Objectifs du cycle</label>
                <textarea id="objectifs_cycle" name="objectifs_cycle" 
                          placeholder="Décrivez les objectifs spécifiques de ce cycle...">{{ request.form.objectifs_cycle if request.form.objectifs_cycle else '' }}</textarea>
              </div>
            </div>
          </div>
      
      <div class="text-center mt-4">
        <a href="{{ url_for('codev_dashboard') }}" class="btn-cancel">
          <i class="fas fa-arrow-left"></i> Annuler
        </a>
        <button type="submit" class="btn-submit">
          <i class="fas fa-save"></i> Créer le cycle
        </button>
      </div>
    </form>
  </div>
</div>


<script>
// Gestion des onglets
document.addEventListener('DOMContentLoaded', function() {
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      // Retirer la classe active de tous les boutons et contenus
      tabBtns.forEach(b => b.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      // Ajouter la classe active au bouton cliqué et au contenu correspondant
      this.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
    });
  });
});

// Validation côté client
document.querySelector('form').addEventListener('submit', function(e) {
  const dateDebut = document.getElementById('date_debut').value;
  const dateFin = document.getElementById('date_fin').value;
  
  if (dateDebut && dateFin && new Date(dateDebut) >= new Date(dateFin)) {
    e.preventDefault();
    alert('La date de fin doit être postérieure à la date de début.');
    return false;
  }
  
  const nombreSeances = parseInt(document.getElementById('nombre_seances_prevues').value);
  if (nombreSeances < 1 || nombreSeances > 20) {
    e.preventDefault();
    alert('Le nombre de séances doit être entre 1 et 20.');
    return false;
  }
});

// Auto-remplissage de la date de fin basée sur le nombre de séances
document.getElementById('nombre_seances_prevues').addEventListener('change', function() {
  const dateDebut = document.getElementById('date_debut').value;
  const nombreSeances = parseInt(this.value);
  
  if (dateDebut && nombreSeances) {
    const dateDebutObj = new Date(dateDebut);
    // Ajouter 2 semaines par séance (1 séance toutes les 2 semaines)
    const dateFinObj = new Date(dateDebutObj.getTime() + (nombreSeances * 2 * 7 * 24 * 60 * 60 * 1000));
    document.getElementById('date_fin').value = dateFinObj.toISOString().split('T')[0];
  }
});
</script>
{% endblock %}
