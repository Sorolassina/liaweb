{% extends "base.html" %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  /* Container adaptatif qui tient compte de la sidebar */
  .container-wide{ 
    width: 100%; 
    max-width: calc(100vw - var(--sidebar-width) - 2rem); 
    margin: 0 auto; 
    padding: 0 1rem;
  }
  
  /* Responsive pour sidebar r√©duite */
  .sidebar.collapsed ~ #content .container-wide {
    max-width: calc(100vw - var(--sidebar-width-collapsed) - 2rem);
  }
  
  /* Responsive mobile */
  @media (max-width: 768px) {
    .container-wide {
      max-width: calc(100vw - 2rem);
      padding: 0 0.5rem;
    }
  }

  .card-neumo{ 
    background: var(--white-color); 
    border-radius: 18px; 
    box-shadow: var(--shadow);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 8%, transparent);
    transition: transform .2s ease, box-shadow .2s ease; 
  }
  .card-neumo:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  
  .section-title{ 
    color: var(--secondary-color); 
    font-weight: 900; 
    margin: 0 0 0.8rem; 
    font-size: 1.1rem;
  }
  
  /* Grille KPI adaptative */
  .kpi-grid{ 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
    gap: 10px; 
  }
  
  @media (max-width: 1200px){ 
    .kpi-grid{ grid-template-columns: repeat(4, 1fr);} 
  }
  @media (max-width: 680px){ 
    .kpi-grid{ grid-template-columns: repeat(3, 1fr);} 
  }
  @media (max-width: 430px){ 
    .kpi-grid{ grid-template-columns: repeat(2, 1fr);} 
  }
  
  .kpi{ 
    padding: 12px 10px; 
    text-align: center; 
    border-radius: 12px; 
    box-shadow: var(--shadow-sm); 
    background: var(--white-color); 
  }
  .kpi .val{ 
    font-weight: 900; 
    font-size: 1.6rem; 
    line-height: 1; 
    color: var(--primary-color); 
  }
  .kpi .lab{ 
    margin-top: 3px; 
    color: var(--gray-dark); 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: .3px; 
    font-size: .75rem; 
  }
  
  /* Carte adaptative */
  #map{ 
    width: 100%; 
    height: 380px; 
    border-radius: 18px; 
    box-shadow: var(--shadow);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 10%, transparent); 
  }
  
  /* Grilles adaptatives */
  .grid-2{ 
    display: grid; 
    grid-template-columns: 1.2fr 0.8fr; 
    gap: 16px; 
  }
  @media (max-width: 1200px){ 
    .grid-2{ grid-template-columns: 1fr 1fr; } 
  }
  @media (max-width: 992px){ 
    .grid-2{ grid-template-columns: 1fr; } 
  }
  
  .grid-2h{ 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
  }
  @media (max-width: 992px){ 
    .grid-2h{ grid-template-columns: 1fr; } 
  }
  
  /* Listes adaptatives */
  .list-group-soft{ 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    padding: 4px 0; 
  }
  .list-item{ 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 10px;
    padding: 10px 12px; 
    border-radius: 12px; 
    background: var(--white-color); 
    box-shadow: var(--shadow-sm);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 8%, transparent); 
  }
  .list-item .meta{ 
    color: var(--gray-dark); 
    font-size: .9rem; 
  }
  
  /* Barres de progression */
  .progress-soft{ 
    width: 100%; 
    height: 10px; 
    border-radius: 999px; 
    background: var(--gray-light);
    box-shadow: inset 2px 2px 5px rgba(0,0,0,.06), inset -2px -2px 5px rgba(255,255,255,.8); 
    overflow: hidden; 
  }
  .progress-soft > span{ 
    display: block; 
    height: 100%; 
    background: var(--primary-color); 
    transition: width .4s ease; 
  }
  
  .badge-chip{ 
    border-radius: 999px; 
    padding: .25rem .55rem; 
    font-weight: 800; 
    font-size: .75rem;
    background: color-mix(in srgb, var(--primary-color) 16%, transparent);
    border: 1px solid color-mix(in srgb, var(--primary-color) 35%, transparent); 
    color: var(--secondary-color); 
  }
  
  .chart-card{ 
    padding: 12px; 
  }
  
  /* Espacement adaptatif */
  .mb-3 {
    margin-bottom: 1rem;
  }
  
  .p-3 {
    padding: 1rem;
  }
  
  .mt-2 {
    margin-top: 0.5rem;
  }
  
  .mt-1 {
    margin-top: 0.25rem;
  }
  
  /* Responsive pour les petits √©crans */
  @media (max-width: 576px) {
    .section-title {
      font-size: 1rem;
    }
    
    .kpi .val {
      font-size: 1.5rem;
    }
    
    .kpi .lab {
      font-size: .75rem;
    }
    
    #map {
      height: 300px;
    }
    
    .list-item {
      padding: 8px 10px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-wide">

  <!-- KPIs -->
  <div class="card-neumo p-3 mb-3">
    <h3 class="section-title">Vue d'ensemble</h3>
    <div class="kpi-grid">
      <div class="kpi"><div class="val">{{ kpi.preinscrits }}</div><div class="lab">Pr√©inscrits</div></div>
      <div class="kpi"><div class="val">{{ kpi.valides }}</div><div class="lab">Valid√©s</div></div>
      <div class="kpi"><div class="val">{{ kpi.reorientes }}</div><div class="lab">R√©orient√©s</div></div>
      <div class="kpi"><div class="val">{{ kpi.rejetes }}</div><div class="lab">Rejet√©s</div></div>
      <div class="kpi"><div class="val">{{ kpi.en_attente }}</div><div class="lab">En attente</div></div>
      <div class="kpi"><div class="val">{{ kpi.qpv }}</div><div class="lab">QPV</div></div>
      <div class="kpi"><div class="val">{{ kpi.qpv_limite }}</div><div class="lab">QPV Limite</div></div>
    </div>
  </div>

  <!-- Carte + Jurys -->
  <div class="grid-2 mb-3">
    <div class="card-neumo p-3">
      <h3 class="section-title">Couverture g√©ographique</h3>
      <div id="map"></div>
      <div class="mt-2" style="display:flex; gap:8px; flex-wrap:wrap;">
        <!-- <span class="badge-chip">üìç Candidats</span> -->
        <span class="badge-chip">üü° QPV</span>
        <span class="badge-chip">üü† QPV Limite</span>
        <!-- <span class="badge-chip">üîµ Femmes</span> -->
        <!-- <span class="badge-chip">‚ö´ Hommes</span> -->
      </div>
    </div>

    <div class="card-neumo p-3">
      <h3 class="section-title">Prochains √©v√©nements (Jury)</h3>
      <div class="list-group-soft">
        {% if jurys %}
          {% for j in jurys %}
          <div class="list-item">
            <div>
              <div style="font-weight:800">Jury {{ j.programme.code }}{% if j.promotion and j.promotion.libelle %} ‚Ä¢ {{ j.promotion.libelle }}{% endif %}</div>
              <div class="meta">{{ j.session_le.astimezone().strftime("%d/%m/%Y %H:%M") }} ‚Ä¢ {{ j.lieu or "‚Äî" }} ‚Ä¢ {{ j.statut|capitalize }}</div>
            </div>
            <span class="badge-chip">Jury</span>
          </div>
          {% endfor %}
        {% else %}
          <div class="list-item"><div class="meta">Aucun jury planifi√©</div></div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Histogramme & Pyramide -->
  <div class="grid-2h mb-3">
    <div class="card-neumo chart-card">
      <h3 class="section-title">R√©partition par programme (inscriptions)</h3>
      <canvas id="chartProgrammes" height="220"></canvas>
    </div>
    <div class="card-neumo chart-card">
      <h3 class="section-title">Pyramide des √¢ges</h3>
      <canvas id="chartPyramid" height="220"></canvas>
    </div>
  </div>

  <!-- RDV & Objectifs -->
  <div class="grid-2 mb-3">
    <div class="card-neumo p-3">
      <h3 class="section-title">Rendez-vous √† venir</h3>
      <div class="list-group-soft">
        {% if rdvs %}
          {% for r in rdvs %}
          <div class="list-item">
            <div>
              <div style="font-weight:800">{{ r.when.strftime("%d/%m/%Y %H:%M") }} ‚Ä¢ {{ r.etape }}</div>
              <div class="meta">{{ r.candidat }} ‚Ä¢ {{ r.programme }}</div>
            </div>
            <span class="badge-chip">RDV</span>
          </div>
          {% endfor %}
        {% else %}
          <div class="list-item"><div class="meta">Aucun rendez-vous planifi√©</div></div>
        {% endif %}
      </div>
    </div>

    <div class="card-neumo p-3">
      <h3 class="section-title">Atteinte des objectifs par programme</h3>
      <div class="list-group-soft">
        {% for o in objectifs %}
        <div class="list-item" style="flex-direction:column; align-items:stretch;">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div style="font-weight:900">{{ o.programme }}</div>
            <div class="meta">{{ o.n }} inscrits</div>
          </div>

          {% if o.target_total %}
          <div class="meta mt-1">Total (objectif {{ o.target_total }}) ‚Äî {{ o.total_pct or 0 }}%</div>
          <div class="progress-soft"><span style="width: {{ (o.total_pct or 0) | round(1) }}%"></span></div>
          {% endif %}

          {% if o.target_qpv is not none %}
          <div class="meta mt-1">QPV (cible {{ o.target_qpv | round(0) }}%) ‚Äî {{ o.qpv_pct }}%</div>
          <div class="progress-soft"><span style="width: {{ [o.qpv_objectif_atteint, 100] | min | round(1) }}%"></span></div>
          {% endif %}

          {% if o.target_f is not none %}
          <div class="meta mt-1">Femmes (cible {{ o.target_f | round(0) }}%) ‚Äî {{ o.f_pct }}%</div>
          <div class="progress-soft"><span style="width: {{ [o.f_objectif_atteint, 100] | min | round(1) }}%"></span></div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>

<!-- Leaflet + Charts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
  const PINS = {{ pins | tojson }};
  const PROG_LABELS = {{ prog_labels | tojson }};
  const PROG_VALUES = {{ prog_values | tojson }};
  const PYR_LABELS = {{ pyramid_labels | tojson }};
  const PYR_MALE = {{ pyramid_male | tojson }};
  const PYR_FEMALE = {{ pyramid_female | tojson }};

  // Carte
  (function(){
    const map = L.map('map', { scrollWheelZoom: false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 18, attribution: '&copy; OpenStreetMap' }).addTo(map);
    const markers = [];
    PINS.forEach(p => {
      // D√©terminer la couleur du pin selon le statut QPV
      let pinColor = '#3388ff'; // Bleu par d√©faut (Non QPV)
      let qpv_status = "‚ö™ Non QPV";
      
      if (p.qpv) {
        pinColor = '#ffd700'; // Jaune pour QPV
        qpv_status = "üü° QPV";
      } else if (p.qpv_limite) {
        pinColor = '#ff8c00'; // Orange pour QPV Limite
        qpv_status = "üü† QPV Limite";
      }
      
      // Cr√©er une ic√¥ne Leaflet color√©e
      const coloredIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      
      // Modifier la couleur de l'ic√¥ne
      if (p.qpv) {
        coloredIcon.options.iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
      } else if (p.qpv_limite) {
        coloredIcon.options.iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
      }
      
      const m = L.marker([p.lat, p.lng], { icon: coloredIcon }).addTo(map);
      
      const sx = p.sexe === "F" ? "üîµ Femme" : (p.sexe === "H" ? "‚ö´ Homme" : "‚Ä¢");
      m.bindPopup(`<div style="font-weight:800">${(p.prenom||"")} ${(p.nom||"")}</div>
                   <div style="font-size:.9rem; opacity:.8">${p.adresse||""}</div>
                   <div style="font-size:.9rem;">${qpv_status} ‚Ä¢ ${sx}</div>`);
      markers.push(m);
    });
    if (markers.length){
      const g = L.featureGroup(markers);
      map.fitBounds(g.getBounds().pad(0.2));
    } else {
      map.setView([46.7, 2.5], 5);
    }
  })();

  // Charts
  (function(){
    // Graphique des programmes
    new Chart(document.getElementById('chartProgrammes'), {
      type: 'bar',
      data: { 
        labels: PROG_LABELS, 
        datasets: [{ 
          label: 'Inscriptions', 
          data: PROG_VALUES, 
          borderWidth: 1,
          backgroundColor: '#e3f2fd',
          borderColor: '#1976d2'
        }] 
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false }, 
          tooltip: { mode: 'index', intersect: false }
        },
        scales: { 
          x: { ticks: { autoSkip: true, maxRotation: 0 } }, 
          y: { 
            beginAtZero: true, 
            ticks: { precision: 0 },
            suggestedMax: Math.max(...PROG_VALUES) + 2
          } 
        }
      },
      plugins: [{
        id: 'datalabels',
        afterDatasetsDraw: (chart) => {
          const ctx = chart.ctx;
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            meta.data.forEach((bar, index) => {
              const data = dataset.data[index];
              ctx.fillStyle = '#333';
              ctx.font = 'bold 12px Arial';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText(data, bar.x, bar.y - 5);
            });
          });
        }
      }]
    });

    // Pyramide des √¢ges
    new Chart(document.getElementById('chartPyramid'), {
      type: 'bar',
      data: { 
        labels: PYR_LABELS, 
        datasets: [
          { 
            label:'Hommes', 
            data: PYR_MALE, // Valeurs n√©gatives pour les hommes (gauche)
            borderWidth: 1,
            backgroundColor: '#90caf9',
            borderColor: '#1976d2'
          },
          { 
            label:'Femmes', 
            data: PYR_FEMALE, // Valeurs positives pour les femmes (droite)
            borderWidth: 1,
            backgroundColor: '#f8bbd9',
            borderColor: '#e91e63'
          }
        ]
      },
      options:{
        indexAxis:'y', 
        responsive:true,
        plugins:{ 
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${Math.abs(ctx.parsed.x)}` } }
        },
        scales:{ 
          x:{ 
            stacked:false, // Pas de stacking pour une vraie pyramide
            ticks:{ 
              callback:(v)=>Math.abs(v), 
              precision:0 
            },
            suggestedMax: Math.max(...PYR_MALE.map(Math.abs), ...PYR_FEMALE.map(Math.abs)) + 1,
            suggestedMin: -(Math.max(...PYR_MALE.map(Math.abs), ...PYR_FEMALE.map(Math.abs)) + 1)
          }, 
          y:{ stacked:false }
        }
      },
      plugins: [{
        id: 'datalabels',
        afterDatasetsDraw: (chart) => {
          const ctx = chart.ctx;
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            meta.data.forEach((bar, index) => {
              const data = Math.abs(dataset.data[index]);
              if (data > 0) { // Afficher seulement si > 0
                ctx.fillStyle = '#333';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Positionner l'√©tiquette au centre de la barre
                const x = bar.x;
                const y = bar.y;
                ctx.fillText(data, x, y);
              }
            });
          });
        }
      }]
    });
  })();
</script>
{% endblock %}
