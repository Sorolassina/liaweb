{% extends "base.html" %}
{% block head_extra %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  /* Container adaptatif qui tient compte de la sidebar */
  .container-wide{ 
    width: 100%; 
    max-width: calc(100vw - var(--sidebar-width) - 2rem); 
    margin: 0 auto; 
    padding: 0 1rem;
  }
  
  /* Responsive pour sidebar r√©duite */
  .sidebar.collapsed ~ #content .container-wide {
    max-width: calc(100vw - var(--sidebar-width-collapsed) - 2rem);
  }
  
  /* Responsive mobile */
  @media (max-width: 768px) {
    .container-wide {
      max-width: calc(100vw - 2rem);
      padding: 0 0.5rem;
    }
  }

  .title-wrap{ 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 12px; 
    flex-wrap: wrap; 
  }
  
  .card-neumo{
    background: var(--white-color); 
    border-radius: 18px; 
    box-shadow: var(--shadow);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 8%, transparent);
    transition: transform .2s ease, box-shadow .2s ease;
  }
  .card-neumo:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); }
  
  .section-title{ 
    color: var(--secondary-color); 
    font-weight: 900; 
    margin: 0 0 0.8rem; 
    font-size: 1.1rem;
  }
  
  /* Grille KPI adaptative */
  .kpi-grid{ 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
    gap: 12px; 
  }
  @media (max-width: 1200px){ 
    .kpi-grid{ grid-template-columns: repeat(3, 1fr);} 
  }
  @media (max-width: 680px){ 
    .kpi-grid{ grid-template-columns: repeat(2, 1fr);} 
  }
  @media (max-width: 430px){ 
    .kpi-grid{ grid-template-columns: 1fr;} 
  }
  
  .kpi{ 
    padding: 16px 14px; 
    text-align: center; 
    border-radius: 14px; 
    box-shadow: var(--shadow-sm); 
    background: var(--white-color); 
  }
  .kpi .val{ 
    font-weight: 900; 
    font-size: 1.8rem; 
    color: var(--primary-color); 
    line-height: 1; 
  }
  .kpi .lab{ 
    margin-top: 4px; 
    color: var(--gray-dark); 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: .4px; 
    font-size: .82rem; 
  }
  
  /* Carte adaptative */
  #map{ 
    width: 100%; 
    height: 380px; 
    border-radius: 18px; 
    box-shadow: var(--shadow); 
    border: 1px solid color-mix(in srgb, var(--secondary-color) 10%, transparent); 
  }
  
  /* Grilles adaptatives */
  .grid-2{ 
    display: grid; 
    grid-template-columns: 1.2fr 0.8fr; 
    gap: 16px; 
  } 
  @media (max-width: 1200px){ 
    .grid-2{ grid-template-columns: 1fr 1fr; } 
  }
  @media (max-width: 992px){ 
    .grid-2{ grid-template-columns: 1fr; } 
  }
  
  .grid-2h{ 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
  } 
  @media (max-width: 992px){ 
    .grid-2h{ grid-template-columns: 1fr; } 
  }
  
  /* Listes adaptatives */
  .list-group-soft{ 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
    padding: 4px 0; 
  }
  .list-item{ 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 10px; 
    padding: 10px 12px; 
    border-radius: 12px;
    background: var(--white-color); 
    box-shadow: var(--shadow-sm);
    border: 1px solid color-mix(in srgb, var(--secondary-color) 8%, transparent); 
  }
  .list-item .meta{ 
    color: var(--gray-dark); 
    font-size: .9rem; 
  }
  
  /* Barres de progression */
  .progress-soft{ 
    width: 100%; 
    height: 10px; 
    border-radius: 999px; 
    background: var(--gray-light);
    box-shadow: inset 2px 2px 5px rgba(0,0,0,.06), inset -2px -2px 5px rgba(255,255,255,.8); 
    overflow: hidden; 
  }
  .progress-soft > span{ 
    display: block; 
    height: 100%; 
    background: var(--primary-color); 
    transition: width .4s ease; 
  }
  
  .badge-chip{ 
    border-radius: 999px; 
    padding: .25rem .55rem; 
    font-weight: 800; 
    font-size: .75rem;
    background: color-mix(in srgb, var(--primary-color) 16%, transparent);
    border: 1px solid color-mix(in srgb, var(--primary-color) 35%, transparent); 
    color: var(--secondary-color); 
  }
  
  .chart-card{ 
    padding: 12px; 
  }
  
  /* Espacement adaptatif */
  .mb-2 {
    margin-bottom: 0.5rem;
  }
  
  .mb-3 {
    margin-bottom: 1rem;
  }
  
  .p-3 {
    padding: 1rem;
  }
  
  .mt-2 {
    margin-top: 0.5rem;
  }
  
  /* Responsive pour les petits √©crans */
  @media (max-width: 576px) {
    .section-title {
      font-size: 1rem;
    }
    
    .kpi .val {
      font-size: 1.5rem;
    }
    
    .kpi .lab {
      font-size: .75rem;
    }
    
    #map {
      height: 300px;
    }
    
    .list-item {
      padding: 8px 10px;
    }
    
    .title-wrap {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Ent√™te -->
<div class="entete-card entete-fixe" style="padding: 15px 20px;">
  <div class="row align-items-center">
    <div class="col-md-8">
      <h3 class="mb-0" style="font-size: 1.4rem;">
        <i class="fa fa-users-cog me-2"></i>Tableau de bord programme ({{ programme.code }})
      </h3>
      <p class="mb-0 opacity-75" style="font-size: 0.9rem;">
          Visualisation des donn√©es g√©n√©rales du programme
      </p>
    </div>
  </div>
</div>

<div class="container-wide" style="overflow-y: auto;">

  <!-- KPIs -->
  <div class="card-neumo p-3 mb-3">
    <div class="kpi-grid">
      <!-- <div class="kpi"><div class="val">{{ kpi.preinscriptions }}</div><div class="lab">Pr√©inscriptions</div></div> -->
      <!-- <div class="kpi"><div class="val">{{ kpi.inscriptions }}</div><div class="lab">Inscriptions</div></div> -->
      <!-- <div class="kpi"><div class="val">{{ kpi.candidats_valides }}</div><div class="lab">Candidats valid√©s</div></div> -->
      <div class="kpi"><div class="val">{{ kpi.qpv }}</div><div class="lab">QPV</div></div>
      <div class="kpi"><div class="val">{{ kpi.qpv_limite }}</div><div class="lab">QPV Limite</div></div>
      <!-- <div class="kpi"><div class="val">{{ kpi.qpv_total }}</div><div class="lab">Total QPV</div></div> -->
      <div class="kpi"><div class="val">{{ kpi.femmes }}</div><div class="lab">Femmes</div></div>
      <div class="kpi"><div class="val">{{ kpi.hommes }}</div><div class="lab">Hommes</div></div>
    </div>
  </div>

  <!-- Entonnoir + Carte -->
  <div class="grid-2 mb-3">
    <div class="card-neumo chart-card">
      <h3 class="section-title">Entonnoir ACD</h3>
      <canvas id="chartFunnel" height="220"></canvas>
    </div>
    <div class="card-neumo p-3">
      <h3 class="section-title">Couverture g√©ographique (candidats valid√©s)</h3>
      <div id="map"></div>
      <div class="mt-2" style="display:flex; gap:8px; flex-wrap:wrap;">
        <!-- <span class="badge-chip">üìç Candidats valid√©s</span> -->
        <span class="badge-chip">üü° QPV</span>
        <span class="badge-chip">üü† QPV Limite</span>
        <!-- <span class="badge-chip">üîµ Femmes</span> -->
        <!-- <span class="badge-chip">‚ö´ Hommes</span> -->
      </div>
    </div>
  </div>

  <!-- Sessions & RDV -->
  <div class="grid-2 mb-3">
    <div class="card-neumo p-3">
      <h3 class="section-title">S√©ances √† venir</h3>
      <div class="list-group-soft">
        <div class="list-item" style="background:transparent; border:none; box-shadow:none;">
          <span class="badge-chip">S√©minaire ‚Äî Pr√©sence moyenne: {{ presence_avg.seminaire if presence_avg.seminaire is not none else "‚Äî" }}%</span>
          <span class="badge-chip">CoDev ‚Äî {{ presence_avg.codev if presence_avg.codev is not none else "‚Äî" }}%</span>
          <span class="badge-chip">Webinaire ‚Äî {{ presence_avg.webinaire if presence_avg.webinaire is not none else "‚Äî" }}%</span>
        </div>
        {% for s in sessions.seminaires %}
        <div class="list-item"><div><div style="font-weight:800">{{ s.titre }}</div>
          <div class="meta">{{ s.debut.astimezone().strftime("%d/%m/%Y %H:%M") }}{% if s.lieu %} ‚Ä¢ {{ s.lieu }}{% endif %}</div></div>
          <span class="badge-chip">S√©minaire</span></div>
        {% endfor %}
        {% for s in sessions.codevs %}
        <div class="list-item"><div><div style="font-weight:800">{{ s.titre }}</div>
          <div class="meta">{{ s.debut.astimezone().strftime("%d/%m/%Y %H:%M") }}{% if s.lieu %} ‚Ä¢ {{ s.lieu }}{% endif %}</div></div>
          <span class="badge-chip">CoDev</span></div>
        {% endfor %}
        {% for s in sessions.webinaires %}
        <div class="list-item"><div><div style="font-weight:800">{{ s.titre }}</div>
          <div class="meta">{{ s.debut.astimezone().strftime("%d/%m/%Y %H:%M") }}{% if s.lieu %} ‚Ä¢ {{ s.lieu }}{% endif %}</div></div>
          <span class="badge-chip">Webinaire</span></div>
        {% endfor %}
        {% if not sessions.seminaires and not sessions.codevs and not sessions.webinaires %}
        <div class="list-item"><div class="meta">Aucune s√©ance planifi√©e</div></div>
        {% endif %}
      </div>
    </div>

    <div class="card-neumo p-3">
      <h3 class="section-title">Rendez-vous √† venir</h3>
      <div class="list-group-soft">
        {% if rdvs %}
          {% for r in rdvs %}
          <div class="list-item">
            <div>
              <div style="font-weight:800">{{ r.when.strftime("%d/%m/%Y %H:%M") }}{% if r.fin %} ‚Üí {{ r.fin.strftime("%H:%M") }}{% endif %}</div>
              <div class="meta">{{ r.type|capitalize }} ‚Ä¢ {{ r.candidat }}</div>
            </div>
            <span class="badge-chip">RDV</span>
          </div>
          {% endfor %}
        {% else %}
          <div class="list-item"><div class="meta">Aucun rendez-vous planifi√©</div></div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Pyramide & Suivi mensuel -->
  <div class="grid-2h mb-3">
    <div class="card-neumo chart-card">
      <h3 class="section-title">Pyramide des √¢ges (inscrits ACD)</h3>
      <canvas id="chartPyramid" height="220"></canvas>
    </div>
    <div class="card-neumo p-3">
      <h3 class="section-title">Suivi mensuel (derniers)</h3>
      <div class="list-group-soft">
        {% if suivis %}
          {% for s in suivis %}
          <div class="list-item">
            <div>
              <div style="font-weight:800">{{ s.candidat }}</div>
              <div class="meta">{{ s.mois.strftime("%m/%Y") }} ‚Äî Score: {{ s.score if s.score is not none else "‚Äî" }}</div>
              {% if s.commentaire %}<div class="meta">"{{ s.commentaire }}"</div>{% endif %}
            </div>
            <span class="badge-chip">Suivi</span>
          </div>
          {% endfor %}
        {% else %}
          <div class="list-item"><div class="meta">Aucun suivi enregistr√©</div></div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Objectifs -->
  <div class="card-neumo p-3 mb-3">
    <h3 class="section-title">Atteinte des objectifs</h3>
    <div class="list-group-soft">
      <div class="list-item" style="flex-direction:column; align-items:stretch;">
        {% if objectifs.objectif_total %}
          <div class="meta">Total (objectif {{ objectifs.objectif_total }}) ‚Äî {{ objectifs.total_pct or 0 }}%</div>
          <div class="progress-soft"><span style="width: {{ (objectifs.total_pct or 0) | round(1) }}%; background-color: var(--primary-color);"></span></div>
        {% else %}
          <div class="meta">Objectif total non d√©fini</div>
        {% endif %}

        {% if objectifs.cible_qpv_pct is not none %}
          <div class="meta mt-2">QPV (cible {{ objectifs.cible_qpv_pct | round(0) }}%) ‚Äî {{ objectifs.qpv_pct }}%</div>
          <div class="progress-soft"><span style="width: {{ [objectifs.qpv_objectif_atteint, 100] | min | round(1) }}%; background-color: var(--secondary-color);"></span></div>
          {% endif %}

          {% if objectifs.cible_femmes_pct is not none %}
          <div class="meta mt-2">Femmes (cible {{ objectifs.cible_femmes_pct | round(0) }}%) ‚Äî {{ objectifs.f_pct }}%</div>
          <div class="progress-soft"><span style="width: {{ [objectifs.f_objectif_atteint, 100] | min | round(1) }}%; background-color: var(--primary-color);"></span></div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<!-- Leaflet + Charts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
  const PINS = {{ pins | tojson }};
  const FUNNEL_LABELS = {{ funnel_labels | tojson }};
  const FUNNEL_VALUES = {{ funnel_values | tojson }};
  const PYR_LABELS = {{ pyramid_labels | tojson }};
  const PYR_MALE = {{ pyramid_male | tojson }};
  const PYR_FEMALE = {{ pyramid_female | tojson }};

  // Carte
  (function(){
    const map = L.map('map', { scrollWheelZoom: false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { maxZoom: 18, attribution: '&copy; OpenStreetMap' }).addTo(map);
    const markers = [];
    PINS.forEach(p => {
      // Debug pour voir les donn√©es
      console.log('Pin data:', p);
      
      // D√©terminer la couleur du pin selon le statut QPV
      let pinColor = '#3388ff'; // Bleu par d√©faut (Non QPV)
      let qpv_status = "‚ö™ Non QPV";
      
      if (p.qpv) {
        pinColor = '#ffd700'; // Jaune pour QPV
        qpv_status = "üü° QPV";
        console.log('QPV d√©tect√©:', p.prenom, p.nom);
      } else if (p.qpv_limite) {
        pinColor = '#ff8c00'; // Orange pour QPV Limite
        qpv_status = "üü† QPV Limite";
        console.log('QPV Limite d√©tect√©:', p.prenom, p.nom);
      } else {
        console.log('Non QPV:', p.prenom, p.nom, 'qpv:', p.qpv, 'qpv_limite:', p.qpv_limite);
      }
      
      // Cr√©er une ic√¥ne Leaflet color√©e
      const coloredIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      
      // Modifier la couleur de l'ic√¥ne
      if (p.qpv) {
        coloredIcon.options.iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png';
      } else if (p.qpv_limite) {
        coloredIcon.options.iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
      }
      
      const m = L.marker([p.lat, p.lng], { icon: coloredIcon }).addTo(map);
      
      const sx = p.sexe === "F" ? "üîµ Femme" : (p.sexe === "H" ? "‚ö´ Homme" : "‚Ä¢");
      m.bindPopup(`<div style="font-weight:800">${(p.prenom||"")} ${(p.nom||"")}</div>
                   <div style="font-size:.9rem; opacity:.8">${p.adresse||""}</div>
                   <div style="font-size:.9rem;">${qpv_status} ‚Ä¢ ${sx}</div>`);
      markers.push(m);
    });
    if (markers.length){
      const g = L.featureGroup(markers);
      map.fitBounds(g.getBounds().pad(0.2));
    } else {
      map.setView([46.7, 2.5], 5);
    }
  })();

  // Entonnoir
  (function(){
    const ctx = document.getElementById('chartFunnel').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { 
        labels: FUNNEL_LABELS, 
        datasets: [{ 
          label: 'Volume', 
          data: FUNNEL_VALUES, 
          borderWidth: 1,
          backgroundColor: ['#e3f2fd', '#bbdefb', '#90caf9', '#ffecb3', '#ffcdd2'],
          borderColor: ['#1976d2', '#1565c0', '#0d47a1', '#ff8f00', '#d32f2f']
        }] 
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false }, 
          tooltip: { mode: 'index', intersect: false },
          datalabels: {
            display: true,
            color: '#333',
            font: { weight: 'bold', size: 12 },
            formatter: (value) => value
          }
        },
        scales: { 
          x: { ticks: { autoSkip: true, maxRotation: 0 } }, 
          y: { 
            beginAtZero: true, 
            ticks: { precision: 0 },
            suggestedMax: Math.max(...FUNNEL_VALUES) + 2
          } 
        }
      },
      plugins: [{
        id: 'datalabels',
        afterDatasetsDraw: (chart) => {
          const ctx = chart.ctx;
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            meta.data.forEach((bar, index) => {
              const data = dataset.data[index];
              ctx.fillStyle = '#333';
              ctx.font = 'bold 12px Arial';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText(data, bar.x, bar.y - 5);
            });
          });
        }
      }]
    });
  })();

  // Pyramide des √¢ges
  (function(){
    const ctx = document.getElementById('chartPyramid').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { 
        labels: PYR_LABELS, 
        datasets: [
          { 
            label:'Hommes', 
            data: PYR_MALE, // Valeurs n√©gatives pour les hommes (gauche)
            borderWidth: 1,
            backgroundColor: '#90caf9',
            borderColor: '#1976d2'
          },
          { 
            label:'Femmes', 
            data: PYR_FEMALE, // Valeurs positives pour les femmes (droite)
            borderWidth: 1,
            backgroundColor: '#f8bbd9',
            borderColor: '#e91e63'
          }
        ]
      },
      options:{
        indexAxis:'y', 
        responsive:true,
        plugins:{ 
          legend:{ position:'bottom' },
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: ${Math.abs(ctx.parsed.x)}` } }
        },
        scales:{ 
          x:{ 
            stacked:false, // Pas de stacking pour une vraie pyramide
            ticks:{ 
              callback:(v)=>Math.abs(v), 
              precision:0 
            },
            suggestedMax: Math.max(...PYR_MALE.map(Math.abs), ...PYR_FEMALE.map(Math.abs)) + 1,
            suggestedMin: -(Math.max(...PYR_MALE.map(Math.abs), ...PYR_FEMALE.map(Math.abs)) + 1)
          }, 
          y:{ stacked:false }
        }
      },
      plugins: [{
        id: 'datalabels',
        afterDatasetsDraw: (chart) => {
          const ctx = chart.ctx;
          chart.data.datasets.forEach((dataset, i) => {
            const meta = chart.getDatasetMeta(i);
            meta.data.forEach((bar, index) => {
              const data = Math.abs(dataset.data[index]);
              if (data > 0) { // Afficher seulement si > 0
                ctx.fillStyle = '#333';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Positionner l'√©tiquette au centre de la barre
                const x = bar.x;
                const y = bar.y;
                ctx.fillText(data, x, y);
              }
            });
          });
        }
      }]
    });
  })();
</script>
{% endblock %}
