<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }} - {{ rdv.candidat_prenom }} {{ rdv.candidat_nom }}</title>
    
    <!-- CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
    <link href="/static/css/styles.css" rel="stylesheet"/>
    
    <!-- Jitsi Meet API -->
    <script src="https://{{ jitsi_domain }}/external_api.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
        }
        
        .video-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .rdv-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            max-width: 250px;
            font-size: 12px;
        }
        
        .rdv-info h3 {
            margin: 0 0 8px 0;
            color: #ffd300;
            font-size: 14px;
        }
        
        .rdv-info p {
            margin: 3px 0;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .btn-control {
            background: #ffd300;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-control:hover {
            background: #e6c200;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        /* Zone de notes */
        .notes-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .notes-section h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .notes-section textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            resize: vertical;
        }
        
        .notes-actions {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .save-status {
            font-size: 12px;
            color: #666;
        }
        
        .save-status.success {
            color: #28a745;
        }
        
        .save-status.error {
            color: #dc3545;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-en-cours {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Informations du RDV -->
    <div class="rdv-info">
        <h3><i class="fas fa-video me-2"></i>{{ app_name }}</h3>
        <p><strong>Candidat:</strong> {{ candidat_prenom }} {{ candidat_nom }}</p>
        <p><strong>Programme:</strong> {{ programme_nom }}</p>
        <p><strong>Type:</strong> {{ rdv.type_rdv | title }}</p>
        <p><strong>Date:</strong> {{ rdv.debut.strftime('%d/%m/%Y à %H:%M') }}</p>
        <p>
            <span class="status-indicator status-en-cours"></span>
            <strong>Statut:</strong> En cours
        </p>
    </div>
    
    <!-- Conteneur vidéo Jitsi -->
    <div id="jitsi-container" class="video-container"></div>
    
    <!-- Zone de notes (visible uniquement pour le conseiller) -->
    {% if role == "conseiller" %}
    <div class="notes-section">
        <h4><i class="fas fa-sticky-note me-2"></i>Notes du rendez-vous</h4>
        <textarea id="notes-textarea" placeholder="Prenez vos notes ici... Elles seront automatiquement sauvegardées."></textarea>
        <div class="notes-actions">
            <button class="btn-control btn-success" onclick="sauvegarderNotes()">
                <i class="fas fa-save"></i> Sauvegarder
            </button>
            <span class="save-status" id="save-status"></span>
        </div>
    </div>
    {% endif %}
    
    <!-- Contrôles -->
    <div class="controls">
        <button class="btn-control" onclick="toggleMute()">
            <i class="fas fa-microphone"></i> Micro
        </button>
        <button class="btn-control" onclick="toggleVideo()">
            <i class="fas fa-video"></i> Caméra
        </button>
        <button class="btn-control" onclick="toggleChat()">
            <i class="fas fa-comments"></i> Chat
        </button>
        {% if role == "conseiller" %}
        <button class="btn-control btn-danger" onclick="terminerRDV()">
            <i class="fas fa-stop"></i> Terminer RDV
        </button>
        {% endif %}
    </div>

    <script>
        let api;
        let isMuted = false;
        let isVideoOn = true;
        let isChatOpen = false;
        
        // Configuration Jitsi
        const domain = '{{ jitsi_domain }}';
        const options = {
            roomName: '{{ room }}',
            width: '100%',
            height: '100%',
            parentNode: document.querySelector('#jitsi-container'),
            userInfo: {
                displayName: '{{ display_name }}',
                email: '{{ current_user.email }}'
            },
            configOverwrite: {
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                enableWelcomePage: false,
                prejoinPageEnabled: false,
                disableModeratorIndicator: false,
                startScreenSharing: false,
                enableEmailInStats: false,
                // Configuration pour les rôles
                {% if role == "conseiller" %}
                enableLobby: true,
                enableClosePage: false,
                {% else %}
                enableLobby: false,
                enableClosePage: true,
                {% endif %}
                // Désactiver la démo et les limitations
                enableWelcomePage: false,
                enablePrejoinPage: false,
                // Configuration de la salle
                channelLastN: -1,
                enableLayerSuspension: true,
                // Désactiver les fonctionnalités payantes
                enableInsecureRoomNameWarning: false,
                enableNoisyMicDetection: true,
                enableTalkWhileMuted: true,
                enableNoAudioDetection: true,
                enableRemb: true,
                enableTcc: true,
                useStunTurn: true,
                // Éviter les limitations de démo
                enableLobby: false,
                enableClosePage: false,
                enableWelcomePage: false,
                enablePrejoinPage: false,
                // Configuration pour éviter les timeouts
                enableLayerSuspension: false,
                enableRemb: false,
                enableTcc: false
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                    'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                    'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts',
                    'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone'
                ],
                SHOW_JITSI_WATERMARK: false,
                SHOW_WATERMARK_FOR_GUESTS: false,
                SHOW_BRAND_WATERMARK: false,
                SHOW_POWERED_BY: false,
                DEFAULT_LOGO_URL: '/static/images/logo.png',
                PROVIDER_NAME: '{{ app_name }}',
                APP_NAME: '{{ app_name }}',
                NATIVE_APP_NAME: '{{ app_name }}',
                TOOLBAR_TIMEOUT: 4000,
                SETTINGS_SECTIONS: ['devices', 'language', 'moderator', 'profile', 'calendar'],
                SHOW_MEETING_TIMER: true,
                SHOW_MEETING_TIMER_WITH_END_TIME: true,
                MEETING_TIMER_ENABLED: true,
                CLOSE_PAGE_GUEST_HINT: false,
                RANDOM_MEETING_SERVER_URL: '',
                ENABLE_DIAL_OUT: false,
                ENABLE_WELCOME_PAGE: false,
                ENABLE_CLOSE_PAGE: false,
                DISPLAY_WELCOME_FOOTER: false,
                DISPLAY_WELCOME_PAGE_ADDITIONAL_CARD: false,
                DISPLAY_WELCOME_PAGE_CONTENT: false,
                DISPLAY_WELCOME_PAGE_TOOLBAR_ADDITIONAL_CONTENT: false,
                MOBILE_APP_PROMO: false,
                MOBILE_DOWNLOAD_LINK_ANDROID: '',
                MOBILE_DOWNLOAD_LINK_IOS: '',
                GENERATE_ROOMNAMES_ON_WELCOME_PAGE: false,
                APP_TOOLBAR_BUTTONS: [],
                AUDIO_LEVEL_PRIMARY_COLOR: '#ffd300',
                AUDIO_LEVEL_SECONDARY_COLOR: '#e6c200'
            }
        };
        
        // Initialiser Jitsi Meet
        api = new JitsiMeetExternalAPI(domain, options);
        
        // Événements Jitsi
        api.addEventListeners({
            readyToClose: function() {
                console.log('Jitsi prêt à fermer');
            },
            participantLeft: function(participant) {
                console.log('Participant parti:', participant);
            },
            participantJoined: function(participant) {
                console.log('Participant rejoint:', participant);
            },
            videoConferenceJoined: function(participant) {
                console.log('Conférence vidéo rejointe:', participant);
                // Charger les notes existantes si c'est un conseiller
                {% if role == "conseiller" %}
                chargerNotes();
                {% endif %}
            },
            videoConferenceLeft: function(participant) {
                console.log('Conférence vidéo quittée:', participant);
            },
            audioMuteStatusChanged: function(participant) {
                console.log('Statut micro changé:', participant);
            },
            videoMuteStatusChanged: function(participant) {
                console.log('Statut vidéo changé:', participant);
            }
        });
        
        // Fonctions de contrôle
        function toggleMute() {
            api.executeCommand('toggleAudio');
            isMuted = !isMuted;
            updateButtonIcon('microphone', isMuted);
        }
        
        function toggleVideo() {
            api.executeCommand('toggleVideo');
            isVideoOn = !isVideoOn;
            updateButtonIcon('video', !isVideoOn);
        }
        
        function toggleChat() {
            api.executeCommand('toggleChat');
            isChatOpen = !isChatOpen;
        }
        
        function updateButtonIcon(type, isOff) {
            const button = event.target.closest('button');
            const icon = button.querySelector('i');
            if (type === 'microphone') {
                icon.className = isOff ? 'fas fa-microphone-slash' : 'fas fa-microphone';
            } else if (type === 'video') {
                icon.className = isOff ? 'fas fa-video-slash' : 'fas fa-video';
            }
        }
        
        function terminerRDV() {
            if (confirm('Êtes-vous sûr de vouloir terminer ce rendez-vous ?')) {
                // Sauvegarder les notes avant de terminer
                sauvegarderNotes().then(() => {
                    // Terminer la conférence
                    api.executeCommand('hangup');
                    
                    // Appeler l'API pour terminer le RDV
                    fetch(`/video-rdv/{{ rdv.id }}/terminer`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Rendez-vous terminé avec succès');
                            // Fermer l'onglet
                            window.close();
                        } else {
                            alert('Erreur lors de la finalisation du rendez-vous');
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors de la finalisation du rendez-vous');
                    });
                });
            }
        }
        
        function sauvegarderNotes() {
            const notesContent = document.getElementById('notes-textarea').value;
            return fetch(`/video-rdv/{{ rdv.id }}/notes`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ notes: notesContent })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Notes sauvegardées avec succès');
                } else {
                    console.error('Erreur lors de la sauvegarde des notes');
                }
            })
            .catch(error => {
                console.error('Erreur lors de la sauvegarde des notes:', error);
            });
        }
        
        function chargerNotes() {
            fetch(`/video-rdv/{{ rdv.id }}/notes`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('notes-textarea').value = data.notes || '';
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des notes:', error);
            });
        }
        
        // Gestion de la fermeture de l'onglet
        window.addEventListener('beforeunload', function(e) {
            // Optionnel: confirmer avant de fermer
            // e.preventDefault();
            // e.returnValue = '';
        });
        
        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'm':
                        e.preventDefault();
                        toggleMute();
                        break;
                    case 'e':
                        e.preventDefault();
                        toggleVideo();
                        break;
                    case 't':
                        e.preventDefault();
                        terminerRDV();
                        break;
                }
            }
        });
    </script>
</body>
</html>
