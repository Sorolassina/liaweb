{% extends "ACD/admin/base_admin.html" %}
{% block admin_content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="m-0">
    {% if prog %}
      <i class="fa fa-edit me-2"></i>Modifier le programme {{ prog.code }}
    {% else %}
      <i class="fa fa-plus me-2"></i>Nouveau programme
    {% endif %}
  </h5>
  <a class="btn btn-outline-secondary" href="/admin/programmes">
    <i class="fa fa-arrow-left me-2"></i>Retour à la liste
  </a>
</div>

<div class="card-neumo p-4 mb-3">
  <h6 class="mb-3"><i class="fa fa-info-circle me-2"></i>Informations générales</h6>
  <form method="post" action="/admin/programmes/save" class="row g-3">
    <input type="hidden" name="prog_id" value="{{ prog and prog.id or '' }}">
    
    <!-- Code et nom -->
    <div class="col-md-3">
      <label class="form-label">Code <span class="text-danger">*</span></label>
      <input class="form-control" name="code" value="{{ prog and prog.code or '' }}" 
             placeholder="Ex: ACD, ACI, ACT" required>
      <div class="form-text">Code unique du programme</div>
    </div>
    <div class="col-md-6">
      <label class="form-label">Nom <span class="text-danger">*</span></label>
      <input class="form-control" name="nom" value="{{ prog and prog.nom or '' }}" 
             placeholder="Ex: Accompagnement au Développement" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Statut</label>
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" name="actif" 
               {% if not prog or prog.actif %}checked{% endif %}>
        <label class="form-check-label">Programme actif</label>
      </div>
    </div>
    
    <!-- Objectif -->
    <div class="col-12">
      <label class="form-label">Objectif</label>
      <textarea class="form-control" name="objectif" rows="3" 
                placeholder="Description de l'objectif du programme...">{{ prog and (prog.objectif or '') }}</textarea>
    </div>
    
    <!-- Objectifs quantitatifs -->
    <div class="col-12">
      <h6 class="mb-3"><i class="fa fa-target me-2"></i>Objectifs quantitatifs</h6>
    </div>
    
    <div class="col-md-4">
      <label class="form-label">Objectif total d'inscriptions</label>
      <div class="input-group">
        <input type="number" class="form-control" name="objectif_total" 
               value="{{ prog and prog.objectif_total or '' }}" 
               placeholder="0" min="0">
        <span class="input-group-text">candidats</span>
      </div>
      <div class="form-text">Cible de volume d'inscriptions</div>
    </div>
    
    <div class="col-md-4">
      <label class="form-label">Cible QPV (%)</label>
      <div class="input-group">
        <input type="number" class="form-control" name="cible_qpv_pct" 
               value="{{ prog and prog.cible_qpv_pct or '' }}" 
               placeholder="0" min="0" max="100" step="0.1">
        <span class="input-group-text">%</span>
      </div>
      <div class="form-text">Pourcentage cible QPV</div>
    </div>
    
    <div class="col-md-4">
      <label class="form-label">Cible femmes (%)</label>
      <div class="input-group">
        <input type="number" class="form-control" name="cible_femmes_pct" 
               value="{{ prog and prog.cible_femmes_pct or '' }}" 
               placeholder="0" min="0" max="100" step="0.1">
        <span class="input-group-text">%</span>
      </div>
      <div class="form-text">Pourcentage cible femmes</div>
    </div>
    
    <!-- Dates -->
    <div class="col-md-6">
      <label class="form-label">Date de début</label>
      <input type="date" class="form-control" name="date_debut" 
             value="{{ prog and prog.date_debut or '' }}">
    </div>
    <div class="col-md-6">
      <label class="form-label">Date de fin</label>
      <input type="date" class="form-control" name="date_fin" 
             value="{{ prog and prog.date_fin or '' }}">
    </div>
    
               <!-- Responsable -->
      <div class="col-md-6">
        <label class="form-label">Responsable</label>
        <select class="form-select" name="responsable_id">
          <option value="">— Aucun responsable —</option>
          {% for user in users %}
            <option value="{{ user.id }}" {% if prog and prog.responsable_id == user.id %}selected{% endif %}>
              {{ user.nom_complet }} ({{ user.email }})
            </option>
          {% endfor %}
        </select>
        <div class="form-text">Sélectionnez l'utilisateur responsable de ce programme</div>
      </div>
      
      <hr class="my-4">
     
     <!-- Critères d'éligibilité -->
    
    <!-- Critères d'éligibilité -->
    <div class="col-12">
      <h6 class="mb-3"><i class="fa fa-filter me-2"></i>Critères d'éligibilité</h6>
    </div>
    
    <!-- Chiffre d'affaires -->
    <div class="col-md-4">
      <label class="form-label">Chiffre d'affaires minimum (k€)</label>
      <div class="input-group">
        <input type="number" class="form-control" name="ca_seuil_min" 
               value="{{ prog and prog.ca_seuil_min or '' }}" 
               placeholder="0" min="0" step="0.1">
        <span class="input-group-text">k€</span>
      </div>
      <div class="form-text">Seuil minimum de CA</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Chiffre d'affaires maximum (k€)</label>
      <div class="input-group">
        <input type="number" class="form-control" name="ca_seuil_max" 
               value="{{ prog and prog.ca_seuil_max or '' }}" 
               placeholder="∞" min="0" step="0.1">
        <span class="input-group-text">k€</span>
      </div>
      <div class="form-text">Seuil maximum de CA</div>
    </div>
    <div class="col-md-4">
      <label class="form-label">Ancienneté minimum</label>
      <div class="input-group">
        <input type="number" class="form-control" name="anciennete_min_annees" 
               value="{{ prog and prog.anciennete_min_annees or '' }}" 
               placeholder="0" min="0" step="0.5">
        <span class="input-group-text">années</span>
      </div>
      <div class="form-text">Ancienneté minimum requise</div>
    </div>
    
    <!-- Aide visuelle pour les intervalles -->
    <div class="col-12">
      <div class="alert alert-info">
        <i class="fa fa-lightbulb me-2"></i>
        <strong>Conseil :</strong> 
        <ul class="mb-0 mt-2">
          <li>Laissez vide le CA minimum pour "pas de minimum"</li>
          <li>Laissez vide le CA maximum pour "pas de maximum"</li>
          <li>Exemple d'intervalle : 100k€ - 500k€</li>
          <li>Exemple de seuil unique : ≥ 200k€ (minimum seulement)</li>
        </ul>
      </div>
    </div>
    
    <!-- Bouton de sauvegarde -->
    <div class="col-12">
      <hr class="my-4">
      <div class="d-flex justify-content-end gap-2">
        <a class="btn btn-secondary" href="/admin/programmes">
          <i class="fa fa-times me-2"></i>Annuler
        </a>
        <button type="submit" class="btn btn-primary">
          <i class="fa fa-save me-2"></i>Enregistrer le programme
        </button>
      </div>
    </div>
  </form>
</div>

 {% if prog %}
 <div class="card-neumo p-4">
     <div class="d-flex justify-content-between align-items-center mb-3">
     <h6 class="m-0"><i class="fa fa-sitemap me-2"></i>Étapes du pipeline</h6>
     <button class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#addStepForm">
       <i class="fa fa-plus me-2"></i>Ajouter une étape
     </button>
   </div>
  
  <!-- Formulaire d'ajout d'étape -->
  <div class="collapse mb-3" id="addStepForm">
    <div class="card card-body bg-light">
      <form class="row g-3" method="post" action="/admin/programmes/{{ prog.id }}/etapes/add">
        <div class="col-md-4">
          <label class="form-label">Libellé <span class="text-danger">*</span></label>
          <input name="libelle" class="form-control" placeholder="Ex: Pré-inscription" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Code <span class="text-danger">*</span></label>
          <input name="code" class="form-control" placeholder="Ex: PRE" required>
        </div>
        <div class="col-md-2">
          <label class="form-label">Ordre <span class="text-danger">*</span></label>
          <input type="number" name="ordre" class="form-control" placeholder="1" min="1" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Type d'étape</label>
          <input name="type_etape" class="form-control" placeholder="Ex: formation, jury, entretien">
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="active" checked>
            <label class="form-check-label">Active</label>
          </div>
        </div>
        <div class="col-12">
          <button class="btn btn-primary btn-sm">
            <i class="fa fa-plus me-2"></i>Ajouter l'étape
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Tableau des étapes -->
  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th width="60">#</th>
          <th>Libellé</th>
          <th width="100">Code</th>
          <th>Type</th>
          <th width="100">Statut</th>
          <th class="text-end" width="120">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for s in steps %}
        <tr>
          <td>
            <span class="badge bg-secondary">{{ s.ordre }}</span>
          </td>
          <td class="fw-bold">{{ s.libelle }}</td>
          <td><code class="bg-light px-2 py-1 rounded">{{ s.code }}</code></td>
          <td>{{ s.type_etape or '—' }}</td>
          <td>
            {% if s.active %}
              <span class="badge bg-success">
                <i class="fa fa-check me-1"></i>Active
              </span>
            {% else %}
              <span class="badge bg-secondary">
                <i class="fa fa-pause me-1"></i>Inactive
              </span>
            {% endif %}
          </td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" title="Modifier">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger" title="Supprimer" 
                      onclick="return confirm('Supprimer cette étape ?')">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted py-4">
            <i class="fa fa-info-circle me-2"></i>Aucune étape définie
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  </div>
 {% endif %}
 
 {% endblock %}
