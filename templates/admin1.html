{% extends "base.html" %}

{% block title %}Administration LIA - {{ super() }}{% endblock %}

{% block extra_head %}
<style>
  /* ================================
     Variables compatibles avec LIA
     ================================ */
  :root{
    /* Palette LIA */
    --jaune:#ffd300; --noir:#0b0b0b; --blanc:#ffffff;

    /* Mappage pour cette page (utilisée ci-dessous) */
    --primary-color: var(--jaune);
    --accent-color: #111111;         /* accent sombre */
    --text-color: var(--noir);

    /* Neutres (utilisés massivement par le gabarit) */
    --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db;
    --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563; --gray-700:#374151;
    --gray-800:#1f2937; --gray-900:#111827;

    /* États */
    --success-color:#16a34a; --warning-color:#f59e0b; --error-color:#dc2626;
  }

  /* ========================================
     STYLES SPÉCIFIQUES À LA PAGE ADMIN LIA
     ======================================== */

  /* Layout admin */
  .admin-container { display:flex; min-height:calc(100vh - 80px); margin-top:80px; }

  /* Sidebar admin */
  .admin-sidebar {
    width:280px; background:white; border-right:1px solid var(--gray-200);
    padding:24px 0; position:fixed; left:0; top:80px; height:calc(100vh - 80px); overflow-y:auto;
  }
  .admin-sidebar-header { padding:0 24px 24px 24px; border-bottom:1px solid var(--gray-200); margin-bottom:24px; }
  .admin-sidebar-title { font-size:18px; font-weight:600; color:var(--gray-900); margin-bottom:8px; }
  .admin-sidebar-subtitle { font-size:14px; color:var(--gray-600); }
  .admin-nav { padding:0 16px; }
  .admin-nav-section { margin-bottom:32px; }
  .admin-nav-section-title {
    font-size:12px; font-weight:600; color:var(--gray-500); text-transform:uppercase; letter-spacing:.05em;
    margin-bottom:12px; padding:0 8px;
  }
  .admin-nav-item {
    display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:8px;
    color:var(--gray-700); text-decoration:none; font-size:14px; font-weight:500; transition:all .2s ease; margin-bottom:4px;
  }
  .admin-nav-item:hover { background-color:var(--gray-50); color:var(--gray-900); }
  .admin-nav-item.active { background-color:var(--primary-color); color:var(--text-color); }
  .admin-nav-item.active:hover { background-color:var(--primary-color); filter:brightness(0.95); }
  .admin-nav-icon { width:20px; height:20px; flex-shrink:0; }

  /* Contenu principal */
  .admin-main { flex:1; margin-left:280px; padding:32px; background-color:var(--gray-50); }
  .admin-header { margin-bottom:32px; }
  .admin-page-title { font-size:28px; font-weight:700; color:var(--gray-900); margin-bottom:8px; }
  .admin-page-description { font-size:16px; color:var(--gray-600); }

  /* Stat cards */
  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:24px; margin-bottom:32px; }
  .stat-card { background:white; border-radius:12px; padding:24px; box-shadow:0 1px 3px rgba(0,0,0,.1); border:1px solid var(--gray-200); }
  .stat-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .stat-card-title { font-size:14px; font-weight:500; color:var(--gray-600); text-transform:uppercase; letter-spacing:.05em; }
  .stat-card-icon { width:32px; height:32px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; }
  .stat-card-icon.users { background-color:var(--primary-color); color:var(--noir); }
  .stat-card-icon.candidates { background-color:var(--success-color); }
  .stat-card-icon.events { background-color:var(--warning-color); }
  .stat-card-icon.active { background-color:var(--accent-color); }
  .stat-card-value { font-size:32px; font-weight:700; color:var(--gray-900); margin-bottom:8px; }
  .stat-card-change { font-size:14px; color:var(--success-color); display:flex; align-items:center; gap:4px; }
  .stat-card-change.negative { color:var(--error-color); }

  /* Hiérarchie LIA : STRUCTURE > PROGRAMME > PROMOTION > GROUPE */
  .org-hierarchy { background:white; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); border:1px solid var(--gray-200); margin-bottom:32px; overflow:hidden; }
  .hierarchy-node { padding:16px 24px; border-bottom:1px solid var(--gray-200); display:flex; align-items:center; gap:12px; transition:background-color .2s ease; }
  .hierarchy-node:hover { background-color:var(--gray-50); }
  .hierarchy-node:last-child { border-bottom:none; }
  .node-level-0 { padding-left:24px; font-weight:700; }     /* Structure */
  .node-level-1 { padding-left:48px; font-weight:600; }     /* Programme */
  .node-level-2 { padding-left:72px; font-weight:500; }     /* Promotion */
  .node-level-3 { padding-left:96px; font-weight:400; }     /* Groupe */
  .node-icon { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:12px; font-weight:600; }
  .node-icon.root { background-color:var(--error-color); }
  .node-icon.program { background-color:var(--primary-color); color:var(--noir); }
  .node-icon.promo { background-color:var(--warning-color); }
  .node-icon.groupe { background-color:var(--success-color); }

  /* Badges de rôle (LIA) */
  .role-badge { padding:4px 12px; border-radius:20px; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.05em; margin-left:auto; }
  .role-badge.dt { background-color:var(--error-color); color:white; }           /* DIRECTEUR_TECHNIQUE */
  .role-badge.rs { background-color:var(--warning-color); color:var(--text-color); } /* RESPONSABLE_STRUCTURE */
  .role-badge.rp { background-color:var(--primary-color); color:var(--noir); }  /* RESPONSABLE_PROGRAMME */
  .role-badge.cons { background-color:var(--success-color); color:white; }      /* CONSEILLER */
  .role-badge.jury { background-color:#6366f1; color:white; }                   /* JURY_EXTERNE */
  .role-badge.cand { background-color:var(--gray-200); color:var(--gray-700); } /* CANDIDAT */

  /* Matrice permissions LIA */
  .permission-matrix { background:white; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); border:1px solid var(--gray-200); overflow:hidden; }
  .permission-row { display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr; align-items:center; padding:12px 24px; border-bottom:1px solid var(--gray-200); font-size:14px; }
  .permission-row:last-child { border-bottom:none; }
  .permission-row.header { background-color:var(--gray-50); font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:.05em; }
  .permission-indicator { width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto; }
  .permission-indicator.allowed { background-color:var(--success-color); color:white; }
  .permission-indicator.limited { background-color:var(--warning-color); color:var(--noir); }
  .permission-indicator.denied { background-color:var(--gray-300); color:var(--gray-600); }

  /* Tableau utilisateurs / invitations / audit : inchangés hormis wording FR & thème LIA */
  .invite-panel, .users-section, .audit-log { background:white; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.1); border:1px solid var(--gray-200); overflow:hidden; }
  .invite-panel { padding:24px; margin-bottom:32px; }
  .users-section-header { padding:24px; border-bottom:1px solid var(--gray-200); display:flex; justify-content:space-between; align-items:center; }
  .users-section-title { font-size:20px; font-weight:600; color:var(--gray-900); }
  .add-user-btn { background:var(--primary-color); color:var(--noir); border:none; padding:10px 20px; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; transition:all .2s ease; display:flex; align-items:center; gap:8px; }
  .add-user-btn:hover { filter:brightness(0.95); transform:translateY(-1px); }
  .users-table { width:100%; border-collapse:collapse; }
  .users-table th { background-color:var(--gray-50); padding:16px 24px; text-align:left; font-size:14px; font-weight:600; color:var(--gray-700); border-bottom:1px solid var(--gray-200); }
  .users-table td { padding:16px 24px; border-bottom:1px solid var(--gray-200); font-size:14px; color:var(--gray-700); }
  .users-table tr:hover { background-color:var(--gray-50); }
  .user-avatar { width:40px; height:40px; border-radius:50%; background-color:var(--primary-color); display:flex; align-items:center; justify-content:center; color:var(--noir); font-weight:700; font-size:16px; }
  .user-role.admin { background-color:var(--error-color); color:white; }
  .user-role.coach { background-color:var(--warning-color); color:var(--noir); }
  .user-role.user { background-color:var(--gray-200); color:var(--gray-700); }

  .audit-entry { padding:16px 24px; border-bottom:1px solid var(--gray-200); display:flex; align-items:center; gap:16px; }
  .audit-entry:last-child { border-bottom:none; }
  .audit-timestamp { font-size:12px; color:var(--gray-500); min-width:120px; }
  .audit-action { font-size:14px; color:var(--gray-700); flex:1; }
  .audit-actor { font-size:13px; color:var(--gray-800); font-weight:600; }

  /* Responsive */
  @media (max-width:1024px){
    .admin-sidebar{ transform:translateX(-100%); transition:transform .3s ease; z-index:40; }
    .admin-sidebar.show{ transform:translateX(0); }
    .admin-main{ margin-left:0; }
    .stats-grid{ grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
  }
  @media (max-width:768px){
    .admin-main{ padding:24px 16px; }
    .stats-grid{ grid-template-columns:1fr; }
    .users-section-header{ flex-direction:column; gap:16px; align-items:stretch; }
    .add-user-btn{ justify-content:center; }
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <div class="admin-sidebar-header">
      <h2 class="admin-sidebar-title">Administration LIA</h2>
      <p class="admin-sidebar-subtitle">Pilotage structure, programmes & accès</p>
    </div>

    <nav class="admin-nav">
      <div class="admin-nav-section">
        <h3 class="admin-nav-section-title">Vue d'ensemble</h3>
        <a href="#dashboard" class="admin-nav-item active" data-section="dashboard">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path></svg>
          Tableau de bord
        </a>
        <a href="#lia-structure" class="admin-nav-item" data-section="lia-structure">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5"></path></svg>
          Structure & Programmes
        </a>
      </div>

      <div class="admin-nav-section">
        <h3 class="admin-nav-section-title">Gestion des accès</h3>
        <a href="#users" class="admin-nav-item" data-section="users">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197"></path></svg>
          Utilisateurs & Rôles
        </a>
        <a href="#invitations" class="admin-nav-item" data-section="invitations">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
          Invitations
        </a>
        <a href="#permissions" class="admin-nav-item" data-section="permissions">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.6-4A12 12 0 013 9c0 5.6 3.8 10.3 9 11.6 5.2-1.3 9-6 9-11.6 0-1.05-.13-2.06-.38-3.02z"></path></svg>
          Permissions RBAC
        </a>
      </div>

      <div class="admin-nav-section">
        <h3 class="admin-nav-section-title">Surveillance</h3>
        <a href="#audit" class="admin-nav-item" data-section="audit">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.6a1 1 0 01.7.3l5.4 5.4a1 1 0 01.3.7V19a2 2 0 01-2 2z"></path></svg>
          Journal d'audit
        </a>
        <a href="#org-themes" class="admin-nav-item" data-section="org-themes">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM21 5a2 2 0 00-2-2h-4a2 2 0 00-2 2v12a4 4 0 004 4h4a2 2 0 002-2V5z"></path></svg>
          Thèmes LIA
        </a>
        <a href="#settings" class="admin-nav-item" data-section="settings">
          <svg class="admin-nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.3 4.3c.42-1.76 2.92-1.76 3.35 0a1.72 1.72 0 002.57 1.07c1.54-.94 3.3.83 2.37 2.37a1.72 1.72 0 001.07 2.57c1.76.42 1.76 2.92 0 3.35a1.72 1.72 0 00-1.07 2.57c.94 1.54-.83 3.3-2.37 2.37a1.72 1.72 0 00-2.57 1.07c-.42 1.76-2.92 1.76-3.35 0a1.72 1.72 0 00-2.57-1.07c-1.54.94-3.3-.83-2.37-2.37a1.72 1.72 0 00-1.07-2.57c-1.76-.42-1.76-2.92 0-3.35a1.72 1.72 0 001.07-2.57c-.94-1.54.83-3.3 2.37-2.37.99.61 2.3.07 2.57-1.07z"></path></svg>
          Paramètres
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main -->
  <main class="admin-main">
    <!-- Dashboard -->
    <section id="dashboard" class="admin-section active">
      <div class="admin-header">
        <h1 class="admin-page-title">Tableau de bord — Administration LIA</h1>
        <p class="admin-page-description">Pilotage des **programmes**, **inscriptions** et **droits d’accès**.</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Programmes actifs</span>
            <div class="stat-card-icon users">P</div>
          </div>
          <div class="stat-card-value">3</div>
          <div class="stat-card-change">
            <span class="access-indicator"><span class="access-dot full"></span>ACD • ACI • ACT</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Inscriptions en examen</span>
            <div class="stat-card-icon events">I</div>
          </div>
          <div class="stat-card-value">18</div>
          <div class="stat-card-change"><span class="access-indicator"><span class="access-dot limited"></span>+5 cette semaine</span></div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Candidats actifs</span>
            <div class="stat-card-icon candidates">C</div>
          </div>
          <div class="stat-card-value">1247</div>
          <div class="stat-card-change">+12% ce mois</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Invitations en attente</span>
            <div class="stat-card-icon active">✉</div>
          </div>
          <div class="stat-card-value">23</div>
          <div class="stat-card-change negative"><span class="access-indicator"><span class="access-dot limited"></span>5 expirent bientôt</span></div>
        </div>
      </div>

      <!-- Utilisateurs récents -->
      <div class="users-section">
        <div class="users-section-header">
          <h2 class="users-section-title">Utilisateurs récents</h2>
          <button class="add-user-btn" onclick="showAddUserModal()">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
            Ajouter un utilisateur
          </button>
        </div>
        <table class="users-table">
          <thead><tr><th>Utilisateur</th><th>Rôle</th><th>Statut</th><th>Dernière connexion</th><th>Actions</th></tr></thead>
          <tbody>
            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:12px;">
                  <div class="user-avatar">DT</div>
                  <div class="user-info">
                    <div class="user-name">Directeur Technique</div>
                    <div class="user-email">dt@lia.app</div>
                  </div>
                </div>
              </td>
              <td><span class="user-role admin">Directeur Technique</span></td>
              <td><div class="user-status"><div class="status-dot active" style="background:var(--success-color)"></div><span>Actif</span></div></td>
              <td>Il y a 2 h</td>
              <td><div class="user-actions"><button class="action-btn edit">Modifier</button><button class="action-btn delete">Supprimer</button></div></td>
            </tr>
            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:12px;">
                  <div class="user-avatar">RP</div>
                  <div class="user-info">
                    <div class="user-name">Resp. Programme ACD</div>
                    <div class="user-email">rp.acd@lia.app</div>
                  </div>
                </div>
              </td>
              <td><span class="user-role coach">Responsable Programme</span></td>
              <td><div class="user-status"><div class="status-dot active" style="background:var(--success-color)"></div><span>Actif</span></div></td>
              <td>Hier</td>
              <td><div class="user-actions"><button class="action-btn edit">Modifier</button><button class="action-btn delete">Supprimer</button></div></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Structure LIA -->
    <section id="lia-structure" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Structure LIA</h1>
        <p class="admin-page-description">Hiérarchie : **Structure** → **Programme** → **Promotion** → **Groupe**</p>
      </div>

      <div class="org-hierarchy">
        <div class="hierarchy-node node-level-0">
          <div class="node-icon root">S</div>
          <div><strong>Structure (Organisation LIA)</strong><div class="access-indicator"><span class="access-dot full"></span>Portée globale</div></div>
          <span class="role-badge dt">DIRECTEUR_TECHNIQUE</span>
        </div>

        <div class="hierarchy-node node-level-1">
          <div class="node-icon program" style="color:var(--noir)">A</div>
          <div><strong>Programme ACD</strong><div class="access-indicator"><span class="access-dot full"></span>Responsable : RP-ACD</div></div>
          <span class="role-badge rp">RESPONSABLE_PROGRAMME</span>
        </div>

        <div class="hierarchy-node node-level-2">
          <div class="node-icon promo">P</div>
          <div><strong>Promotion ACD-2025</strong><div class="access-indicator"><span class="access-dot full"></span>Capacité 30</div></div>
          <span class="role-badge rs">RESPONSABLE_STRUCTURE</span>
        </div>

        <div class="hierarchy-node node-level-3">
          <div class="node-icon groupe">G</div>
          <div><strong>Groupe ACD-G1</strong><div class="access-indicator"><span class="access-dot limited"></span>12 candidats • 3 coachs</div></div>
          <span class="role-badge cons">CONSEILLER</span>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
        <a class="btn btn-primaire" href="/programmes/ui">Gérer les programmes</a>
        <a class="btn btn-outline-dark" href="/pipeline/ui">Configurer le pipeline</a>
      </div>
    </section>

    <!-- Permissions RBAC (LIA) -->
    <section id="permissions" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Matrice des Permissions LIA</h1>
        <p class="admin-page-description">Contrôle d’accès par rôle — conforme à tes règles métier.</p>
      </div>

      <div class="permission-matrix">
        <div class="permission-row header">
          <span>Action</span>
          <span>Directeur<br>Technique</span>
          <span>Resp.<br>Structure</span>
          <span>Resp.<br>Programme</span>
          <span>Conseiller</span>
          <span>Jury<br>externe</span>
        </div>

        <div class="permission-row">
          <span>Créer / attribuer un programme</span>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
        </div>

        <div class="permission-row">
          <span>Valider une inscription (après jury)</span>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator limited">•</div>
        </div>

        <div class="permission-row">
          <span>Compléter/éditer le dossier d’un candidat</span>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
        </div>

        <div class="permission-row">
          <span>Délibérer en jury</span>
          <div class="permission-indicator limited">•</div>
          <div class="permission-indicator limited">•</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator allowed">✓</div>
        </div>

        <div class="permission-row">
          <span>Configurer pipeline du programme</span>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
        </div>

        <div class="permission-row">
          <span>Gérer promotions & groupes</span>
          <div class="permission-indicator limited">•</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator limited">•</div>
          <div class="permission-indicator denied">✗</div>
        </div>

        <div class="permission-row">
          <span>Inviter coach/jury externe</span>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
        </div>

        <div class="permission-row">
          <span>Gérer utilisateurs internes</span>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator allowed">✓</div>
          <div class="permission-indicator limited">•</div>
          <div class="permission-indicator denied">✗</div>
          <div class="permission-indicator denied">✗</div>
        </div>
      </div>
    </section>

    <!-- Invitations -->
    <section id="invitations" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Invitations</h1>
        <p class="admin-page-description">Inviter des **conseillers**, **coachs** et **jurys externes**.</p>
      </div>

      <div class="invite-panel">
        <h3 style="margin-bottom:16px;color:var(--gray-900);">Nouvelle invitation</h3>
        <div class="invite-form" style="display:grid;grid-template-columns:1fr 1fr auto;gap:16px;align-items:end;">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" placeholder="utilisateur@lia.app" id="invite-email">
          </div>
          <div class="form-group">
            <label class="form-label">Rôle</label>
            <select class="form-select" id="invite-role">
              <option value="RESPONSABLE_PROGRAMME">Responsable Programme</option>
              <option value="CONSEILLER" selected>Conseiller</option>
              <option value="COACH_EXTERNE">Coach externe</option>
              <option value="JURY_EXTERNE">Jury externe</option>
            </select>
          </div>
          <button class="btn btn-primaire" onclick="sendInvitation()">Envoyer</button>
        </div>
      </div>

      <div class="users-section">
        <div class="users-section-header">
          <h2 class="users-section-title">Invitations en cours</h2>
        </div>
        <table class="users-table">
          <thead><tr><th>Email</th><th>Rôle demandé</th><th>Programme</th><th>Envoyée le</th><th>Expire le</th><th>Actions</th></tr></thead>
          <tbody>
            <tr>
              <td>coach.ext@lia.app</td>
              <td><span class="role-badge jury">JURY_EXTERNE</span></td>
              <td>Programme ACT</td><td>Il y a 2 jours</td><td>Dans 5 jours</td>
              <td><div class="user-actions"><button class="action-btn edit">Relancer</button><button class="action-btn delete">Annuler</button></div></td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Journal d'audit -->
    <section id="audit" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Journal d'Audit</h1>
        <p class="admin-page-description">Traçabilité complète des actions sensibles (création programme, décisions jury, etc.).</p>
      </div>

      <div class="audit-log">
        <div class="audit-entry">
          <div class="audit-timestamp">14:32<br>Aujourd'hui</div>
          <div class="audit-action"><strong>Programme créé</strong><br>ACD attribué à RP-ACD</div>
          <div class="audit-actor"><span class="role-badge dt">DIRECTEUR_TECHNIQUE</span></div>
        </div>
        <div class="audit-entry">
          <div class="audit-timestamp">11:15<br>Aujourd'hui</div>
          <div class="audit-action"><strong>Décision de jury</strong><br>Candidat #102 validé</div>
          <div class="audit-actor"><span class="role-badge jury">JURY_EXTERNE</span></div>
        </div>
      </div>
    </section>

    <!-- Thèmes -->
    <section id="org-themes" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Thème LIA</h1>
        <p class="admin-page-description">Jaune/noir/blanc — possibilité de dériver au niveau programme.</p>
      </div>

      <div class="invite-panel">
        <h3 style="margin-bottom:24px;color:var(--gray-900);">Personnalisation rapide</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
          <div class="form-group">
            <label class="form-label">Couleur principale</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="color" value="#ffd300" id="primary-color" style="width:40px;height:40px;border:none;border-radius:8px;">
              <input type="text" class="form-input" value="#ffd300" style="flex:1;" readonly>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Couleur d’accent</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="color" value="#111111" id="accent-color" style="width:40px;height:40px;border:none;border-radius:8px;">
              <input type="text" class="form-input" value="#111111" style="flex:1;" readonly>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:flex-end;">
          <button class="btn btn-outline-dark" onclick="resetTheme()">Réinitialiser</button>
          <button class="btn btn-outline-dark" onclick="previewTheme()">Aperçu</button>
          <button class="btn btn-primaire" onclick="saveOrgTheme()">Enregistrer</button>
        </div>
      </div>
    </section>

    <!-- Paramètres -->
    <section id="settings" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Paramètres</h1>
        <p class="admin-page-description">Raccourcis vers la configuration : Programmes, Pipeline, Promotions/Groupes.</p>
      </div>
      <div class="org-hierarchy">
        <div class="hierarchy-node"><a class="btn btn-outline-dark" href="/programmes/ui">Programmes</a></div>
        <div class="hierarchy-node"><a class="btn btn-outline-dark" href="/pipeline/ui">Pipeline</a></div>
        <div class="hierarchy-node"><a class="btn btn-outline-dark" href="/inscriptions/ui">Inscriptions</a></div>
      </div>
    </section>

    <!-- Utilisateurs & Rôles -->
    <section id="users" class="admin-section" style="display:none;">
      <div class="admin-header">
        <h1 class="admin-page-title">Utilisateurs & Rôles</h1>
        <p class="admin-page-description">Gestion centralisée des accès LIA.</p>
      </div>
      <div class="users-section">
        <div class="users-section-header">
          <h2 class="users-section-title">Comptes</h2>
          <button class="add-user-btn" onclick="showAddUserModal()">Ajouter un utilisateur</button>
        </div>
        <table class="users-table">
          <thead><tr><th>Utilisateur</th><th>Rôle</th><th>Statut</th><th>Dernière connexion</th><th>Actions</th></tr></thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>
                <div style="display:flex;align-items:center;gap:12px;">
                  <div class="user-avatar">{{ user.nom_complet[:2].upper() }}</div>
                  <div class="user-info">
                    <div class="user-name">{{ user.nom_complet }}</div>
                    <div class="user-email">{{ user.email }}</div>
                  </div>
                </div>
              </td>
              <td>
                <span class="user-role 
                  {% if user.role in ['DIRECTEUR_TECHNIQUE', 'ADMINISTRATEUR'] %}admin
                  {% elif user.role in ['RESPONSABLE_PROGRAMME', 'COACH_EXTERNE'] %}coach
                  {% else %}user{% endif %}">
                  {% if user.role == 'DIRECTEUR_TECHNIQUE' %}Directeur Technique
                  {% elif user.role == 'RESPONSABLE_STRUCTURE' %}Resp. Structure
                  {% elif user.role == 'RESPONSABLE_PROGRAMME' %}Resp. Programme
                  {% elif user.role == 'CONSEILLER' %}Conseiller
                  {% elif user.role == 'ADMINISTRATEUR' %}Administrateur
                  {% elif user.role == 'COACH_EXTERNE' %}Coach externe
                  {% elif user.role == 'JURY_EXTERNE' %}Jury externe
                  {% elif user.role == 'CANDIDAT' %}Candidat
                  {% else %}{{ user.role }}{% endif %}
                </span>
              </td>
              <td>
                <div class="user-status">
                  <div class="status-dot {% if user.actif %}active{% else %}inactive{% endif %}" 
                       style="background:{% if user.actif %}var(--success-color){% else %}var(--gray-400){% endif %}">
                  </div>
                  <span>{% if user.actif %}Actif{% else %}Inactif{% endif %}</span>
                </div>
              </td>
              <td>{{ user.derniere_connexion or 'Jamais' }}</td>
              <td>
                <div class="user-actions">
                  <button class="action-btn edit" onclick="showEditUserModal({{ user.id }})">Modifier</button>
                  <button class="action-btn delete" onclick="showDeleteUserModal({{ user.id }})">Supprimer</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Navigation
    const navItems = document.querySelectorAll('.admin-nav-item');
    const sections = document.querySelectorAll('.admin-section');
    navItems.forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        navItems.forEach(n => n.classList.remove('active'));
        sections.forEach(s => { s.classList.remove('active'); s.style.display='none'; });
        this.classList.add('active');
        const id = this.getAttribute('data-section');
        const target = document.getElementById(id);
        if(target){ target.classList.add('active'); target.style.display='block'; }
      });
    });

    // Actions (demo)
    document.querySelectorAll('.action-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        const action = this.textContent.trim().toLowerCase();
        const row = this.closest('tr'); const name = row?.querySelector('.user-name')?.textContent || 'utilisateur';
        if(action==='modifier') alert('Modifier : '+name);
        if(action==='supprimer' && confirm('Supprimer '+name+' ?')) row.remove();
        if(action==='relancer') alert('Invitation relancée');
        if(action==='annuler' && confirm('Annuler cette invitation ?')) row.remove();
      });
    });
  });

  // Invitations (demo)
  function sendInvitation(){
    const email = document.getElementById('invite-email').value;
    const role = document.getElementById('invite-role').value;
    if(!email || !email.includes('@')){ alert('Email invalide'); return; }
    alert('Invitation envoyée à '+email+' pour le rôle '+role);
    document.getElementById('invite-email').value='';
  }

  // Thème (demo)
  function resetTheme(){
    if(confirm('Réinitialiser le thème ?')){ document.getElementById('primary-color').value='#ffd300'; document.getElementById('accent-color').value='#111111'; alert('Thème réinitialisé'); }
  }
  function previewTheme(){
    const p=document.getElementById('primary-color').value, a=document.getElementById('accent-color').value;
    alert('Aperçu\nPrincipale: '+p+'\nAccent: '+a);
  }
  function saveOrgTheme(){
    alert('Thème enregistré (démo).');
  }

  // ========================================
  // GESTION DES UTILISATEURS - FORMULAIRE SIMPLE
  // ========================================

  // Afficher la modale d'ajout d'utilisateur
  function showAddUserModal() {
    document.getElementById('addUserModal').style.display = 'flex';
    document.getElementById('addUserForm').reset();
  }

  // Fermer toutes les modales
  function closeModals() {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.style.display = 'none';
    });
  }
</script>

<!-- Modales pour la gestion des utilisateurs -->

<!-- Modale d'ajout d'utilisateur -->
<div id="addUserModal" class="modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Ajouter un utilisateur</h3>
      <button class="modal-close" onclick="closeModals()">&times;</button>
    </div>
    <form id="addUserForm" class="modal-form" method="POST" action="/auth/users">
      <div class="form-group">
        <label for="nom-complet">Nom complet *</label>
        <input type="text" id="nom-complet" name="nom_complet" required>
      </div>
      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="form-group">
        <label for="telephone">Téléphone</label>
        <input type="tel" id="telephone" name="telephone">
      </div>
      <div class="form-group">
        <label for="role">Rôle *</label>
        <select id="role" name="role" required>
          <option value="">Sélectionner un rôle</option>
          {% for role in user_roles %}
          <option value="{{ role.value }}">{{ role.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="type-utilisateur">Type d'utilisateur *</label>
        <select id="type-utilisateur" name="type_utilisateur" required>
         
          <option value="INTERNE">Interne</option>
          <option value="EXTERNE">Externe</option>
          
        </select>
      </div>
      <div class="form-group">
        <label for="mot-de-passe">Mot de passe *</label>
        <input type="password" id="mot-de-passe" name="mot_de_passe" required minlength="8">
        <small>Minimum 8 caractères</small>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline-dark" onclick="closeModals()">Annuler</button>
        <button type="submit" class="btn btn-primaire">Ajouter</button>
      </div>
    </form>
  </div>
</div>

<!-- Styles pour les modales -->
<style>
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  .modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 24px 0 24px;
    border-bottom: 1px solid var(--gray-200);
    margin-bottom: 24px;
  }

  .modal-header h3 {
    margin: 0;
    color: var(--gray-900);
    font-size: 20px;
    font-weight: 600;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--gray-500);
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s ease;
  }

  .modal-close:hover {
    background-color: var(--gray-100);
    color: var(--gray-700);
  }

  .modal-form {
    padding: 0 24px 24px 24px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--gray-700);
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(255, 211, 0, 0.1);
  }

  .form-group small {
    display: block;
    margin-top: 4px;
    font-size: 12px;
    color: var(--gray-500);
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--gray-200);
  }

  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }

  .btn-primaire {
    background: var(--primary-color);
    color: var(--noir);
  }

  .btn-primaire:hover {
    filter: brightness(0.95);
  }

  .btn-outline-dark {
    background: transparent;
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
  }

  .btn-outline-dark:hover {
    background: var(--gray-50);
  }

  .user-actions {
    display: flex;
    gap: 8px;
  }

  .action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s ease;
  }

  .action-btn.edit {
    background: var(--primary-color);
    color: var(--noir);
  }

  .action-btn.edit:hover {
    filter: brightness(0.95);
  }

  .action-btn.delete {
    background: var(--error-color);
    color: white;
  }

  .action-btn.delete:hover {
    filter: brightness(0.9);
  }

  .user-status {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-dot.active {
    background: var(--success-color);
  }

  .status-dot.inactive {
    background: var(--gray-400);
  }
</style>
{% endblock %}
